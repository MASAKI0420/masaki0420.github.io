<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Webゲームランチャー</title>
    <!-- PWAのテーマカラー -->
    <meta name="theme-color" content="#000000">
    <!-- 動的に生成するManifestへのリンク -->
    <link rel="manifest" id="manifest-link">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #000000;
            color: white;
            overflow: hidden; /* ページ全体のスクロールを禁止 */
        }

        /* --- ランチャー画面のスタイル --- */
        #launcher-screen {
            position: fixed;
            width: 100vw;
            height: 100vh;
            top: 0;
            left: 0;
            transform: none;
            background-color: #121212;
            z-index: 20000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #launcher-content {
            width: 100%;
            height: 100vh; /* 高さを画面全体に設定 */
            max-width: 1200px;
            display: flex;
            flex-direction: column; /* 要素を縦に並べる */
            align-items: center;
            padding: 3vh 30px; /* 上下のパディングを画面の高さに合わせる */
            box-sizing: border-box;
        }
        
        #launcher-title {
            font-size: clamp(1.8em, 5vh, 2.5em); /* 画面高さに応じてフォントサイズを調整 */
            margin-bottom: 3vh; /* 下マージンを画面の高さに合わせる */
            color: #ffffff;
            flex-shrink: 0; /* タイトルが縮まないようにする */
        }
        
        #game-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(15px, 2vh, 25px); /* タイル間の隙間を画面サイズに追従させる */
            width: 100%;
            flex-grow: 1; /* 残りの垂直スペースをすべて埋める */
            overflow-y: auto; /* ゲームが多い場合はこのエリア内だけスクロール */
            padding-right: 10px; /* スクロールバー用の余白 */
        }

        .game-tile {
            background-color: #2a2a2a;
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.1em; /* フォントサイズを少し調整 */
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px; /* タイルの最小高さを少し小さく */
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .game-tile:hover {
            transform: translateY(-5px);
            background-color: #3c3c3c;
        }

        /* --- ゲーム表示コンテナ --- */
        #game-container {
            display: none;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .search-area {
            display: none;
        }
        .result-area {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #results-frame {
            width: 100%;
            max-width: none;
            height: 100%;
            border: none;
            border-radius: 0;
            background-color: #ffffff;
            transition: all 0.3s ease;
        }

        /* --- ボタン共通スタイル --- */
        .action-button {
            display: none;
            position: fixed;
            bottom: 20px;
            z-index: 10000;
            padding: 10px 15px;
            font-size: 16px;
            color: white;
            background-color: rgba(0, 123, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        #fullscreen-button {
            right: 20px;
            background-color: rgba(23, 162, 184, 0.9);
        }
        #back-to-launcher-button {
            left: 1px;
            background-color: rgba(108, 117, 125, 0.9);
        }
        #install-button {
            right: 270px;
            background-color: rgba(40, 167, 69, 0.9);
            padding-left: -40px;
        }
        #install-button::before {
            content: '↓';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
        }

        /* --- フルスクリーンモードのスタイル --- */
        body.fullscreen-mode .result-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background-color: #000;
        }
        body.fullscreen-mode #results-frame {
            max-width: none;
            border-radius: 0;
            border: none;
        }
        body.fullscreen-mode .action-button {
            display: none !important;
        }
        body.fullscreen-mode #back-to-launcher-button.show-in-fullscreen {
            display: block !important;
            z-index: 10001;
        }
        body.fullscreen-mode {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        body.fullscreen-mode .result-area {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
    </style>
</head>
<body class="">
    <div id="launcher-screen">
        <div id="launcher-content">
            <h1 id="launcher-title">ゲームを選択</h1>
            <div id="game-list">
            </div>
        </div>
    </div>

    <div id="game-container">
        <div class="container">
            <div class="search-area"></div>
            <div class="result-area">
                <iframe id="results-frame" name="results-frame" src="about:blank" sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-forms"></iframe>
            </div>
        </div>
        <button id="install-button" class="action-button">アプリをインストール</button>
        <button id="back-to-launcher-button" class="action-button">←</button>
    </div>

    <button id="fullscreen-button" class="action-button">16:9フルスクリーン</button>

    <script>
    const games = [
        { title: "太鼓ウェブ", url: "https://cjdgrevival.com/", orientation: 'landscape-primary' },
        { title: "OSU!taikoスマホ版", url: "https://masaki0420.github.io/", orientation: 'landscape-primary' },
        { title: "太鼓ウェブ創作譜面", url: "https://taikosim.click/", orientation: 'landscape-primary' },
        { title: "太鼓ウェブ本家 2", url: "https://ouo.269seahorse.me/", orientation: 'landscape-primary' },
        { title: "俺の甲子園", url: "https://orekou.net/", orientation: 'landscape-primary' },
    ];

    const launcherScreen = document.getElementById('launcher-screen');
    const gameContainer = document.getElementById('game-container');
    const gameList = document.getElementById('game-list');
    const resultsFrame = document.getElementById('results-frame');
    const backToLauncherBtn = document.getElementById('back-to-launcher-button');
    const installBtn = document.getElementById('install-button');
    const fullscreenBtn = document.getElementById('fullscreen-button');
    const body = document.body;
    const resultArea = document.querySelector('.result-area');

    // ▼▼▼▼▼ 変更点：アプリ全体で横画面を強制する関数を再定義 ▼▼▼▼▼
    function forceLandscape() {
        if (screen.orientation && typeof screen.orientation.lock === 'function') {
            if (!screen.orientation.type.startsWith('landscape')) {
                screen.orientation.lock('landscape-primary').catch(err => {
                    console.warn("横画面への強制固定に失敗:", err.message);
                });
            }
        }
    }
    // ▲▲▲▲▲ ここまで ▲▲▲▲▲

    function focusIframe() {
        try {
            resultsFrame.contentWindow.focus();
        } catch (e) {
            console.warn("iframeへのフォーカスに失敗しました:", e.message);
        }
    }

    // ▼▼▼▼▼ 変更点：半回転を防ぐため、先に画面をロックしてからフルスクリーンに移行する処理を再実装 ▼▼▼▼▼
    async function enterFullscreen() {
        try {
            // 1. 確実に横画面にロックする
            await screen.orientation.lock('landscape-primary');
            // 2. その後でフルスクリーンを要求する
            await document.documentElement.requestFullscreen();
        } catch (err) {
            alert(`フルスクリーンにできませんでした: ${err.message}`);
        }
    }
    // ▲▲▲▲▲ ここまで ▲▲▲▲▲

    function updateView(state) {
        // ▼▼▼▼▼ 変更点：どの画面でも、ビューが更新されるたびに横画面を強制する ▼▼▼▼▼
        forceLandscape();
        // ▲▲▲▲▲ ここまで ▲▲▲▲▲

        const isGameView = state && state.view === 'game';
        
        if (isGameView) {
            launcherScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            backToLauncherBtn.style.display = 'block';
            fullscreenBtn.style.display = 'block';

            if (resultsFrame.src !== state.url) {
                resultsFrame.src = state.url;
            }
        } else {
            launcherScreen.style.display = 'flex';
            gameContainer.style.display = 'none';
            backToLauncherBtn.style.display = 'none';
            fullscreenBtn.style.display = 'none';

            requestAnimationFrame(() => {
                if (resultsFrame.src !== 'about:blank') {
                    resultsFrame.src = 'about:blank';
                }
            });
        }
    }

    function goToLauncher() {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        }
        
        const launcherState = { view: 'launcher' };
        history.replaceState(launcherState, '', window.location.pathname);
        updateView(launcherState);
    }

    games.forEach(game => {
        const tile = document.createElement('div');
        tile.className = 'game-tile';
        tile.textContent = game.title;
        tile.addEventListener('click', () => {
            const newState = {
                view: 'game',
                url: game.url
            };
            history.pushState(newState, '', '#game');
            updateView(newState); // これによりゲーム画面でも横画面が強制される
        });
        gameList.appendChild(tile);
    });

    const exitTile = document.createElement('div');
    exitTile.className = 'game-tile';
    exitTile.textContent = 'アプリを終了';
    exitTile.style.backgroundColor = '#dc3545';
    exitTile.style.borderColor = '#c82333';
    exitTile.addEventListener('click', () => {
        window.close();
    });
    gameList.appendChild(exitTile);

    backToLauncherBtn.addEventListener('click', goToLauncher);
    fullscreenBtn.onclick = enterFullscreen;

    window.addEventListener('popstate', (event) => {
        goToLauncher();
    });

    document.addEventListener('DOMContentLoaded', () => {
        history.replaceState({ view: 'launcher' }, '', window.location.pathname);
        updateView(history.state);
        
        // ▼▼▼▼▼ 変更点：物理的な画面回転に即座に反応して横画面に戻すリスナーを再設定 ▼▼▼▼▼
        if (screen.orientation) {
            screen.orientation.addEventListener('change', forceLandscape);
        }
        // ▲▲▲▲▲ ここまで ▲▲▲▲▲
    });

    function createIconBase64(size) {
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, size, size);
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = size * 0.08;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        const centerX = size / 2;
        const arrowTopY = size * 0.25;
        const arrowBottomY = size * 0.65;
        const arrowWidth = size * 0.2;
        ctx.beginPath();
        ctx.moveTo(centerX, arrowTopY);
        ctx.lineTo(centerX, arrowBottomY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(centerX - arrowWidth, arrowBottomY - arrowWidth);
        ctx.lineTo(centerX, arrowBottomY);
        ctx.lineTo(centerX + arrowWidth, arrowBottomY - arrowWidth);
        ctx.stroke();
        return canvas.toDataURL('image/png');
    }
    
    const manifest = {
      "short_name": "Webゲーム",
      "name": "Webゲームランチャー",
      "start_url": ".",
      "display": "fullscreen", 
      "orientation": "landscape-primary",
      "background_color": "#000000",
      "theme_color": "#000000",
      "icons": [ { "src": createIconBase64(512), "type": "image/png", "sizes": "512x512" } ]
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.querySelector('#manifest-link').setAttribute('href', manifestURL);

    const serviceWorkerCode = `
        const CACHE_NAME = 'web-game-launcher-cache-v1';
        const urlsToCache = ['./'];
        self.addEventListener('install', e => { e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache))); self.skipWaiting(); });
        self.addEventListener('fetch', e => { e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))); });
        self.addEventListener('activate', e => {
            const cacheWhitelist = [CACHE_NAME];
            e.waitUntil(caches.keys().then(names => Promise.all(names.map(name => {
                if (cacheWhitelist.indexOf(name) === -1) return caches.delete(name);
            }))));
            return self.clients.claim();
        });
    `;
    const swBlob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
    const swURL = URL.createObjectURL(swBlob);

    function resizeIframeForFullscreen() {
        if (document.fullscreenElement) {
            const aspectRatio = 16 / 9;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            if (screenWidth / screenHeight > aspectRatio) {
                resultsFrame.style.height = screenHeight + 'px';
                resultsFrame.style.width = (screenHeight * aspectRatio) + 'px';
            } else {
                resultsFrame.style.width = screenWidth + 'px';
                resultsFrame.style.height = (screenWidth / aspectRatio) + 'px';
            }
        } else {
            resultsFrame.style.width = '';
            resultsFrame.style.height = '';
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    const debouncedResize = debounce(resizeIframeForFullscreen, 50);

    document.addEventListener('fullscreenchange', () => {
        const isFullscreen = !!document.fullscreenElement;
        body.classList.toggle('fullscreen-mode', isFullscreen);
        resizeIframeForFullscreen();

        if (isFullscreen) {
            backToLauncherBtn.classList.add('show-in-fullscreen');
            setTimeout(focusIframe, 300);
        } else {
            backToLauncherBtn.classList.remove('show-in-fullscreen');
            forceLandscape();
        }
    });

    window.addEventListener('resize', debouncedResize);

    resultArea.addEventListener('click', () => {
        if (body.classList.contains('fullscreen-mode')) {
            focusIframe();
        }
    });

    resultArea.addEventListener('contextmenu', (e) => {
        if (body.classList.contains('fullscreen-mode')) { e.preventDefault(); }
    });
    const preventTouchDefault = (e) => {
        if (body.classList.contains('fullscreen-mode')) { e.preventDefault(); }
    };
    resultArea.addEventListener('touchstart', preventTouchDefault, { passive: false });
    resultArea.addEventListener('touchmove', preventTouchDefault, { passive: false });
    resultArea.addEventListener('touchend', preventTouchDefault, { passive: false });
    resultArea.addEventListener('touchcancel', preventTouchDefault, { passive: false });
    
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
        installBtn.style.display = 'none';
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(swURL).catch(err => { console.log('ServiceWorker登録失敗', err); });
        });
    }

    window.addEventListener('appinstalled', () => {
        installBtn.style.display = 'none';
        deferredPrompt = null;
    });

    </script>
</body>
</html>
