<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç”»é¢ã‚ºãƒ¼ãƒ ã‚«ãƒ¡ãƒ©ï¼ˆå‹•ç”»ï¼†ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ä»˜ï¼‰</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: sans-serif;
            touch-action: none;
        }

        #camera-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* ãƒ©ã‚¤ãƒ–æ˜ åƒ */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform-origin: center;
            transition: transform 0.1s linear;
        }

        /* æ’®å½±çµæœï¼ˆå†™çœŸï¼‰ */
        img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã¯å…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«å¤‰æ›´ */
            display: block;
            background: #000;
        }

        /* æ’®å½±çµæœï¼ˆå‹•ç”»ï¼‰ */
        #recorded-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            background: #000;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        #photo {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        /* UIã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* ã‚ºãƒ¼ãƒ å€ç‡è¡¨ç¤º */
        #zoom-indicator {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* éŒ²ç”»æ™‚é–“è¡¨ç¤º */
        #video-timer {
            position: absolute;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            color: red;
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            display: none;
        }

        #errorMsg {
            color: white;
            background: rgba(255, 0, 0, 0.5);
            text-align: center;
            padding: 10px;
            display: none;
            pointer-events: auto;
        }

        .top-bar {
            padding: 20px;
            display: flex;
            justify-content: space-between; /* ä¸¡ç«¯é…ç½®ã«å¤‰æ›´ */
            align-items: flex-start;
        }

        .bottom-container {
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¹ã‚¤ãƒƒãƒ */
        .mode-switch {
            pointer-events: auto;
            display: flex;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            padding: 5px;
            margin-bottom: 15px;
        }
        .mode-btn {
            padding: 5px 15px;
            border-radius: 15px;
            color: #aaa;
            font-size: 0.8rem;
            background: transparent;
            box-shadow: none;
        }
        .mode-btn.active {
            background: white;
            color: #000;
        }

        .bottom-bar {
            width: 100%;
            padding: 0 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            box-sizing: border-box;
        }

        button {
            pointer-events: auto;
            cursor: pointer;
            border: none;
            outline: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.9); }

        .icon-btn {
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            min-width: 40px;
        }
        
        #flashBtn {
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼ˆã‚µãƒãƒ¼ãƒˆç¢ºèªå¾Œè¡¨ç¤ºï¼‰ */
        }
        #flashBtn.active {
            background-color: #ffd700; /* ã‚ªãƒ³æ™‚ã¯é»„è‰² */
            color: #000;
        }

        #shutterBtn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: white; /* Videoãƒ¢ãƒ¼ãƒ‰æ™‚ã¯èµ¤ã«ãªã‚‹ */
            border: 4px solid rgba(200, 200, 200, 0.5);
            position: relative;
            transition: background-color 0.3s, transform 0.1s;
        }
        /* å†™çœŸç”¨ã®ä¸­ãƒãƒ« */
        #shutterBtn::after {
            content: '';
            display: block;
            width: 60px;
            height: 60px;
            background-color: white; /* Videoãƒ¢ãƒ¼ãƒ‰æ™‚ã¯èµ¤ã«ãªã‚‹ */
            border-radius: 50%;
            border: 2px solid #333;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
        }

        /* å‹•ç”»ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
        body.video-mode #shutterBtn {
            background-color: rgba(255, 255, 255, 0.5);
            border-color: rgba(255, 0, 0, 0.3);
        }
        body.video-mode #shutterBtn::after {
            background-color: #ff3b30; /* èµ¤è‰² */
            border: none;
            width: 50px;
            height: 50px;
        }
        /* éŒ²ç”»ä¸­ã®ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆå››è§’ã«ãªã‚‹ï¼‰ */
        body.recording #shutterBtn::after {
            border-radius: 5px;
            width: 30px;
            height: 30px;
            transform: translate(-50%, -50%) scale(1);
        }

        .sub-btn {
            background-color: white;
            color: #333;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            display: none;
        }
        #downloadBtn { background-color: #2ed573; color: white; }
    </style>
</head>
<body class="photo-mode"> <!-- åˆæœŸã‚¯ãƒ©ã‚¹ -->

    <div id="camera-container">
        <!-- ãƒ©ã‚¤ãƒ–æ˜ åƒ -->
        <video id="video" autoplay playsinline muted></video>
        
        <!-- æ’®å½±ç”»åƒ -->
        <img id="photo" alt="photo">
        <!-- éŒ²ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <video id="recorded-video" playsinline controls></video>
        
        <!-- UIãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
        <div class="ui-layer">
            <div id="errorMsg"></div>
            <!-- ã‚ºãƒ¼ãƒ å€ç‡è¡¨ç¤º -->
            <div id="zoom-indicator">1.0x</div>
            <!-- éŒ²ç”»æ™‚é–“ -->
            <div id="video-timer">00:00</div>

            <div class="top-bar">
                <button id="flashBtn" class="icon-btn">âš¡ ã‚ªãƒ•</button>
                <button id="switchBtn" class="icon-btn">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
            </div>

            <div class="bottom-container">
                <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
                <div class="mode-switch" id="modeSwitch">
                    <button class="mode-btn active" data-mode="photo">å†™çœŸ</button>
                    <button class="mode-btn" data-mode="video">å‹•ç”»</button>
                </div>

                <div class="bottom-bar">
                    <button id="resetBtn" class="sub-btn">âœ– ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="shutterBtn"></button>
                    <button id="downloadBtn" class="sub-btn">â¬‡ ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const recordedVideo = document.getElementById('recorded-video');
        const errorMsg = document.getElementById('errorMsg');
        const zoomIndicator = document.getElementById('zoom-indicator');
        const videoTimer = document.getElementById('video-timer');
        const cameraContainer = document.getElementById('camera-container');
        
        const shutterBtn = document.getElementById('shutterBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const switchBtn = document.getElementById('switchBtn');
        const flashBtn = document.getElementById('flashBtn');
        const modeSwitch = document.getElementById('modeSwitch');
        const modeBtns = document.querySelectorAll('.mode-btn');

        let currentFacingMode = 'environment';
        let currentStream = null;
        let imageCapture = null; // é«˜åº¦ãªã‚«ãƒ¡ãƒ©æ“ä½œç”¨
        let trackCapabilities = {};

        // çŠ¶æ…‹ç®¡ç†
        let currentMode = 'photo'; // 'photo' or 'video'
        let isRecording = false;
        let isFlashOn = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStartTime = 0;
        let timerInterval = null;
        let recordedBlobUrl = null;

        // ã‚ºãƒ¼ãƒ é–¢é€£
        let currentZoom = 1.0;
        const minZoom = 1.0;
        const maxZoom = 3.0; 
        let initialPinchDistance = 0;
        let startZoomLevel = 1.0;

        // --- ã‚ºãƒ¼ãƒ å‡¦ç† ---
        function updateVideoTransform() {
            const scaleX = (currentFacingMode === 'user') ? -1 : 1;
            video.style.transform = `scale(${currentZoom * scaleX}, ${currentZoom})`;
            
            zoomIndicator.textContent = `${currentZoom.toFixed(1)}x`;
            zoomIndicator.style.opacity = '1';
            
            clearTimeout(window.zoomTimer);
            window.zoomTimer = setTimeout(() => {
                zoomIndicator.style.opacity = '0';
            }, 1000);
        }

        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        cameraContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                initialPinchDistance = getDistance(e.touches);
                startZoomLevel = currentZoom;
                e.preventDefault();
            }
        }, { passive: false });

        cameraContainer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                const currentDistance = getDistance(e.touches);
                if (initialPinchDistance > 0) {
                    const zoomChange = currentDistance / initialPinchDistance;
                    let newZoom = startZoomLevel * zoomChange;
                    newZoom = Math.max(minZoom, Math.min(newZoom, maxZoom));
                    currentZoom = newZoom;
                    updateVideoTransform();
                }
                e.preventDefault();
            }
        }, { passive: false });

        // --- ã‚«ãƒ¡ãƒ©èµ·å‹• ---
        async function startCamera() {
            // ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            // UIãƒªã‚»ãƒƒãƒˆ
            currentZoom = 1.0;
            updateVideoTransform();
            isFlashOn = false;
            updateFlashBtnUI();

            const constraints = {
                video: {
                    facingMode: currentFacingMode,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: true // å‹•ç”»ç”¨ã«éŸ³å£°ã‚‚å–å¾—
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                // ãƒŸãƒ¥ãƒ¼ãƒˆã«ã—ãªã„ã¨ãƒã‚¦ãƒªãƒ³ã‚°ã™ã‚‹ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰
                video.muted = true;
                errorMsg.style.display = 'none';

                // ãƒˆãƒ©ãƒƒã‚¯æ©Ÿèƒ½ã®ç¢ºèªï¼ˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç”¨ï¼‰
                const videoTrack = stream.getVideoTracks()[0];
                trackCapabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
                
                // torchï¼ˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ãŒä½¿ãˆã‚‹ã‹ç¢ºèª
                if (trackCapabilities.torch) {
                    flashBtn.style.display = 'block';
                } else {
                    flashBtn.style.display = 'none';
                }

            } catch (err) {
                console.error(err);
                errorMsg.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message;
                errorMsg.style.display = 'block';
            }
        }

        // --- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åˆ¶å¾¡ ---
        async function toggleFlash() {
            if (!currentStream) return;
            const videoTrack = currentStream.getVideoTracks()[0];
            
            isFlashOn = !isFlashOn;
            
            try {
                await videoTrack.applyConstraints({
                    advanced: [{ torch: isFlashOn }]
                });
                updateFlashBtnUI();
            } catch (err) {
                console.error("Flash error:", err);
                isFlashOn = !isFlashOn; // å¤±æ•—ã—ãŸã‚‰æˆ»ã™
            }
        }

        function updateFlashBtnUI() {
            if (isFlashOn) {
                flashBtn.classList.add('active');
                flashBtn.textContent = 'âš¡ ã‚ªãƒ³';
            } else {
                flashBtn.classList.remove('active');
                flashBtn.textContent = 'âš¡ ã‚ªãƒ•';
            }
        }

        flashBtn.addEventListener('click', toggleFlash);

        // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (isRecording) return; // éŒ²ç”»ä¸­ã¯åˆ‡ã‚Šæ›¿ãˆä¸å¯
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                
                // bodyã‚¯ãƒ©ã‚¹åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ç”¨ï¼‰
                if (currentMode === 'video') {
                    document.body.classList.remove('photo-mode');
                    document.body.classList.add('video-mode');
                } else {
                    document.body.classList.remove('video-mode');
                    document.body.classList.add('photo-mode');
                }
            });
        });

        // ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
        switchBtn.addEventListener('click', () => {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        });

        // --- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³å‡¦ç† ---
        shutterBtn.addEventListener('click', () => {
            if (currentMode === 'photo') {
                takePhoto();
            } else {
                toggleVideoRecording();
            }
        });

        // å†™çœŸæ’®å½±
        function takePhoto() {
            const vw = video.videoWidth;
            const vh = video.videoHeight;

            canvas.width = vw;
            canvas.height = vh;
            
            const ctx = canvas.getContext('2d');
            
            // ã‚ºãƒ¼ãƒ é©ç”¨ï¼ˆãƒˆãƒªãƒŸãƒ³ã‚°ï¼‰
            const sWidth = vw / currentZoom;
            const sHeight = vh / currentZoom;
            const sx = (vw - sWidth) / 2;
            const sy = (vh - sHeight) / 2;

            ctx.save();
            if (currentFacingMode === 'user') {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
            }
            ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            photo.src = canvas.toDataURL('image/png');
            
            showPreviewState(true); // ç”»åƒè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
        }

        // å‹•ç”»éŒ²ç”»é–‹å§‹ãƒ»åœæ­¢
        function toggleVideoRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            recordedChunks = [];
            // MIMEã‚¿ã‚¤ãƒ—ã®é¸æŠï¼ˆãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ï¼‰
            let options = { mimeType: 'video/webm;codecs=vp9' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options = { mimeType: 'video/webm' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                     options = { mimeType: 'video/mp4' }; // Safariãªã©
                }
            }

            try {
                mediaRecorder = new MediaRecorder(currentStream, options);
            } catch (e) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŒ²ç”»ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                return;
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'video/webm' });
                recordedBlobUrl = URL.createObjectURL(blob);
                recordedVideo.src = recordedBlobUrl;
                showPreviewState(false); // å‹•ç”»è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã¸
            };

            mediaRecorder.start();
            isRecording = true;
            document.body.classList.add('recording');
            
            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            recordingStartTime = Date.now();
            videoTimer.style.display = 'block';
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            
            // UIåˆ¶å¾¡
            switchBtn.style.display = 'none';
            flashBtn.style.display = 'none';
            modeSwitch.style.display = 'none';
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            document.body.classList.remove('recording');
            
            clearInterval(timerInterval);
            videoTimer.style.display = 'none';
        }

        function updateTimer() {
            const diff = Math.floor((Date.now() - recordingStartTime) / 1000);
            const m = String(Math.floor(diff / 60)).padStart(2, '0');
            const s = String(diff % 60).padStart(2, '0');
            videoTimer.textContent = `${m}:${s}`;
        }

        // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã®è¡¨ç¤ºåˆ¶å¾¡ ---
        function showPreviewState(isPhoto) {
            video.style.display = 'none'; // ãƒ©ã‚¤ãƒ–æ˜ åƒéš ã™
            
            if (isPhoto) {
                photo.style.display = 'block';
                recordedVideo.style.display = 'none';
            } else {
                photo.style.display = 'none';
                recordedVideo.style.display = 'block';
                // recordedVideo.play(); // è‡ªå‹•å†ç”Ÿã—ãŸã‘ã‚Œã°
            }

            shutterBtn.style.display = 'none';
            switchBtn.style.display = 'none';
            flashBtn.style.display = 'none';
            modeSwitch.style.display = 'none';
            zoomIndicator.style.display = 'none';

            resetBtn.style.display = 'block';
            downloadBtn.style.display = 'block';
        }

        // --- ãƒªã‚»ãƒƒãƒˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ ---
        resetBtn.addEventListener('click', () => {
            // UIãƒªã‚»ãƒƒãƒˆ
            photo.style.display = 'none';
            recordedVideo.style.display = 'none';
            recordedVideo.pause();
            if (recordedBlobUrl) {
                URL.revokeObjectURL(recordedBlobUrl);
                recordedBlobUrl = null;
            }

            video.style.display = 'block'; // ãƒ©ã‚¤ãƒ–æ˜ åƒå¾©å¸°
            
            shutterBtn.style.display = 'block';
            if (currentMode !== 'recording') {
                switchBtn.style.display = 'block';
                // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒœã‚¿ãƒ³ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚Œã°è¡¨ç¤º
                if (trackCapabilities.torch) flashBtn.style.display = 'block';
                modeSwitch.style.display = 'flex';
            }

            resetBtn.style.display = 'none';
            downloadBtn.style.display = 'none';
            zoomIndicator.style.display = 'block';
        });

        // --- ä¿å­˜ ---
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            const now = new Date();
            const timestamp = `${now.getFullYear()}${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;
            
            if (currentMode === 'photo') {
                link.download = `photo_${timestamp}.png`;
                link.href = photo.src;
            } else {
                // å‹•ç”»ã®æ‹¡å¼µå­æ±ºå®š
                let ext = 'webm';
                if (mediaRecorder && mediaRecorder.mimeType && mediaRecorder.mimeType.includes('mp4')) {
                    ext = 'mp4';
                }
                link.download = `video_${timestamp}.${ext}`;
                link.href = recordedVideo.src;
            }
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        startCamera();
    </script>
</body>
</html>
