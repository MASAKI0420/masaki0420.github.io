<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- ↓ PWAに必要な設定を追加 -->
    <meta name="theme-color" content="#1f2940"/>
    <link rel="manifest" href="manifest.json">
    <!-- ↑ PWAに必要な設定を追加 -->
    <title>Rhythm Game Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* --- Global and Game Selector Styles --- */
        html, body {
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: #0d0d1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            color: white;
        }

        .game-wrapper {
            width: 100%;
            height: 100%;
            display: none; /* Initially hidden */
        }
        
        #mania-wrapper #game-container.playing,
        #taiko-wrapper #taiko-game-container.playing {
            cursor: none;
        }

        #game-selector {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            text-align: center;
        }

        #game-selector h1 {
            font-size: 3em;
            font-weight: 600;
            color: #e0e5f0;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .game-select-button {
            padding: 20px 40px;
            font-size: 1.5em;
            font-weight: 500;
            color: white;
            border: 2px solid #4a5578;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #1f2940;
            min-width: 300px;
        }

        #select-mania:hover {
            background-color: #3d7eff;
            border-color: #3d7eff;
            box-shadow: 0 0 20px #3d7eff;
        }

        #select-taiko:hover {
            background-color: #d9534f;
            border-color: #d9534f;
            box-shadow: 0 0 20px #d9534f;
        }

        /* --- osu!mania Styles (Scoped) --- */
        #mania-wrapper {
            --num-lanes: 4;
            --note-height: 22px;
            --receptor-size: 70px;
            --judgment-line-pos: 15vh;
            --judgment-text-top: 65vh;
            --panel-bg: #1f2940;
            --panel-text: #e0e5f0;
            --panel-border: #4a5578;
            --accent-color: #3d7eff;
            --disabled-color: #555c6f;
            --background-brightness: 0.5;
            --combo-size-scale: 1.0;
            --combo-position-y: 45%;
            --lane-opacity: 0.5;
            --playfield-bg-opacity: 0.5;
            --lane-width-scale: 1.0;
        }
        #mania-wrapper #video-background {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            width: 110%;
            height: auto;
        }

        #taiko-wrapper #taiko-background-video {
            position: fixed;
            top: -7%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            width: 212%;
            height: auto;
        }

        #mania-wrapper #image-background, #taiko-wrapper #taiko-background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            object-fit: contain;
        }

        #mania-wrapper #video-background, #mania-wrapper #image-background {
            display: none;
            filter: brightness(var(--background-brightness));
        }
        #mania-wrapper #app-container { z-index: 2; position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        #mania-wrapper #controls-panel {
            width: 95%;
            max-width: 900px;
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            color: var(--panel-text);
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto auto auto;
            gap: 20px 25px;
            align-items: flex-start;
            transform: scale(0.75);
        }
        #mania-wrapper .panel-column { display: flex; flex-direction: column; gap: 20px; min-height: 350px; }
        #mania-wrapper #beatmap-library-selector { width: 100%; background-color: #2a344d; color: var(--panel-text); border: 1px solid var(--panel-border); border-radius: 6px; padding: 8px; height: 190px; }
        #mania-wrapper #beatmap-library-selector option { padding: 5px; }
        #mania-wrapper .library-buttons, #mania-wrapper .settings-buttons { display: flex; gap: 10px; }
        #mania-wrapper .library-buttons .control-button { flex-grow: 1; }
        #mania-wrapper #game-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; overflow: hidden; display: none; z-index: 10; }
        #mania-wrapper #playfield {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            width: 100%;
            max-width: calc(500px * var(--lane-width-scale));
            height: 100%;
            z-index: 10;
        }
        #mania-wrapper #playfield-background { position: absolute; width: 100%; height: 100%; background-color: #000; z-index: -1; display: none; opacity: var(--playfield-bg-opacity); }
        #mania-wrapper .grid-item-full { grid-column: 1 / -1; }
        #mania-wrapper #controls-panel h2 { grid-column: 1 / -1; text-align: center; margin: 0 0 10px 0; font-size: 1.8em; font-weight: 600; }
        #mania-wrapper #controls-panel label { font-size: 0.9em; font-weight: 500; color: #a0a8c0; margin-bottom: 8px; display: block; }
        #mania-wrapper #controls-panel p { grid-column: 1 / -1; font-size: 0.8em; color: #828aa1; text-align: center; margin: 0; }
        #mania-wrapper input[type="file"] { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        #mania-wrapper .control-button, #mania-wrapper .styled-select { width: 100%; padding: 12px; font-size: 1em; font-weight: 500; color: var(--panel-text); background-color: #394362; border: 1px solid var(--panel-border); border-radius: 8px; cursor: pointer; transition: background-color 0.2s; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e5f0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 1em top 50%; background-size: .65em auto; padding-right: 2.5em; }
        #mania-wrapper .control-button:hover, #mania-wrapper .styled-select:hover { background-color: #4a5578; }
        #mania-wrapper .control-button:disabled, #mania-wrapper .styled-select:disabled { background-color: var(--disabled-color); cursor: not-allowed; color: #8c92a3; }
        #mania-wrapper input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: #2a344d; border-radius: 3px; outline: none; cursor: pointer; }
        #mania-wrapper input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--accent-color); border-radius: 50%; cursor: pointer; }
        #mania-wrapper input[type="number"] { width: 100%; background-color: #2a344d; color: var(--panel-text); border: 1px solid var(--panel-border); border-radius: 6px; padding: 8px; text-align: center; font-size: 1em; box-sizing: border-box; }
        #mania-wrapper #key-config-inputs { display: flex; justify-content: space-between; gap: 5px; width: 100%; }
        #mania-wrapper .key-config-input { flex-grow: 1; height: 45px; background-color: #2a344d; border: 1px solid var(--panel-border); border-radius: 6px; color: var(--panel-text); font-size: 1.3em; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; user-select: none; }
        #mania-wrapper .key-config-input:hover { background-color: #394362; }
        #mania-wrapper .key-config-input:focus, #mania-wrapper .key-config-input.is-waiting { background-color: var(--accent-color); border-color: var(--accent-color); outline: none; color: white; }
        #mania-wrapper .checkbox-wrapper { display: flex; align-items: center; cursor: pointer; }
        #mania-wrapper input[type="checkbox"] { display: none; }
        #mania-wrapper .custom-checkbox { width: 20px; height: 20px; background-color: #2a344d; border: 1px solid var(--panel-border); border-radius: 4px; display: inline-block; position: relative; margin-right: 10px; transition: background-color 0.2s; }
        #mania-wrapper input[type="checkbox"]:checked + .custom-checkbox { background-color: var(--accent-color); }
        #mania-wrapper .custom-checkbox::after { content: ''; position: absolute; left: 6px; top: 2px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); display: none; }
        #mania-wrapper input[type="checkbox"]:checked + .custom-checkbox::after { display: block; }
        #mania-wrapper #start-button { grid-column: 1 / -1; padding: 15px; font-size: 1.2em; font-weight: 600; color: white; background-color: var(--accent-color); border: none; }
        #mania-wrapper #start-button:disabled { background-color: var(--disabled-color); }
        #mania-wrapper #song-info { grid-column: 1 / -1; min-height: 20px; text-align: center; }
        #mania-wrapper .offset-controls-container { display: flex; gap: 10px; }
        #mania-wrapper .offset-control { flex: 1; }
        #mania-wrapper #lanes-container { display: flex; height: 100%; }
        #mania-wrapper .lane { width: calc(100% / var(--num-lanes)); height: 100%; border-left: 1px solid rgba(255, 255, 255, 0.2); background-color: rgba(0,0,0, var(--lane-opacity)); position: relative; box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        #mania-wrapper .lane:last-child { border-right: 1px solid rgba(255, 255, 255, 0.2); }
        #mania-wrapper #judgment-line { position: absolute; bottom: var(--judgment-line-pos); left: 0; width: 100%; height: 2px; background-color: rgba(255,255,255,0.8); box-shadow: 0 0 10px white; z-index: 15; }
        #mania-wrapper .note-wrapper { position: absolute; left: 0; width: 100%; top: 0; will-change: transform; pointer-events: none; display: flex; justify-content: center; }
        #mania-wrapper .note-wrapper.hidden { display: none; }
        #mania-wrapper .note-wrapper:has(.long-note-body) .note { position: relative; z-index: 2; }
        #mania-wrapper .long-note-body { width: 90%; background: #a13d53; border-radius: 4px 4px 0 0; position: absolute; z-index: 1; transform: translateY(calc(var(--note-height) / 2)); padding-bottom: calc(var(--note-height) / 2); box-sizing: content-box; }
        #mania-wrapper #playfield.note-style-circle .note-wrapper:has(.long-note-body) .note { width: var(--receptor-size); height: var(--receptor-size); border-radius: 50%; background: #a0d8ef; border: 2px solid rgba(255,255,255,0.7); box-sizing: border-box; box-shadow: none; aspect-ratio: 1/1; }
        #mania-wrapper #playfield.note-style-circle .long-note-body { width: var(--receptor-size); background: #5c8a9f; border-radius: calc(var(--receptor-size) / 2) calc(var(--receptor-size) / 2) 0 0; transform: none; padding-bottom: 0; box-sizing: border-box; }
        #mania-wrapper .note { width: 90%; margin: auto; height: var(--note-height); background: linear-gradient(90deg, #FF4D6D, #FF8FA3); border-radius: 4px; position: absolute; top: 0; box-shadow: 0 0 12px #FF4D6D; }
        #mania-wrapper #playfield.note-style-circle .note { width: var(--receptor-size); height: var(--receptor-size); border-radius: 50%; background: #a0d8ef; border: 2px solid white; box-sizing: border-box; box-shadow: none; aspect-ratio: 1/1; }
        #mania-wrapper #playfield.note-style-circle #playfield-background { display: block; }
        #mania-wrapper #playfield.note-style-circle .lane { background-color: transparent; border-left: none; border-right: 1px solid rgba(255, 255, 255, 0.25); }
        #mania-wrapper #playfield.note-style-circle .lane:first-child { border-left: 1px solid rgba(255, 255, 255, 0.25); }
        #mania-wrapper #playfield.note-style-circle #judgment-line { display: none; }
        #mania-wrapper #playfield.note-style-circle #key-indicators { bottom: var(--judgment-line-pos); transform: translateY(50%); height: auto; z-index: 12; pointer-events: none; }
        #mania-wrapper #playfield.note-style-circle .key { width: 100%; background-color: transparent; border: none; margin: 0; height: var(--receptor-size); display: flex; align-items: center; justify-content: center; font-size: 0; }
        #mania-wrapper #playfield.note-style-circle .key::before { content: ''; display: block; height: var(--receptor-size); width: var(--receptor-size); border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 50%; background-color: rgba(0, 0, 0, 0.3); transition: background-color 0.05s, box-shadow 0.05s; box-sizing: border-box; }
        #mania-wrapper #playfield.note-style-circle .key.active::before { background-color: rgba(255, 255, 255, 5.0); box-shadow: 0 0 20px inset; }
        #mania-wrapper #key-indicators { position: absolute; bottom: 0; left: 0; width: 100%; height: var(--judgment-line-pos); display: flex; z-index: 12; pointer-events: none; }
        #mania-wrapper .key { width: calc(100% / var(--num-lanes)); text-align: center; font-size: 1.5em; color: rgba(255, 255, 255, 0.5); font-weight: 500; display: flex; align-items: center; justify-content: center; padding-bottom: 2vh; }
        #mania-wrapper #ui-panel { position: absolute; top: 20px; right: 30px; text-align: right; color: white; z-index: 20; }
        #mania-wrapper #score { font-size: 3em; font-weight: 600; }
        #mania-wrapper #accuracy { font-size: 1.5em; font-weight: 400; margin-top: 5px; min-width: 4.5em; text-align: right; }
        #mania-wrapper #accuracy-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }
        #mania-wrapper #judgment-timing-text { position: absolute; top: calc(var(--judgment-text-top) - 3.5vh); left: 50%; transform: translateX(-50%); font-size: 1.2em; opacity: 0; z-index: 22; color: #ccc; animation: mania-judgment-anim-new 0.4s ease-out; pointer-events: none; }
        #mania-wrapper #judgment-text { position: absolute; top: var(--judgment-text-top); left: 50%; transform: translateX(-50%); font-size: 2.2em; font-weight: bold; opacity: 0; z-index: 22; padding: 5px 20px; border-radius: 4px; color: white; text-align: center; animation: mania-judgment-anim-new 0.4s ease-out; pointer-events: none; }
        @keyframes mania-judgment-anim-new { 0% { transform: translateX(-50%) scale(0.9); opacity: 1; } 80% { transform: translateX(-50%) scale(1.05); opacity: 1; } 100% { transform: translateX(-50%) scale(1.05); opacity: 0; } }
        #mania-wrapper #combo-container { position: absolute; top: var(--combo-position-y); left: 50%; transform: translate(-50%, -50%); z-index: 13; color: white; text-align: center; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        #mania-wrapper #combo-container.visible { opacity: 1; }
        #mania-wrapper #combo-count { font-size: calc(7em * var(--combo-size-scale)); font-weight: bold; line-height: 1; text-shadow: 0 0 15px rgba(0,0,0,0.8); }
        #mania-wrapper #combo-label { font-size: calc(1.8em * var(--combo-size-scale)); font-weight: 500; }
        #mania-wrapper .combo-anim { animation: combo-pop 0.1s ease-out; }
        @keyframes combo-pop { 0% { transform: scale(1.3); } 100% { transform: scale(1); } }
        #mania-wrapper #ingame-pause-button { position: absolute; top: 20px; left: 20px; width: 48px; height: 48px; background-color: rgba(255,255,255,0.1); border: 2px solid white; border-radius: 50%; color: white; font-size: 1.8em; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; }
        #mania-wrapper .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        #mania-wrapper .overlay-menu {
            text-align: center;
            padding: 20px;
            background-color: #16213e;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transform: scale(0.85);
        }
        #mania-wrapper .overlay-menu h2 { font-size: 2.5em; margin-top: 0; margin-bottom: 30px; }
        #mania-wrapper .overlay-button { display: block; width: 200px; padding: 15px; margin: 10px auto; font-size: 1.2em; color: white; border: 2px solid white; background-color: transparent; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        #mania-wrapper .overlay-button:hover, #mania-wrapper .overlay-button.selected { background-color: white; color: black; }
        #mania-wrapper #results-menu .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 20px; margin-bottom: 20px; font-size: 1.1em; }
        #mania-wrapper .results-grid .results-item span > span { display: inline-block; min-width: 40px; text-align: right; }
        #mania-wrapper .results-grid .results-item small { font-size: 0.8em; color: #a0a8c0; margin-left: 8px;}
        #mania-wrapper #results-accuracy-container { font-size: 1.5em; font-weight: bold; margin-bottom: 30px; }
        #mania-wrapper #countdown-text { font-size: 8em; font-weight: bold; text-shadow: 0 0 20px rgba(0,0,0,0.7); }
        #mania-wrapper .settings-item { margin-bottom: 20px; text-align: left; padding: 0 20px; width: 250px; }
        #mania-wrapper .settings-item label { display: block; margin-bottom: 10px; }
        #mania-wrapper .settings-item input[type="range"] { width: 100%; }
        #mania-wrapper .mod-select-container { display: flex; flex-wrap: wrap; gap: 8px; }
        #mania-wrapper .mod-button { padding: 8px 12px; font-size: 0.9em; font-weight: 500; color: var(--panel-text); background-color: #394362; border: 1px solid var(--panel-border); border-radius: 20px; cursor: pointer; transition: all 0.2s; user-select: none; }
        #mania-wrapper .mod-button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        
        #mania-wrapper #error-bar-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 14px;
            z-index: 21;
            border-radius: 10px;
            background: linear-gradient(to right, #b29d38, #a6c84a, #6ee099 40%, #45eede 50%, #6ee099 60%, #a6c84a, #b29d38);
            box-shadow: 0 0 8px 2px rgba(115, 228, 153, 0.5), inset 0 0 3px rgba(0,0,0,0.4);
            overflow: visible;
        }
        #mania-wrapper #error-bar {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #mania-wrapper #error-bar::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 120%;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 5px #fff, 0 0 10px #00ffff;
            border-radius: 2px;
        }
        #mania-wrapper .error-tick {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 150%;
            background-color: white;
            box-shadow: 0 0 8px white, 0 0 15px #00ffff;
            border-radius: 3px;
            opacity: 0;
            animation: error-tick-anim 1.5s ease-out forwards;
        }
        @keyframes error-tick-anim {
            0% { opacity: 1; transform: translate(-50%, -50%) scaleY(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scaleY(0.8); }
        }
        #mania-wrapper .results-rank-container {
            margin-bottom: 20px;
        }
        #mania-wrapper #mania-results-rank-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #FFD700;
        }

        /* --- osu!taiko Styles (Scoped) --- */
        #taiko-wrapper {
            --panel-bg: #1f2940;
            --panel-text: #e0e5f0;
            --panel-border: #4a5578;
            --accent-color: #d9534f;
            --disabled-color: #555c6f;
        }
        #taiko-wrapper #app-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        #taiko-wrapper #controls-panel {
            width: 900px;
            height: 880px;
            font-size: 14px;
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            color: var(--panel-text);
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto auto;
            gap: 10px 20px;
            align-items: start;
            transform: scale(0.95);
            box-sizing: border-box;
        }
        #taiko-wrapper .panel-column-left, #taiko-wrapper .panel-column-right {
            display: flex;
            flex-direction: column;
            gap: 50px;
	        min-height: 200px;
        }
        #taiko-wrapper .panel-column-left { grid-column: 1; grid-row: 2; }
        #taiko-wrapper .panel-column-right { grid-column: 2; grid-row: 2; }
        #taiko-wrapper .control-group { display: flex; flex-direction: column; gap: 8px; }
        #taiko-wrapper #beatmap-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        #taiko-wrapper #beatmap-actions > * { width: 100%; padding: 10px 0; font-size: 0.9em; }
        #taiko-wrapper #delete-song-button { background-color: #8c3b38; }
        #taiko-wrapper #delete-song-button:hover { background-color: #a34c49; }
        #taiko-wrapper .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 15px; align-items: start; }
        #taiko-wrapper .settings-grid .control-group { gap: 8px; }
        #taiko-wrapper .settings-grid .control-group.span-2 { grid-column: 1 / -1; }
        #taiko-wrapper .assist-options, #taiko-wrapper .sound-options { display: flex; flex-direction: column; gap: 5px; }
        #taiko-wrapper .sound-options { flex-direction: row; gap: 10px; }
        #taiko-wrapper .sound-options .file-input-label { flex: 1; }
        #taiko-wrapper #taiko-game-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; display: none; z-index: 10; }
        #taiko-wrapper #taiko-playfield { position: absolute; top: 50%; left: 0; right: 0; height: 180px; transform: translateY(calc(-50% - 58px)); background-color: rgba(18, 18, 18, 0.85); z-index: 10; box-shadow: 0 5px 25px rgba(0,0,0,0.3); border-radius: 0; }
        #taiko-wrapper #game-canvas { display: block; width: 100%; height: 100%; }
        #taiko-wrapper .grid-item-full { grid-column: 1 / -1; }
        #taiko-wrapper #controls-panel h2 { grid-column: 1 / -1; text-align: center; margin: 0 0 10px 0; font-size: 1.8em; font-weight: 600; color: var(--accent-color); }
        #taiko-wrapper #controls-panel label { font-size: 0.9em; font-weight: 500; color: #a0a8c0; margin-bottom: 0px; display: block; }
        #taiko-wrapper #controls-panel p { grid-column: 1 / -1; text-align: center; margin: 10px 0 0 0; }
        #taiko-wrapper input[type="file"] { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        #taiko-wrapper .file-input-label { display: inline-block; padding: 8px 15px; font-size: 0.9em; font-weight: 500; color: var(--panel-text); background-color: #394362; border: 1px solid var(--panel-border); border-radius: 6px; cursor: pointer; transition: background-color 0.2s; text-align: center;}
        #taiko-wrapper .file-input-label:hover { background-color: #4a5578; }
        #taiko-wrapper .file-input-label.is-loading { background-color: var(--disabled-color); cursor: not-allowed; }
        #taiko-wrapper input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: #2a344d; border-radius: 3px; outline: none; cursor: pointer; }
        #taiko-wrapper input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--accent-color); border-radius: 50%; cursor: pointer; }
        #taiko-wrapper input[type="number"], #taiko-wrapper #song-search-input, #taiko-wrapper #saved-songs-list { width: 100%; background-color: #2a344d; color: var(--panel-text); border: 1px solid var(--panel-border); border-radius: 6px; padding: 8px; font-size: 1em; box-sizing: border-box; }
        #taiko-wrapper #song-search-input { text-align: left; padding-left: 12px; }
        #taiko-wrapper #saved-songs-list { padding: 8px; text-align: center; text-align-last: center; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        #taiko-wrapper #taiko-key-config-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        #taiko-wrapper .key-config-item { display: flex; flex-direction: column; }
        #taiko-wrapper .key-config-input { flex-grow: 1; height: 45px; background-color: #2a344d; border: 1px solid var(--panel-border); border-radius: 6px; color: var(--panel-text); font-size: 1.3em; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; user-select: none; }
        #taiko-wrapper .key-config-input:hover { background-color: #394362; }
        #taiko-wrapper .key-config-input.is-waiting { background-color: var(--accent-color); border-color: var(--accent-color); outline: none; color: white; }
        #taiko-wrapper .checkbox-wrapper { display: flex; align-items: center; cursor: pointer; margin-bottom: 5px; }
        #taiko-wrapper input[type="checkbox"] { display: none; }
        #taiko-wrapper .custom-checkbox { width: 20px; height: 20px; background-color: #2a344d; border: 1px solid var(--panel-border); border-radius: 4px; display: inline-block; position: relative; margin-right: 10px; transition: background-color 0.2s; flex-shrink: 0; }
        #taiko-wrapper input[type="checkbox"]:checked + .custom-checkbox { background-color: var(--accent-color); }
        #taiko-wrapper .custom-checkbox::after { content: ''; position: absolute; left: 6px; top: 2px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); display: none; }
        #taiko-wrapper input[type="checkbox"]:checked + .custom-checkbox::after { display: block; }
        #taiko-wrapper .control-button { width: 100%; padding: 12px; font-size: 1em; font-weight: 500; color: var(--panel-text); background-color: #394362; border: 1px solid var(--panel-border); border-radius: 8px; cursor: pointer; transition: background-color 0.2s; -webkit-appearance: none; text-align: center; }
        #taiko-wrapper .control-button:hover { background-color: #4a5578; }
        #taiko-wrapper #buttons-group { grid-column: 1 / -1; grid-row: 3; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-top: 10px; }
        #taiko-wrapper #taiko-start-button { padding: 15px; font-size: 1.2em; font-weight: 600; color: white; background-color: var(--accent-color); border: none; border-radius: 8px; }
        #taiko-wrapper #switch-to-mania-button { border-radius: 8px; }
        #taiko-wrapper #taiko-start-button:disabled, #taiko-wrapper #save-song-to-pc-button:disabled { background-color: var(--disabled-color); cursor: not-allowed; color: #8c92a3; }
        #taiko-wrapper #taiko-song-info { min-height: 80px; text-align: center; background: #2a344d; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; justify-content: center; border: 1px solid var(--panel-border); }
        #taiko-wrapper #taiko-ingame-pause-button { display: none; }
        #taiko-wrapper #taiko-ui-panel { position: absolute; top: 20px; right: 30px; color: white; z-index: 20; text-shadow: 0 0 8px rgba(0,0,0,0.8); text-align: right; font-weight: 600; }
        #taiko-wrapper #taiko-score { font-size: 2.5em; }
        #taiko-wrapper #taiko-accuracy { font-size: 1.5em; color: #FFD700; min-width: 5.5em; text-align: right; }
        #taiko-wrapper #taiko-accuracy-container { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        #taiko-wrapper #combo-display { position: absolute; top: 49.3%; left: 180px; width: 120px; height: 120px; z-index: 20; font-weight: bold; color: white; text-shadow: 0 0 8px rgba(0,0,0,0.8); opacity: 0; transform: translate(-50%, calc(-50% - 58px)) scale(0.8); transition: opacity 0.2s, transform 0.2s; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        #taiko-wrapper #combo-display.visible { opacity: 1; transform: translate(-50%, calc(-50% - 58px)) scale(1); }
        #taiko-wrapper #roll-counter-display { position: absolute; top: 50%; left: 390px; transform: translate(-50%, calc(-50% - 58px)); z-index: 21; color: white; font-size: 36px; font-weight: bold; text-shadow: 0 0 5px black, 0 0 5px black; opacity: 0; transition: opacity 0.1s linear; pointer-events: none; }
        #taiko-wrapper #roll-counter-display.visible { opacity: 1; }
        #taiko-wrapper #combo { font-size: 4.5em; line-height: 1; }
        #taiko-wrapper #combo-label { display: none; }
        #taiko-wrapper #taiko-judgment-text { position: absolute; top: calc(50% - 180px); left: 390px; transform: translateX(-50%); font-size: 2.5em; font-weight: bold; opacity: 0; z-index: 22; padding: 5px 20px; border-radius: 4px; color: white; text-align: center; text-shadow: 0 0 8px #000, 0 0 8px #000; animation: taiko-judgment-anim-new 0.4s ease-out; pointer-events: none; }
        @keyframes taiko-judgment-anim-new { 0% { transform: translateX(-50%) translateY(5px); opacity: 1; } 20% { transform: translateX(-50%) translateY(-3px); opacity: 1; } 35%, 90% { transform: translateX(-50%) translateY(0); opacity: 1; } 100% { transform: translateX(-50%) translateY(0); opacity: 0; } }
        #taiko-wrapper .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        #taiko-wrapper .overlay-menu { text-align: center; padding: 30px 40px; background-color: var(--panel-bg); border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform: scale(0.85); }
        #taiko-wrapper .overlay-menu h2 { font-size: 2.8em; margin-top: 0; margin-bottom: 30px; letter-spacing: 2px;}
        #taiko-wrapper .overlay-button { display: block; width: 220px; padding: 15px; margin: 12px auto; font-size: 1.2em; color: white; border: 2px solid var(--panel-border); background-color: #394362; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        #taiko-wrapper .overlay-button:hover, #taiko-wrapper .overlay-button.selected { background-color: #4a5578; }
        #taiko-wrapper .overlay-button:active { transform: scale(0.98); }
        #taiko-wrapper #results-menu #results-song-title { font-size: 1.2em; color: #a0a8c0; margin-top: -20px; margin-bottom: 25px;}
        #taiko-wrapper #results-menu .results-main-stats { display: flex; justify-content: space-around; gap: 30px; margin-bottom: 30px; }
        #taiko-wrapper #results-menu .results-item { text-align: center; }
        #taiko-wrapper #results-menu .results-item.rank-item { display: flex; flex-direction: column; align-items: center; }
        #taiko-wrapper .results-item span:first-child { display: block; font-size: 1em; color: #a0a8c0; margin-bottom: 5px;}
        #taiko-wrapper .results-item span:last-child { font-size: 2em; font-weight: 600;}
        #taiko-wrapper #results-rank-value { font-size: 2.5em; color: #FFD700; }
        #taiko-wrapper #results-menu .results-judgments { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; text-align: center; }
        #taiko-wrapper .judgment-item span:first-child { font-size: 1.2em; font-weight: bold;}
        #taiko-wrapper #results-ryo { color: gold; }
        #taiko-wrapper #results-ka { color: white; }
        #taiko-wrapper #results-fuka { color: #dda0dd; }
        #taiko-wrapper #drum-display { position: absolute; width: 120px; height: 120px; top: 50%; left: 120px; transform: translateY(calc(-50% - 58px)); z-index: 15; pointer-events: none; }
        #taiko-wrapper .drum-body { width: 100%; height: 100%; background-color: #FFFFFF; border: 12px solid #FFFFFF; border-radius: 50%; box-sizing: border-box; position: absolute;box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.3); }
        #taiko-wrapper .drum-body::after { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2px; height: 100%; background-color: rgba(0, 0, 0, 0.3); }
        #taiko-wrapper .drum-hit-area { position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 50%; box-sizing: border-box; opacity: 0; transition: opacity 0.1s linear; }
        #taiko-wrapper .drum-hit-area.active { opacity: 1; transition: none; }
        #taiko-wrapper #drum-don-left, #taiko-wrapper #drum-don-right { width: calc(100% - 24px); height: calc(100% - 24px); top: 12px; left: 12px; background-color: rgba(255, 77, 109, 0.8); }
        #taiko-wrapper #drum-don-left { clip-path: polygon(0% 0%, 50% 0%, 50% 100%, 0% 100%); }
        #taiko-wrapper #drum-don-right { clip-path: polygon(50% 0%, 100% 0%, 100% 100%, 50% 100%); }
        #taiko-wrapper #drum-katsu-left { border: 12px solid rgba(77, 171, 247, 0.9); clip-path: polygon(0% 0%, 50% 0%, 50% 100%, 0% 100%); }
        #taiko-wrapper #drum-katsu-right { border: 12px solid rgba(77, 171, 247, 0.9); clip-path: polygon(50% 0%, 100% 0%, 100% 100%, 50% 100%); }
        #taiko-wrapper #taiko-error-bar-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 40%; height: 14px; z-index: 25; border-radius: 10px; background: linear-gradient(to right, #b29d38, #a6c84a, #6ee099 40%, #45eede 50%, #6ee099 60%, #a6c84a, #b29d38); box-shadow: 0 0 8px 2px rgba(115, 228, 153, 0.5), inset 0 0 3px rgba(0,0,0,0.4); overflow: visible; }
        #taiko-wrapper #taiko-error-bar { position: relative; width: 100%; height: 100%; }
        #taiko-wrapper #taiko-error-bar::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 3px; height: 120%; background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 0 5px #fff, 0 0 10px #00ffff; border-radius: 2px; }
        #taiko-wrapper .error-tick { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 3px; height: 150%; background-color: white; box-shadow: 0 0 8px white, 0 0 15px #00ffff; border-radius: 3px; opacity: 0; animation: taiko-error-tick-anim 1.5s ease-out forwards; }
        @keyframes taiko-error-tick-anim { 0% { opacity: 1; transform: translate(-50%, -50%) scaleY(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scaleY(0.8); } }
        
        /* Taiko UI Settings Overlay */
        #taiko-wrapper #taiko-settings-overlay .overlay-menu {
             transform: scale(0.85);
        }
        #taiko-wrapper #taiko-settings-overlay .settings-item {
            margin-bottom: 25px;
            text-align: left;
            padding: 0 20px;
            width: 280px;
        }
        #taiko-wrapper #taiko-settings-overlay .settings-item label {
            display: block;
            margin-bottom: 12px;
        }
        #taiko-wrapper #taiko-settings-overlay .settings-item input[type="range"] {
            width: 100%;
        }

        #mania-wrapper #mania-gameplay-progress-pie,
        #taiko-wrapper #taiko-gameplay-progress-pie {
            position: relative;
        }

        .shortcut-key-control { margin-top: 10px; }
        .shortcut-key-inputs { display: flex; gap: 15px; justify-content: center; }
        .shortcut-key-item { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .shortcut-key-item > span { font-size: 0.9em; color: #a0a8c0; }
        .shortcut-key-item .key-config-input { width: 80px; }
        #taiko-wrapper .shortcut-key-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

    <div id="game-selector">
        <h1>Select a Game</h1>
        <div>
            <button id="select-mania" class="game-select-button">Play Mania</button>
            <button id="select-taiko" class="game-select-button">Play Taiko</button>
        </div>
    </div>

    <!-- Container for osu!mania Game -->
    <div id="mania-wrapper" class="game-wrapper">
        <video id="video-background" loop muted playsinline></video>
        <img id="image-background" src="" alt="Background Image">
        <div id="app-container">
            <div id="controls-panel">
                <h2 class="grid-item-full">Mania Player</h2>
                <div class="panel-column">
                    <div>
                        <label for="beatmap-library-selector">1. 譜面ライブラリ (.osz, .mcz, .zip)</label>
                        <select id="beatmap-library-selector" size="8"></select>
                        <input type="file" id="mania-osz-file" accept=".osz,.zip,.mcz" multiple>
                    </div>
                    <div class="library-buttons">
                        <button id="add-beatmaps-button" class="control-button">追加</button>
                        <button id="remove-beatmap-button" class="control-button">削除</button>
                        <button id="save-osz-button" class="control-button">PCへ保存</button>
                    </div>
                    <div id="beatmap-selector-container" style="display: none;">
                        <label for="beatmap-selector">2. 難易度を選択</label>
                        <select id="beatmap-selector" class="styled-select"></select>
                    </div>
                     <div id="background-selector-container" style="display: none;">
                        <label for="background-selector">3. 背景を選択</label>
                        <select id="background-selector" class="styled-select"></select>
                    </div>
                </div>
                <div class="panel-column">
                    <div>
                        <label for="key-count-selector">キー数 (Key Count)</label>
                        <select id="key-count-selector" class="styled-select"></select>
                    </div>
                    <div>
                        <label>MOD</label>
                        <div id="mod-select-container" class="mod-select-container">
                            <div class="mod-button" data-mod="NF">No Fail</div>
                            <div class="mod-button" data-mod="HT">Half Time</div>
                            <div class="mod-button" data-mod="DT">Double Time</div>
                            <div class="mod-button" data-mod="HD">Hidden</div>
                        </div>
                    </div>
                    <div class="speed-control">
                        <label for="speed-slider" id="speed-label">ノーツ速度 (x1.5)</label>
                        <input type="range" id="speed-slider" min="0.5" max="4" value="1.5" step="0.1">
                    </div>
                    <div class="offset-controls-container">
                        <div class="offset-control">
                            <label for="offset-input">共通ノーツオフセット (ms)</label>
                            <input type="number" id="offset-input" value="0" step="5">
                        </div>
                        <div class="offset-control">
                            <label for="audio-offset-input">個別楽曲開始位置 (ms)</label>
                            <input type="number" id="audio-offset-input" value="0" step="5">
                        </div>
                    </div>
                    <div class="key-config-control">
                        <label>キー設定</label>
                        <div id="key-config-inputs"></div>
                    </div>
                     <div id="force-4k-container" style="display: none;">
                        <label for="force-4k-checkbox" class="checkbox-wrapper">
                            <input type="checkbox" id="force-4k-checkbox">
                            <span class="custom-checkbox"></span>
                            <span>中央4レーンのみプレイ</span>
                        </label>
                    </div>
                    <div class="assist-control">
                        <label>プレイアシスト</label>
                        <label for="auto-play-checkbox" class="checkbox-wrapper">
                            <input type="checkbox" id="auto-play-checkbox">
                            <span class="custom-checkbox"></span>
                            <span>オートプレイ</span>
                        </label>
                    </div>
                     <div class="settings-buttons">
                        <button id="open-settings-button" class="control-button">UI設定</button>
                        <button id="switch-to-taiko-button" class="control-button">Taiko Playerへ</button>
                    </div>
                    <div class="shortcut-key-control">
                         <label>ショートカットキー</label>
                         <div class="shortcut-key-inputs">
                             <div class="shortcut-key-item">
                                 <span>リトライ</span>
                                 <div id="mania-shortcut-retry" class="key-config-input" data-shortcut-for="retry" tabindex="0">R</div>
                             </div>
                             <div class="shortcut-key-item">
                                 <span>メニューへ</span>
                                 <div id="mania-shortcut-menu" class="key-config-input" data-shortcut-for="menu" tabindex="0">H</div>
                             </div>
                         </div>
                     </div>
                </div>
                <button id="start-button" class="grid-item-full" disabled>ゲーム開始</button>
                <div id="song-info" class="grid-item-full">
                    <div id="song-title">譜面を選択してください</div>
                    <div id="song-artist" style="font-size: 0.9em; color: #a0a8c0;"></div>
                </div>
                <p class="grid-item-full">※ WキーまたはESCキーでポーズ / ESC長押しでフルスクリーン解除</p>
            </div>
        </div>
        <div id="game-container" class="game-container">
            <div id="countdown-overlay" class="overlay" style="background-color: rgba(0,0,0,0.6);">
                <div id="countdown-text">3</div>
            </div>
            <button id="ingame-pause-button">||</button>
            <div id="ui-panel">
                <div id="score">0</div>
                <div id="accuracy-container">
                    <canvas id="mania-gameplay-progress-pie" width="24" height="24"></canvas>
                    <div id="accuracy">100.00%</div>
                </div>
            </div>
            <div id="judgment-timing-text"></div>
            <div id="judgment-text"></div>
            <div id="playfield">
                <div id="playfield-background"></div>
                <div id="combo-container">
                    <div id="combo-count">0</div>
                    <div id="combo-label">COMBO</div>
                </div>
                <div id="lanes-container"></div>
                <div id="judgment-line"></div>
                <div id="error-bar-container"><div id="error-bar"></div></div>
                <div id="key-indicators"></div>
            </div>
        </div>
        <div id="pause-overlay" class="overlay">
            <div id="pause-menu" class="overlay-menu">
                <h2>PAUSED</h2>
                <button id="resume-button" class="overlay-button">再開 (Resume)</button>
                <button id="retry-button" class="overlay-button">やり直し (Retry)</button>
                <button id="back-to-menu-button" class="overlay-button">メニューに戻る (Menu)</button>
            </div>
        </div>
        <div id="results-overlay" class="overlay">
            <div id="results-menu" class="overlay-menu">
                <h2>RESULTS</h2>
                <div class="results-item" style="font-size: 1.8em; margin-bottom: 20px;"><span>SCORE: </span><span id="results-score-value">0</span></div>
                <div class="results-rank-container">
                    <span id="mania-results-rank-value">S</span>
                </div>
                <div id="results-accuracy-container">ACCURACY: <span id="results-accuracy-value">0.00</span>%</div>
                <div class="results-grid">
                    <div class="results-item" style="grid-column: 1 / -1;"><span>MAX COMBO: </span><span id="results-max-combo-value">0</span></div>
                    <div class="results-item"><span>PERFECT+: </span><span><span id="results-perfect-plus-value">0</span> <small id="results-perfect-plus-percent">(0.00%)</small></span></div>
                    <div class="results-item"><span>PERFECT: </span><span><span id="results-perfect-value">0</span> <small id="results-perfect-percent">(0.00%)</small></span></div>
                    <div class="results-item"><span>GREAT: </span><span><span id="results-great-value">0</span> <small id="results-great-percent">(0.00%)</small></span></div>
                    <div class="results-item"><span>GOOD: </span><span><span id="results-good-value">0</span> <small id="results-good-percent">(0.00%)</small></span></div>
                    <div class="results-item"><span>OK: </span><span><span id="results-ok-value">0</span> <small id="results-ok-percent">(0.00%)</small></span></div>
                    <div class="results-item"><span>MISS: </span><span><span id="results-miss-value">0</span> <small id="results-miss-percent">(0.00%)</small></span></div>
                </div>
                <button id="results-retry-button" class="overlay-button">やり直し (Retry)</button>
                <button id="results-menu-button" class="overlay-button">メニューに戻る (Menu)</button>
            </div>
        </div>
        <div id="settings-overlay" class="overlay">
             <div class="overlay-menu">
                <h2>UI設定</h2>
                <div class="settings-item">
                    <label for="note-style-selector">ノーツのスタイル</label>
                    <select id="note-style-selector" class="styled-select">
                        <option value="bar">バー</option>
                        <option value="circle">サークル</option>
                    </select>
                </div>
                <div class="settings-item">
                    <label for="background-brightness-slider">背景の明るさ: <span id="brightness-value">50</span>%</label>
                    <input type="range" id="background-brightness-slider" min="0" max="100" value="50">
                </div>
                <div class="settings-item">
                    <label for="lane-opacity-slider" id="lane-opacity-label">レーンの不透明度: <span id="lane-opacity-value">50</span>%</label>
                    <input type="range" id="lane-opacity-slider" min="0" max="100" value="50">
                </div>
                <div class="settings-item">
                    <label for="lane-width-slider">レーンの幅: <span id="lane-width-value">100</span>%</label>
                    <input type="range" id="lane-width-slider" min="50" max="150" value="100">
                </div>
                <div class="settings-item">
                    <label for="combo-size-slider">コンボの大きさ: <span id="combo-size-value">100</span>%</label>
                    <input type="range" id="combo-size-slider" min="50" max="150" value="100">
                </div>
                <div class="settings-item">
                    <label for="combo-position-slider">コンボのY位置: <span id="combo-position-value">45</span>%</label>
                    <input type="range" id="combo-position-slider" min="20" max="80" value="45">
                </div>
                <div class="settings-item">
                    <label for="judgment-position-slider">判定文字のY位置: <span id="judgment-position-value">65</span>%</label>
                    <input type="range" id="judgment-position-slider" min="20" max="85" value="65">
                </div>
                <button class="overlay-button">閉じる</button>
             </div>
        </div>
    </div>
    
    <!-- Container for osu!taiko Game -->
    <div id="taiko-wrapper" class="game-wrapper">
        <div id="app-container">
            <div id="controls-panel">
                <h2 class="grid-item-full">Taiko Player</h2>

                <!-- Left Column -->
                <div class="panel-column-left">
                    <div class="control-group">
                        <label>譜面管理</label>
                        <input type="text" id="song-search-input" placeholder="曲を検索...">
                        <select id="saved-songs-list" class="control-button">
                             <option value="">-- 保存済み譜面を選択 --</option>
                        </select>
                        <div id="beatmap-actions">
                             <label for="taiko-osz-file" id="osz-file-label" class="file-input-label control-button">追加</label>
                             <button id="delete-song-button" class="control-button">削除</button>
                             <button id="save-song-to-pc-button" class="control-button" disabled>PCへ保存</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>曲情報</label>
                        <div id="taiko-song-info">
                            <div id="taiko-song-title">譜面を選択してください</div>
                            <div id="taiko-song-artist" style="font-size: 0.9em; color: #a0a8c0;"></div>
                        </div>
                        <div id="taiko-beatmap-selector-container" style="display: none;">
                            <select id="taiko-beatmap-selector" class="control-button"></select>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>キー設定</label>
                        <div id="taiko-key-config-inputs">
                             <div class="key-config-item">
                                <label>ドン (左)</label>
                                <div id="key-don-left" class="key-config-input" data-key-id="don_left" tabindex="0">D</div>
                            </div>
                            <div class="key-config-item">
                                <label>ドン (右)</label>
                                <div id="key-don-right" class="key-config-input" data-key-id="don_right" tabindex="0">K</div>
                            </div>
                            <div class="key-config-item">
                                <label>カッ (左)</label>
                                <div id="key-katsu-left" class="key-config-input" data-key-id="katsu_left" tabindex="0">S</div>
                            </div>
                            <div class="key-config-item">
                                <label>カッ (右)</label>
                                <div id="key-katsu-right" class="key-config-input" data-key-id="katsu_right" tabindex="0">L</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="panel-column-right">
                    <div class="settings-grid">
                        <div class="control-group">
                            <label for="taiko-speed-slider" id="taiko-speed-label">スクロール速度 (x1.0)</label>
                            <input type="range" id="taiko-speed-slider" min="-5" max="5" value="0" step="0.1">
                        </div>
                         <div class="control-group">
                            <label for="taiko-offset-input">譜面オフセット (ms)</label>
                            <input type="number" id="taiko-offset-input" value="0" step="0.5">
                        </div>
                         <div class="control-group">
                            <label for="taiko-individual-offset-input">個別譜面オフセット (ms)</label>
                            <input type="number" id="taiko-individual-offset-input" value="0" step="0.5">
                        </div>
                        <div class="control-group">
                            <label for="video-offset-input">動画オフセット (ms)</label>
                            <input type="number" id="video-offset-input" value="0" step="5">
                        </div>
                        <div class="control-group span-2">
                            <label for="se-offset-input">SEオフセット (ms)</label>
                            <input type="number" id="se-offset-input" value="0" step="5" title="音が遅れて聞こえる場合、-50のようにマイナスの値を入力して調整してください。">
                        </div>
                         <div class="control-group span-2">
                            <label>プレイアシスト</label>
                            <div class="assist-options">
                                <label for="taiko-auto-play-checkbox" class="checkbox-wrapper">
                                    <input type="checkbox" id="taiko-auto-play-checkbox">
                                    <span class="custom-checkbox"></span>
                                    <span>オートプレイ</span>
                                </label>
                                 <label for="single-hand-big-note-checkbox" class="checkbox-wrapper">
                                    <input type="checkbox" id="single-hand-big-note-checkbox" checked>
                                    <span class="custom-checkbox"></span>
                                    <span>大音符を片手で処理</span>
                                </label>
                                <label for="auto-se-checkbox" class="checkbox-wrapper">
                                    <input type="checkbox" id="auto-se-checkbox">
                                    <span class="custom-checkbox"></span>
                                    <span>自動SE</span>
                                </label>
                            </div>
                        </div>
                        <div class="control-group span-2">
                            <label>サウンド設定</label>
                            <div class="sound-options">
                                <label for="don-sound-file" class="file-input-label">ドン(SE)</label>
                                <input type="file" id="don-sound-file" accept="audio/*">
                                <label for="katsu-sound-file" class="file-input-label">カッ(SE)</label>
                                <input type="file" id="katsu-sound-file" accept="audio/*">
                            </div>
                        </div>
                        <div id="background-select-wrapper" class="control-group span-2" style="display: none;">
                            <label for="background-select">背景</label>
                            <select id="background-select" class="control-button"></select>
                        </div>
                        <div class="control-group span-2">
                            <label>ショートカットキー</label>
                            <div class="shortcut-key-inputs">
                                <div class="shortcut-key-item">
                                    <span>リトライ</span>
                                    <div id="taiko-shortcut-retry" class="key-config-input" data-shortcut-for="retry" tabindex="0">R</div>
                                </div>
                                <div class="shortcut-key-item">
                                    <span>メニューへ</span>
                                    <div id="taiko-shortcut-menu" class="key-config-input" data-shortcut-for="menu" tabindex="0">H</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Buttons -->
                <div id="buttons-group" class="grid-item-full">
                    <button id="taiko-start-button" disabled>ゲーム開始 (Space)</button>
                    <button id="open-taiko-settings-button" class="control-button">UI設定</button>
                    <button id="switch-to-mania-button" class="control-button">Mania Playerへ</button>
                </div>
                
                <p class="grid-item-full">※ WキーまたはESCキーでポーズ / ESC長押しでフルスクリーン解除©MASAKI_TAIKO</p>
                
                <!-- Hidden file input -->
                <input type="file" id="taiko-osz-file" accept=".osz" multiple>
            </div>
        </div>
        <div id="taiko-game-container" class="game-container">
            <video id="taiko-background-video" muted loop playsinline></video>
            <img id="taiko-background-image" />
            <button id="taiko-ingame-pause-button">||</button>
            <div id="taiko-ui-panel">
                <div id="taiko-score">0</div>
                <div id="taiko-accuracy-container">
                    <canvas id="taiko-gameplay-progress-pie" width="24" height="24"></canvas>
                    <div id="taiko-accuracy">S 100.00%</div>
                </div>
            </div>
            <div id="combo-display">
                <span id="combo">0</span><span id="combo-label">x</span>
            </div>
            <div id="roll-counter-display"></div>
            <div id="taiko-judgment-text"></div>
            <div id="drum-display">
                <div class="drum-body"></div>
                <div id="drum-don-left" class="drum-hit-area"></div>
                <div id="drum-don-right" class="drum-hit-area"></div>
                <div id="drum-katsu-left" class="drum-hit-area"></div>
                <div id="drum-katsu-right" class="drum-hit-area"></div>
            </div>
             <div id="taiko-error-bar-container"><div id="taiko-error-bar"></div></div>
            <div id="taiko-playfield">
                <canvas id="game-canvas"></canvas>
            </div>
        </div>
        <div id="taiko-pause-overlay" class="overlay">
            <div id="pause-menu" class="overlay-menu">
                <h2>PAUSED</h2>
                <button id="taiko-resume-button" class="overlay-button">再開 (Resume)</button>
                <button id="taiko-retry-button" class="overlay-button">やり直し (Retry)</button>
                <button id="back-to-title-button-pause" class="overlay-button">タイトルへ戻る</button>
            </div>
        </div>
        <div id="taiko-results-overlay" class="overlay">
            <div id="results-menu" class="overlay-menu">
                <h2>RESULTS</h2>
                <div id="results-song-title">Song Title</div>
                 <div class="results-main-stats">
                    <div class="results-item">
                        <span>SCORE</span>
                        <span id="taiko-results-score-value">0</span>
                    </div>
                    <div class="results-item rank-item">
                        <span>RANK</span>
                        <span id="results-rank-value">S</span>
                    </div>
                    <div class="results-item">
                        <span>MAX COMBO</span>
                        <span id="taiko-results-max-combo-value">0</span>
                    </div>
                </div>
                <div class="results-judgments">
                    <div class="judgment-item" id="results-ryo">
                        <span>良 (PERFECT)</span>
                        <span id="results-ryo-value">0</span>
                    </div>
                     <div class="judgment-item" id="results-ka">
                        <span>可 (GREAT)</span>
                        <span id="results-ka-value">0</span>
                    </div>
                     <div class="judgment-item" id="results-fuka">
                        <span>不可 (MISS)</span>
                        <span id="results-fuka-value">0</span>
                    </div>
                </div>
                <button id="taiko-results-retry-button" class="overlay-button">やり直し (Retry)</button>
                <button id="back-to-title-button-results" class="overlay-button">タイトルへ戻る</button>
            </div>
        </div>
        <div id="taiko-settings-overlay" class="overlay">
             <div class="overlay-menu">
                <h2>UI設定</h2>
                <div class="settings-item">
                    <label for="taiko-lane-opacity-slider" id="taiko-lane-opacity-label">レーン不透明度 (85%)</label>
                    <input type="range" id="taiko-lane-opacity-slider" min="0" max="1" value="0.85" step="0.01">
                </div>
                <div class="settings-item">
                    <label for="bg-brightness-slider" id="bg-brightness-label">背景の明るさ (100%)</label>
                    <input type="range" id="bg-brightness-slider" min="0.1" max="2.5" value="1" step="0.05">
                </div>
                <div class="settings-item">
                    <label for="lane-cover-slider" id="lane-cover-label">レーンカバー (0%)</label>
                    <input type="range" id="lane-cover-slider" min="0" max="70" value="0" step="1">
                </div>
                <button class="overlay-button">閉じる</button>
             </div>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <script>
    // --- Global Controller ---
    let shortcutKeys = {
        retry: 'R',
        menu: 'H'
    };

    function saveGlobalSettings() {
        localStorage.setItem('rhythmGameGlobalSettings', JSON.stringify({ shortcuts: shortcutKeys }));
    }

    function loadGlobalSettings() {
        try {
            const settings = JSON.parse(localStorage.getItem('rhythmGameGlobalSettings'));
            if (settings && settings.shortcuts) {
                shortcutKeys = { ...shortcutKeys, ...settings.shortcuts };
            }
        } catch (e) {
            console.error("Failed to load global settings:", e);
        }
    }

    function initializeShortcutKeySetup(retryElementId, menuElementId) {
        const retryInput = document.getElementById(retryElementId);
        const menuInput = document.getElementById(menuElementId);
        if (!retryInput || !menuInput) return;

        const updateUI = () => {
            document.querySelectorAll('[data-shortcut-for="retry"]').forEach(el => el.textContent = shortcutKeys.retry);
            document.querySelectorAll('[data-shortcut-for="menu"]').forEach(el => el.textContent = shortcutKeys.menu);
        };
        updateUI();

        const setupListener = (element, keyName) => {
            element.addEventListener('click', () => {
                document.querySelectorAll('.key-config-input.is-waiting').forEach(el => el.blur());
                element.textContent = '...';
                element.classList.add('is-waiting');
            });

            element.addEventListener('keydown', (e) => {
                e.preventDefault();
                if (!element.classList.contains('is-waiting')) return;
                if (e.key === 'Escape') {
                    element.blur();
                    return;
                }
                const newKey = e.key.toUpperCase();
                if (newKey.length === 1 || e.code.startsWith('F')) {
                     shortcutKeys[keyName] = newKey;
                     saveGlobalSettings();
                     updateUI();
                     element.blur();
                }
            });

            element.addEventListener('blur', () => {
                element.classList.remove('is-waiting');
                updateUI();
            });
        };

        setupListener(retryInput, 'retry');
        setupListener(menuInput, 'menu');
    }
    let activeGame = null;
    let maniaInitialized = false;
    let taikoInitialized = false;
    let isRequestingFile = false;
    let isRetryOnCooldown = false;

    function switchToMania() {
        document.getElementById('game-selector').style.display = 'none';
        document.getElementById('taiko-wrapper').style.display = 'none';
        document.getElementById('mania-wrapper').style.display = 'block';
        activeGame = 'mania';
        if (!maniaInitialized) {
            ManiaGame.initialize();
            maniaInitialized = true;
        }
    }

    function switchToTaiko() {
        document.getElementById('game-selector').style.display = 'none';
        document.getElementById('mania-wrapper').style.display = 'none';
        document.getElementById('taiko-wrapper').style.display = 'block';
        activeGame = 'taiko';
        if (!taikoInitialized) {
            TaikoGame.initialize();
            taikoInitialized = true;
        }
    }

    function drawProgressPie(canvasId, progress) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) * 0.9;
        progress = Math.max(0, Math.min(1, progress));
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
        ctx.fillStyle = '#3a4360';
        ctx.fill();
        if (progress > 0) {
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, (-Math.PI / 2) + (progress * 2 * Math.PI), false);
            ctx.closePath();
            ctx.fillStyle = '#cccccc';
            ctx.fill();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadGlobalSettings();
        const selectManiaBtn = document.getElementById('select-mania');
        const selectTaikoBtn = document.getElementById('select-taiko');
        selectManiaBtn.addEventListener('click', switchToMania);
        selectTaikoBtn.addEventListener('click', switchToTaiko);
    });

    document.addEventListener('keydown', (e) => {
        const activeElement = document.activeElement;
        const isTyping = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.isContentEditable);

        if ((e.key.toUpperCase() === 'W' || e.key === 'Escape') && !e.repeat) {
             e.preventDefault();
             if (activeGame === 'mania') ManiaGame.togglePauseExternal();
             if (activeGame === 'taiko') TaikoGame.togglePauseExternal();
        }

        if (e.key.toUpperCase() === shortcutKeys.retry.toUpperCase() && !e.repeat) {
            if (isTyping) return;
            e.preventDefault();
            if (isRetryOnCooldown) return;
            isRetryOnCooldown = true;
            setTimeout(() => { isRetryOnCooldown = false; }, 3000);
            if (activeGame === 'mania') ManiaGame.retryGameExternal();
            if (activeGame === 'taiko') TaikoGame.retryGameExternal();
        }

        if (e.key.toUpperCase() === shortcutKeys.menu.toUpperCase() && !e.repeat) {
            if (isTyping) return;
            e.preventDefault();
            if (activeGame === 'mania') ManiaGame.returnToControlsExternal();
            if (activeGame === 'taiko') TaikoGame.returnToControlsExternal();
        }
    });


    // --- osu!mania Game Logic (Scoped) ---
    const ManiaGame = (() => {
        // (ManiaのJavaScriptコードは変更なしのため、省略します)
        // ... previous ManiaGame code ...
        const root=document.getElementById("mania-wrapper"),dom={appContainer:root.querySelector("#app-container"),gameContainer:root.querySelector("#game-container"),controlsPanel:root.querySelector("#controls-panel"),playfield:root.querySelector("#playfield"),playfieldBackground:root.querySelector("#playfield-background"),lanesContainer:root.querySelector("#lanes-container"),keyIndicatorsContainer:root.querySelector("#key-indicators"),scoreElement:root.querySelector("#score"),accuracyElement:root.querySelector("#accuracy"),judgmentTextElement:root.querySelector("#judgment-text"),judgmentTimingTextElement:root.querySelector("#judgment-timing-text"),comboContainer:root.querySelector("#combo-container"),comboCount:root.querySelector("#combo-count"),errorBar:root.querySelector("#error-bar"),ingamePauseButton:root.querySelector("#ingame-pause-button"),songTitleElement:root.querySelector("#song-title"),songArtistElement:root.querySelector("#song-artist"),speedSlider:root.querySelector("#speed-slider"),speedLabel:root.querySelector("#speed-label"),offsetInput:root.querySelector("#offset-input"),audioOffsetInput:root.querySelector("#audio-offset-input"),keyConfigInputsContainer:root.querySelector("#key-config-inputs"),keyCountSelector:root.querySelector("#key-count-selector"),startButton:root.querySelector("#start-button"),addBeatmapsButton:root.querySelector("#add-beatmaps-button"),removeBeatmapButton:root.querySelector("#remove-beatmap-button"),saveOszButton:root.querySelector("#save-osz-button"),switchToTaikoButton:root.querySelector("#switch-to-taiko-button"),oszFileInput:root.querySelector("#mania-osz-file"),beatmapLibrarySelector:root.querySelector("#beatmap-library-selector"),beatmapSelectorContainer:root.querySelector("#beatmap-selector-container"),beatmapSelector:root.querySelector("#beatmap-selector"),backgroundSelectorContainer:root.querySelector("#background-selector-container"),backgroundSelector:root.querySelector("#background-selector"),modSelectContainer:root.querySelector("#mod-select-container"),autoPlayCheckbox:root.querySelector("#auto-play-checkbox"),force4kContainer:root.querySelector("#force-4k-container"),force4kCheckbox:root.querySelector("#force-4k-checkbox"),pauseOverlay:root.querySelector("#pause-overlay"),resumeButton:root.querySelector("#resume-button"),retryButton:root.querySelector("#retry-button"),backToMenuButton:root.querySelector("#back-to-menu-button"),countdownOverlay:root.querySelector("#countdown-overlay"),countdownText:root.querySelector("#countdown-text"),resultsOverlay:root.querySelector("#results-overlay"),resultsScore:root.querySelector("#results-score-value"),resultsAccuracy:root.querySelector("#results-accuracy-value"),resultsMaxCombo:root.querySelector("#results-max-combo-value"),resultsRankValue:root.querySelector("#mania-results-rank-value"),resultsPerfectPlus:root.querySelector("#results-perfect-plus-value"),resultsPerfectPlusPercent:root.querySelector("#results-perfect-plus-percent"),resultsPerfect:root.querySelector("#results-perfect-value"),resultsPerfectPercent:root.querySelector("#results-perfect-percent"),resultsGreat:root.querySelector("#results-great-value"),resultsGreatPercent:root.querySelector("#results-great-percent"),resultsGood:root.querySelector("#results-good-value"),resultsGoodPercent:root.querySelector("#results-good-percent"),resultsOk:root.querySelector("#results-ok-value"),resultsOkPercent:root.querySelector("#results-ok-percent"),resultsMiss:root.querySelector("#results-miss-value"),resultsMissPercent:root.querySelector("#results-miss-percent"),resultsRetryButton:root.querySelector("#results-retry-button"),resultsMenuButton:root.querySelector("#results-menu-button"),settingsOverlay:root.querySelector("#settings-overlay"),openSettingsButton:root.querySelector("#open-settings-button"),noteStyleSelector:root.querySelector("#note-style-selector"),backgroundBrightnessSlider:root.querySelector("#background-brightness-slider"),brightnessValue:root.querySelector("#brightness-value"),laneOpacitySlider:root.querySelector("#lane-opacity-slider"),laneOpacityLabel:root.querySelector("#lane-opacity-label"),laneOpacityValue:root.querySelector("#lane-opacity-value"),laneWidthSlider:root.querySelector("#lane-width-slider"),laneWidthValue:root.querySelector("#lane-width-value"),comboSizeSlider:root.querySelector("#combo-size-slider"),comboSizeValue:root.querySelector("#combo-size-value"),comboPositionSlider:root.querySelector("#combo-position-slider"),comboPositionValue:root.querySelector("#combo-position-value"),judgmentPositionSlider:root.querySelector("#judgment-position-slider"),judgmentPositionValue:root.querySelector("#judgment-position-value"),videoBackground:root.querySelector("#video-background"),imageBackground:root.querySelector("#image-background")};let JUDGMENT_WINDOWS={},isGameRunning=!1,isPaused=!1,isAutoPlay=!1,score=0,combo=0,maxCombo=0,accuracy=100,totalJudgments=0,weightedAccuracy=0,judgmentCounts={"PERFECT+":0,PERFECT:0,GREAT:0,GOOD:0,OK:0,MISS:0},animationFrameId=null,gameContext={visualStartTime:0,rate:1},activeMods={NF:!1,HT:!1,DT:!1,HD:!1},keyConfigs={},activeKeys=[],numLanes=4,keyState=[],keyJustPressed=[],selectedPauseIndex=0,beatmap=null,allNotes=[],nextUnjudgedNoteIndex=0,activeHolds=[],currentOszFiles={beatmaps:[],audio:{},video:{},image:{}},currentBeatmapSetId=null,currentBeatmapVersion=null,audioContext,audioBuffer,audioSourceNode,audioContextState={startedAt:0,pausedAt:0,isReady:!1},audioLoaded=!1,db;async function initialize(){for(let e=4;e<=10;e++)dom.keyCountSelector.add(new Option(`${e}K`,e));loadSettings(),setupMods();try{audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){alert("Web Audio APIがこのブラウザではサポートされていません。")}try{await initDB(),await loadBeatmapsFromDB()}catch(e){console.error("Failed to initialize DB:",e),alert("データベースの初期化に失敗しました。譜面ライブラリ機能は使用できません。")}setupEventListeners(),initializeShortcutKeySetup("mania-shortcut-retry","mania-shortcut-menu")}function setupEventListeners(){dom.startButton.addEventListener("click",startGame),dom.switchToTaikoButton.addEventListener("click",switchToTaiko),dom.saveOszButton.addEventListener("click",saveOszFileToPC),dom.addBeatmapsButton.addEventListener("click",()=>dom.oszFileInput.click()),dom.removeBeatmapButton.addEventListener("click",removeBeatmapFromDB),dom.resumeButton.addEventListener("click",togglePause),dom.retryButton.addEventListener("click",retryGame),dom.backToMenuButton.addEventListener("click",returnToControls),dom.resultsRetryButton.addEventListener("click",retryGame),dom.resultsMenuButton.addEventListener("click",returnToControls),dom.ingamePauseButton.addEventListener("click",togglePause),dom.oszFileInput.addEventListener("change",e=>addBeatmapsToDB(e.target.files)),dom.beatmapLibrarySelector.addEventListener("change",handleLibrarySelection),dom.beatmapSelector.addEventListener("change",handleDifficultySelection),dom.backgroundSelector.addEventListener("change",()=>{applyBackgroundChoice(),saveBeatmapSpecificSettings()}),dom.keyCountSelector.addEventListener("change",e=>{setKeyCount(e.target.value),saveSettings()}),dom.speedSlider.addEventListener("input",()=>{updateSpeed(),saveSettings()}),dom.offsetInput.addEventListener("change",saveSettings),dom.audioOffsetInput.addEventListener("change",saveBeatmapSpecificSettings),dom.autoPlayCheckbox.addEventListener("change",saveSettings),dom.force4kCheckbox.addEventListener("change",saveSettings);const e=dom.settingsOverlay.querySelector(".overlay-button");e&&e.addEventListener("click",()=>dom.settingsOverlay.style.display="none"),dom.openSettingsButton.addEventListener("click",()=>dom.settingsOverlay.style.display="flex"),dom.noteStyleSelector.addEventListener("input",e=>{applyNoteStyle(e.target.value),saveSettings()}),dom.backgroundBrightnessSlider.addEventListener("input",e=>{applyBrightness(e.target.value),saveSettings()}),dom.laneOpacitySlider.addEventListener("input",e=>{applyLaneOpacity(e.target.value),saveSettings()}),dom.laneWidthSlider.addEventListener("input",e=>{applyLaneWidth(e.target.value),saveSettings()}),dom.comboSizeSlider.addEventListener("input",e=>{applyComboSize(e.target.value),saveSettings()}),dom.comboPositionSlider.addEventListener("input",e=>{applyComboPositionY(e.target.value),saveSettings()}),dom.judgmentPositionSlider.addEventListener("input",e=>{applyJudgmentPositionY(e.target.value),saveSettings()}),document.addEventListener("keydown",handleKeydown),document.addEventListener("keyup",handleKeyup)}function initDB(){return new Promise((e,t)=>{const n=indexedDB.open("maniaPlayerDB",1);n.onerror=t=>t("Database error: "+t.target.errorCode),n.onsuccess=t=>{db=t.target.result,e(db)},n.onupgradeneeded=e=>{e.target.result.createObjectStore("beatmaps",{keyPath:"id",autoIncrement:!0})}})}function generateDefaultKeyConfigs(){return{4:["D","F","J","K"],5:["D","F"," ","J","K"],6:["S","D","F","J","K","L"],7:["S","D","F"," ","J","K","L"],8:["A","S","D","F","J","K","L",";"],9:["A","S","D","F"," ","J","K","L",";"],10:["A","S","D","F","G","H","J","K","L",";"]}}function loadSettings(){const e=localStorage.getItem("maniaPlayerSettings"),t=generateDefaultKeyConfigs();if(e){const n=JSON.parse(e);dom.speedSlider.value=n.speed||1.5,dom.offsetInput.value=n.offset||0,dom.autoPlayCheckbox.checked=n.autoPlay||!1,dom.force4kCheckbox.checked=n.force4k||!1,keyConfigs={...t,...n.keyConfigs},n.mods&&(activeMods=n.mods,Object.keys(activeMods).forEach(e=>{const t=dom.modSelectContainer.querySelector(`[data-mod="${e}"]`);t&&t.classList.toggle("active",activeMods[e])})),dom.noteStyleSelector.value=n.noteStyle||"bar",dom.backgroundBrightnessSlider.value=n.brightness||50,dom.laneOpacitySlider.value=n.laneOpacity||50,dom.laneWidthSlider.value=n.laneWidth||100,dom.comboSizeSlider.value=n.comboSize||100,dom.comboPositionSlider.value=n.comboPosition||45,dom.judgmentPositionSlider.value=n.judgmentPosition||65,dom.keyCountSelector.value=n.keyCount||4}else keyConfigs=t;setKeyCount(dom.keyCountSelector.value),updateSpeed(),applyBrightness(dom.backgroundBrightnessSlider.value),applyLaneWidth(dom.laneWidthSlider.value),applyComboSize(dom.comboSizeSlider.value),applyComboPositionY(dom.comboPositionSlider.value),applyJudgmentPositionY(dom.judgmentPositionSlider.value),applyNoteStyle(dom.noteStyleSelector.value)}function saveSettings(){const e={speed:dom.speedSlider.value,offset:dom.offsetInput.value,autoPlay:dom.autoPlayCheckbox.checked,force4k:dom.force4kCheckbox.checked,keyConfigs:keyConfigs,mods:activeMods,noteStyle:dom.noteStyleSelector.value,brightness:dom.backgroundBrightnessSlider.value,laneOpacity:dom.laneOpacitySlider.value,laneWidth:dom.laneWidthSlider.value,comboSize:dom.comboSizeSlider.value,comboPosition:dom.comboPositionSlider.value,judgmentPosition:dom.judgmentPositionSlider.value,keyCount:numLanes};localStorage.setItem("maniaPlayerSettings",JSON.stringify(e))}function saveBeatmapSpecificSettings(){const e=`${currentBeatmapSetId}_${currentBeatmapVersion}`;if(!e)return;let t=JSON.parse(localStorage.getItem("maniaPlayerBeatmapSettings"))||{};t[e]={audioOffset:dom.audioOffsetInput.value,backgroundChoice:dom.backgroundSelector.value},localStorage.setItem("maniaPlayerBeatmapSettings",JSON.stringify(t))}function loadBeatmapSpecificSettings(){const e=`${currentBeatmapSetId}_${currentBeatmapVersion}`;let t=0,n="auto";if(e){const o=JSON.parse(localStorage.getItem("maniaPlayerBeatmapSettings"))||{},a=o[e];"object"==typeof a&&null!==a&&(t=a.audioOffset||0,n=a.backgroundChoice||"auto")}dom.audioOffsetInput.value=t,dom.backgroundSelector.value=n}async function addBeatmapsToDB(e){if(!db)return;const t=db.transaction(["beatmaps"],"readwrite"),n=t.objectStore("beatmaps");for(const o of e)n.add({name:o.name,file:o});t.oncomplete=()=>loadBeatmapsFromDB()}async function loadBeatmapsFromDB(){if(!db)return;db.transaction(["beatmaps"],"readonly").objectStore("beatmaps").getAll().onsuccess=e=>{dom.beatmapLibrarySelector.innerHTML="",e.target.result.forEach(e=>{const t=new Option(e.name,e.id);dom.beatmapLibrarySelector.add(t)})}}async function removeBeatmapFromDB(){if(!db)return;const e=parseInt(dom.beatmapLibrarySelector.value,10);if(isNaN(e))return alert("削除する譜面を選択してください。");db.transaction(["beatmaps"],"readwrite").objectStore("beatmaps").delete(e).onsuccess=()=>{resetBeatmapSelection(),loadBeatmapsFromDB()}}async function getBeatmapRecordFromDB(e){return new Promise((t,n)=>{if(!db)return n("DB not initialized");db.transaction(["beatmaps"],"readonly").objectStore("beatmaps").get(e).onsuccess=e=>t(e.target.result||null)})}async function saveOszFileToPC(){const e=parseInt(dom.beatmapLibrarySelector.value,10);if(isNaN(e))return alert("保存する譜面をライブラリから選択してください。");try{const t=await getBeatmapRecordFromDB(e);if(!t||!t.file)throw new Error("DBから譜面が見つかりません。");const n=URL.createObjectURL(t.file),o=document.createElement("a");o.href=n,o.download=t.name,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}catch(e){alert(`ファイルの保存に失敗しました: ${e.message}`)}}async function handleLibrarySelection(){const e=parseInt(dom.beatmapLibrarySelector.value,10);if(resetBeatmapSelection(),isNaN(e))return;currentBeatmapSetId=e,dom.songTitleElement.textContent="読み込み中...";try{const t=await getBeatmapRecordFromDB(e);if(!t||!t.file)throw new Error("File not found in DB.");const n=new JSZip,o=await n.loadAsync(t.file);currentOszFiles={beatmaps:[],audio:{},video:{},image:{}};const a=[];o.forEach((e,t)=>{const n=e.toLowerCase();n.endsWith(".osu")?a.push(t.async("string").then(t=>currentOszFiles.beatmaps.push({name:e,content:t,type:"osu"}))):n.endsWith(".mc")?a.push(t.async("string").then(t=>currentOszFiles.beatmaps.push({name:e,content:t,type:"malody"}))):n.endsWith(".mp3")||n.endsWith(".ogg")?a.push(t.async("blob").then(e=>currentOszFiles.audio[t.name]=URL.createObjectURL(e))):n.endsWith(".mp4")||n.endsWith(".webm")?a.push(t.async("blob").then(e=>currentOszFiles.video[t.name]=URL.createObjectURL(e))):n.endsWith(".jpg")||n.endsWith(".jpeg")||n.endsWith(".png")?a.push(t.async("blob").then(e=>currentOszFiles.image[t.name]=URL.createObjectURL(e))):null}),await Promise.all(a);if(0===currentOszFiles.beatmaps.length)throw new Error("譜面ファイル (.osu or .mc) が見つかりません。");dom.beatmapSelector.innerHTML='<option value="">-- 難易度を選択 --</option>',currentOszFiles.beatmaps.forEach((e,t)=>{let n=e.name;try{"osu"===e.type?n=`${(a=parseBeatmap(e.content)).version||e.name} [${a.keyCount}K]`:"malody"===e.type&&(n=`${(o=JSON.parse(e.content)).meta.version||e.name} [${(o.meta.mode_ext||o.meta.meta_ext).column||"?"}K Malody]`)}catch(e){}var o,a;dom.beatmapSelector.add(new Option(n,t))}),dom.beatmapSelectorContainer.style.display="block";const i=parseBeatmap(currentOszFiles.beatmaps[0].content);dom.songTitleElement.textContent=i.title||"難易度を選択してください",dom.songArtistElement.textContent=i.artist||"",dom.saveOszButton.disabled=!1}catch(e){alert("譜面の読み込みに失敗しました: "+e.message),resetBeatmapSelection()}}function handleDifficultySelection(){const e=dom.beatmapSelector.value;beatmap=null,audioLoaded=!1,currentBeatmapVersion=null,checkReadyState(),dom.backgroundSelectorContainer.style.display="none",dom.force4kContainer.style.display="none",dom.force4kCheckbox.checked=!1,applyBackgroundChoice();if(""===e)return;const t=currentOszFiles.beatmaps[parseInt(e,10)];if(!t)return;try{if(beatmap="malody"===t.type?parseMalodyBeatmap(t.content):parseBeatmap(t.content),!beatmap)return;updateJudgmentWindows(beatmap.overallDifficulty),beatmap.keyCount>4&&(dom.force4kContainer.style.display="block"),setKeyCount(beatmap.keyCount),dom.keyCountSelector.value=beatmap.keyCount,dom.keyCountSelector.disabled=!0,currentBeatmapVersion=beatmap.version,updateBackgroundSelector(),loadBeatmapSpecificSettings(),applyBackgroundChoice(),dom.songTitleElement.textContent=beatmap.title||"（タイトル不明）",dom.songArtistElement.textContent=beatmap.artist||"（アーティスト不明）";let e=null;const n=Object.keys(currentOszFiles.audio);if(beatmap.audioFilename){const o=beatmap.audioFilename.replace(/\\/g,"/").toLowerCase();for(const a of n)if(a.replace(/\\/g,"/").toLowerCase().endsWith(o)){e=currentOszFiles.audio[a];break}}e||0>=n.length||(e=currentOszFiles.audio[n[0]]),e?loadAudioWithWebAudioAPI(e):alert(`音声ファイル "${beatmap.audioFilename||"指定なし"}" が見つかりません。`)}catch(e){alert("譜面ファイルの解析に失敗しました。"),console.error(e)}finally{checkReadyState()}}function resetBeatmapSelection(){beatmap=null,audioLoaded=!1,audioBuffer=null,currentOszFiles={beatmaps:[],audio:{},video:{},image:{}},dom.beatmapSelectorContainer.style.display="none",dom.beatmapSelector.innerHTML="",dom.backgroundSelectorContainer.style.display="none",dom.force4kContainer.style.display="none",dom.force4kCheckbox.checked=!1,applyBackgroundChoice(),dom.songTitleElement.textContent="譜面を選択してください",dom.songArtistElement.textContent="",dom.saveOszButton.disabled=!0,currentBeatmapSetId=null,currentBeatmapVersion=null,dom.keyCountSelector.disabled=!1,loadBeatmapSpecificSettings(),checkReadyState()}function parseBeatmap(e){const t=e.split("\n").map(e=>e.trim()),n={title:"",artist:"",keyCount:4,hitObjects:[],audioFilename:"",version:"",audioLeadIn:0,videoFilename:"",videoOffset:0,overallDifficulty:8};let o="";for(const a of t){if(a.startsWith("[")){o=a;continue}switch(o){case"[General]":a.startsWith("AudioFilename:")&&(n.audioFilename=a.substring(14).trim()),a.startsWith("AudioLeadIn:")&&(n.audioLeadIn=parseInt(a.substring(12),10)||0);break;case"[Events]":if(a.startsWith("Video,")){const e=a.split(",");e.length>=3&&(n.videoOffset=parseInt(e[1],10)||0,n.videoFilename=e[2].replace(/"/g,""))}break;case"[Metadata]":a.startsWith("Title:")?n.title=a.substring(6).trim():a.startsWith("Artist:")?n.artist=a.substring(7).trim():a.startsWith("Version:")&&(n.version=a.substring(8).trim());break;case"[Difficulty]":a.startsWith("CircleSize:")&&(n.keyCount=parseInt(a.substring(11),10)),a.startsWith("OverallDifficulty:")&&(n.overallDifficulty=parseFloat(a.substring(18)));break;case"[HitObjects]":const e=a.split(",");if(e.length<6)continue;const i=parseInt(e[0],10),s=parseInt(e[2],10),r=parseInt(e[3],10),l=Math.floor(i*n.keyCount/512);if(l<0||l>=n.keyCount)continue;128&r?n.hitObjects.push({time:s,lane:l,type:"long",endTime:parseInt(e[5].split(":")[0],10)}):n.hitObjects.push({time:s,lane:l,type:"note"})}}return n.hitObjects.sort((e,t)=>e.time-t.time),n}function parseMalodyBeatmap(e){try{const t=JSON.parse(e),n=t.meta.mode_ext||t.meta.meta_ext;if(!t.meta||0!==t.meta.mode||!n)return alert("Malody譜面の読み込みに失敗しました。Keyモードの譜面のみ対応しています。"),null;const o={title:t.meta.title||"Unknown Title",artist:t.meta.artist||"Unknown Artist",version:t.meta.version||"Unknown Difficulty",keyCount:n.column,hitObjects:[],audioFilename:(t.meta.audio||"").trim(),audioLeadIn:0,videoFilename:"",videoOffset:0,overallDifficulty:8},a=t.meta.offset||0,i=(t.time||[]).sort((e,t)=>e.beat[0]-t.beat[0]||e.beat[1]-t.beat[1]||e.beat[2]-t.beat[2]);0!==i.length&&0===i[0].beat[0]&&0===i[0].beat[1]||i.unshift({beat:[0,0,4],bpm:120});let s=0,r=0,l=i[0].bpm;for(const c of i){const e=c.beat[0]+c.beat[1]/c.beat[2],t=4*(e-r);s+=t*(6e4/l),c.timeMs=s,r=e,l=c.bpm}const d=e=>{const[t,n,o]=e,a=t+n/o;let s=i[0];for(let e=i.length-1;e>=0;e--){const t=i[e];if(a>=t.beat[0]+t.beat[1]/t.beat[2]){s=t;break}}const r=s.beat[0]+s.beat[1]/s.beat[2],l=4*(a-r),d=l*(6e4/s.bpm);return Math.round(s.timeMs+d+a)};for(const u of t.note||[]){if(void 0===u.column)continue;const e=d(u.beat),t=u.column;u.endbeat?o.hitObjects.push({time:e,lane:t,type:"long",endTime:d(u.endbeat)}):o.hitObjects.push({time:e,lane:t,type:"note"})}return o.hitObjects.sort((e,t)=>e.time-t.time),o}catch(e){return console.error("Malody beatmap parsing failed:",e),alert(`Malody譜面の解析に失敗しました: ${e.message}`),null}}async function loadAudioWithWebAudioAPI(e){audioLoaded=!1,audioContextState.isReady=!1,checkReadyState();try{audioContext||(audioContext=new(window.AudioContext||window.webkitAudioContext));const t=await fetch(e),n=await t.arrayBuffer();audioBuffer=await audioContext.decodeAudioData(n),audioLoaded=!0,audioContextState.isReady=!0}catch(e){console.error("Web Audio APIでの音声デコードに失敗:",e),alert("音声ファイルの読み込みに失敗しました。"),audioLoaded=!1}finally{checkReadyState()}}function playAudio(e=0,t=0){if(!audioContextState.isReady||!audioBuffer)return;audioSourceNode&&audioSourceNode.stop(),(audioSourceNode=audioContext.createBufferSource()).buffer=audioBuffer,audioSourceNode.connect(audioContext.destination),audioSourceNode.playbackRate.value=gameContext.rate;const n=Math.max(0,e),o=Math.max(audioContext.currentTime,t);audioContextState.startedAt=o-n,audioSourceNode.start(o,n)}function getCurrentBeatmapTime(){if(!isGameRunning)return-1/0;if(isPaused)return 1e3*audioContextState.pausedAt-(beatmap.audioLeadIn/gameContext.rate||0)+(parseInt(dom.audioOffsetInput.value,10)||0);if(audioContextState.startedAt>0){return 1e3*(audioContext.currentTime-audioContextState.startedAt)*gameContext.rate-(beatmap.audioLeadIn||0)+(parseInt(dom.audioOffsetInput.value,10)||0)}return(performance.now()-gameContext.visualStartTime-(getFallMs()+200))*gameContext.rate}async function startGame(){if(isGameRunning||!beatmap||!audioLoaded)return;resetGame(),gameContext.rate=1,activeMods.DT&&(gameContext.rate=1.5),activeMods.HT&&(gameContext.rate=.75);const e=beatmap.keyCount,t=dom.force4kCheckbox.checked&&e>4;let n=beatmap.hitObjects.map(e=>({...e,time:Math.round(e.time/gameContext.rate),endTime:e.endTime?Math.round(e.endTime/gameContext.rate):void 0,element:null,spawned:!1,judged:!1,hit:!1,released:!1}));if(t){const o=Math.floor((e-4)/2);n=n.filter(e=>e.lane>=o&&e.lane<o+4).map(e=>({...e,lane:e.lane-o})),setKeyCount(4)}else setKeyCount(e);allNotes=n,allNotes.forEach(e=>{createNoteElement(e),e.element.classList.add("hidden"),dom.lanesContainer.children[e.lane]&&dom.lanesContainer.children[e.lane].appendChild(e.element)}),dom.appContainer.style.display="none",dom.gameContainer.style.display="block",dom.gameContainer.classList.add("playing"),dom.countdownOverlay.style.display="flex";for(let e=3;e>0;e--)dom.countdownText.textContent=e,await new Promise(e=>setTimeout(e,1e3));dom.countdownOverlay.style.display="none",isGameRunning=!0,isAutoPlay=dom.autoPlayCheckbox.checked,gameContext.visualStartTime=performance.now();const o=getFallMs()+200,a=audioContext.currentTime+o/1e3;playAudio(0,a),"none"!==dom.videoBackground.style.display&&(setTimeout(()=>{isGameRunning&&dom.videoBackground.play()},o),dom.videoBackground.currentTime=0,dom.videoBackground.playbackRate=gameContext.rate),animationFrameId=requestAnimationFrame(gameLoop)}function resetGame(){animationFrameId&&cancelAnimationFrame(animationFrameId),score=0,combo=0,maxCombo=0,accuracy=100,totalJudgments=0,weightedAccuracy=0,nextUnjudgedNoteIndex=0,judgmentCounts={"PERFECT+":0,PERFECT:0,GREAT:0,GOOD:0,OK:0,MISS:0},isGameRunning=!1,isPaused=!1,keyState=Array(numLanes).fill(!1),keyJustPressed=Array(numLanes).fill(!1),activeHolds=Array(numLanes).fill(null),dom.scoreElement.textContent=score,dom.accuracyElement.textContent="100.00%",dom.errorBar&&(dom.errorBar.innerHTML=""),dom.lanesContainer.querySelectorAll(".note-wrapper").forEach(e=>e.remove()),dom.keyIndicatorsContainer.childNodes.forEach(e=>e.classList.remove("active")),dom.resultsOverlay.style.display="none",dom.comboContainer.classList.remove("visible"),dom.comboCount.textContent="0",audioSourceNode&&(audioSourceNode.stop(),audioSourceNode=null),audioContextState.pausedAt=0,audioContextState.startedAt=0,drawProgressPie("mania-gameplay-progress-pie",0)}function togglePause(){isGameRunning&&(isPaused=!isPaused,isPaused?(audioSourceNode&&(audioSourceNode.stop(),audioSourceNode=null),audioContextState.pausedAt=audioContext.currentTime-audioContextState.startedAt,"none"!==dom.videoBackground.style.display&&dom.videoBackground.pause(),dom.gameContainer.classList.remove("playing"),dom.pauseOverlay.style.display="flex",selectedPauseIndex=0,updatePauseSelection()):(playAudio(audioContextState.pausedAt,0),"none"!==dom.videoBackground.style.display&&dom.videoBackground.play(),dom.gameContainer.classList.add("playing"),dom.pauseOverlay.style.display="none"))}function retryGame(){resetGame(),startGame()}function returnToControls(){resetGame(),dom.pauseOverlay.style.display="none",dom.gameContainer.classList.remove("playing"),dom.gameContainer.style.display="none",dom.appContainer.style.display="flex",dom.videoBackground.src&&(dom.videoBackground.pause(),dom.videoBackground.currentTime=0)}function showResults(){isGameRunning=!1,dom.gameContainer.classList.remove("playing"),dom.resultsScore.textContent=score,dom.resultsAccuracy.textContent=accuracy.toFixed(2),dom.resultsMaxCombo.textContent=maxCombo;const e=Object.values(judgmentCounts).reduce((e,t)=>e+t,0),t=(t,n,o)=>{const a=judgmentCounts[t];n.textContent=a,o.textContent=`(${(e>0?a/e*100:0).toFixed(2)}%)`};t("PERFECT+",dom.resultsPerfectPlus,dom.resultsPerfectPlusPercent),t("PERFECT",dom.resultsPerfect,dom.resultsPerfectPercent),t("GREAT",dom.resultsGreat,dom.resultsGreatPercent),t("GOOD",dom.resultsGood,dom.resultsGoodPercent),t("OK",dom.resultsOk,dom.resultsOkPercent),t("MISS",dom.resultsMiss,dom.resultsMissPercent);let n="S";accuracy<95&&(n="A"),accuracy<90&&(n="B"),accuracy<80&&(n="C"),accuracy<70&&(n="D"),dom.resultsRankValue&&(dom.resultsRankValue.textContent=n),dom.resultsOverlay.style.display="flex"}function gameLoop(){if(!isGameRunning||isPaused)return animationFrameId=requestAnimationFrame(gameLoop);const e=getCurrentBeatmapTime()/gameContext.rate,t=parseInt(dom.offsetInput.value,10)||0,n=allNotes.length>0?(allNotes[allNotes.length-1].endTime||allNotes[allNotes.length-1].time):1;drawProgressPie("mania-gameplay-progress-pie",e/n),isAutoPlay?autoPlayHandler(e,t):(processHitsInLoop(e,t),updateNoteStates(e,t));const o=getFallMs(),a=dom.gameContainer.clientHeight,i=a*.15,s=(a-i+100)/o;return updateNotePositions(e,t,s,a,i),updateLaneLights(),e>(allNotes.length>0?allNotes[allNotes.length-1].endTime||allNotes[allNotes.length-1].time:0)+3e3?void showResults():void(animationFrameId=requestAnimationFrame(gameLoop))}function updateNoteStates(e,t){for(;nextUnjudgedNoteIndex<allNotes.length;){const n=allNotes[nextUnjudgedNoteIndex];if(n.judged){nextUnjudgedNoteIndex++;continue}if(!(e>n.time+t+JUDGMENT_WINDOWS.MISS))break;handleHit("MISS",n,JUDGMENT_WINDOWS.MISS+1)}for(let n=0;n<activeHolds.length;n++){const o=activeHolds[n];o&&e>o.endTime+t&&judgeRelease(n,{isAutoCompletion:!0})}}function processHitsInLoop(e,t){for(let n=0;n<numLanes;++n)if(keyJustPressed[n]){keyJustPressed[n]=!1;let o=null,a=1/0;for(let i=nextUnjudgedNoteIndex;i<allNotes.length;i++){const s=allNotes[i];if(s.time+t>e+JUDGMENT_WINDOWS.MISS)break;if(s.lane===n&&!s.judged){const t=Math.abs(e-(s.time+t));t<a&&(a=t,o=s)}}o&&a<=JUDGMENT_WINDOWS.MISS&&handleHit(a<=JUDGMENT_WINDOWS.OK?a<=JUDGMENT_WINDOWS.GOOD?a<=JUDGMENT_WINDOWS.GREAT?a<=JUDGMENT_WINDOWS.PERFECT?a<=JUDGMENT_WINDOWS.PERFECT_PLUS?"PERFECT+":"PERFECT":"GREAT":"GOOD":"OK":"MISS",o,e-(o.time+t))}}function autoPlayHandler(e,t){for(const n of allNotes)n.judged||e<n.time+t||handleHit("PERFECT+",n,0),"long"!==n.type||!n.hit||n.released||e<n.endTime+t||judgeRelease(n.lane,{isAutoCompletion:!0})}function handleHit(e,t,n){if(t.judged)return;t.judged=!0,judgmentCounts[e]++,updateAccuracy(e),"MISS"===e?(combo=0,dom.comboContainer.classList.remove("visible")):(score+={ "PERFECT+":300,PERFECT:290,GREAT:200,GOOD:100,OK:50}[e]||0,combo++,t.hit=!0,showHitError(n),showJudgmentTiming(n)),combo>maxCombo&&(maxCombo=combo),combo>2&&(dom.comboContainer.classList.add("visible"),dom.comboCount.textContent=combo,dom.comboCount.classList.remove("combo-anim"),void dom.comboCount.offsetWidth,dom.comboCount.classList.add("combo-anim")),showJudgment(e),"note"===t.type?t.element&&t.element.classList.add("hidden"):"long"===t.type&&("MISS"!==e?(activeHolds[t.lane]=t,t.tickInterval=setInterval(()=>{score+=10,dom.scoreElement.textContent=score},100)):t.element&&t.element.classList.add("hidden")),dom.scoreElement.textContent=score}function judgeRelease(e,{isAutoCompletion:t}={}){const n=activeHolds[e];if(!n)return;const o=()=>{clearInterval(n.tickInterval),n.tickInterval=null,activeHolds[e]=null,n.released=!0,n.element&&n.element.classList.add("hidden"),dom.scoreElement.textContent=score};if(t)return showJudgment("PERFECT+"),updateAccuracy("PERFECT+"),score+=300,judgmentCounts["PERFECT+"]++,void o();const a=parseInt(dom.offsetInput.value,10)||0,i=getCurrentBeatmapTime()/gameContext.rate-(n.endTime+a);i>=-JUDGMENT_WINDOWS.GOOD?(showJudgment("PERFECT+"),updateAccuracy("PERFECT+"),score+=300,judgmentCounts["PERFECT+"]++):(combo=0,dom.comboContainer.classList.remove("visible"),showJudgment("MISS"),updateAccuracy("MISS"),judgmentCounts.MISS++),o()}function updateAccuracy(e){totalJudgments++;const t={"PERFECT+":300,PERFECT:290,GREAT:200,GOOD:100,OK:50,MISS:0};weightedAccuracy+=t[e]||0,accuracy=weightedAccuracy/(300*totalJudgments)*100,dom.accuracyElement.textContent=accuracy.toFixed(2)+"%"}function updateJudgmentWindows(e){const t=3*e;JUDGMENT_WINDOWS={PERFECT_PLUS:16,PERFECT:64-t,GREAT:97-t,GOOD:127-t,OK:151-t,MISS:188-t}}function createNoteElement(e){const t=document.createElement("div");t.className="note-wrapper";const n=document.createElement("div");if(n.className="note","long"===e.type){const e=document.createElement("div");e.className="long-note-body",t.appendChild(e)}t.appendChild(n),e.element=t}function updateNotePositions(e,t,n,o,a){const i=dom.playfield.classList.contains("note-style-circle"),s=i?70:22,r=s/2;for(const l of allNotes){if(l.judged&&"note"===l.type||l.released)continue;let d=o-a-(l.time+t-e)*n;l.spawned||d<=-s||(l.spawned=!0,l.element.classList.remove("hidden"));if(!l.element)continue;activeMods.HD&&(l.element.style.opacity=d>.4*o?1-Math.max(0,Math.min(1,(d-.4*o)/(.35*o))):1),"long"===l.type&&l.hit&&(d=o-a,(c=l.element.querySelector(".note"))&&(c.style.display="none")),l.element.style.transform=`translateY(${d-r}px)`;var c;"long"===l.type&&((c=l.element.querySelector(".long-note-body"))&&(u=o-a-((l.endTime+t-e)*n),c.style.top=`${u-d}px`,c.style.height=`${Math.max(0,d+r-u)}px`));var u;d>o+50&&(l.element&&l.element.classList.add("hidden"),l.judged=!0,l.released=!0)}}function initGameUI(){dom.lanesContainer.innerHTML="",dom.keyIndicatorsContainer.innerHTML="";for(let e=0;e<numLanes;e++){const t=document.createElement("div");t.classList.add("lane"),t.dataset.laneIndex=e,dom.lanesContainer.appendChild(t);const n=e=>(t=>{if(t.preventDefault(),!isGameRunning||isPaused||isAutoPlay)return;const n=parseInt(t.currentTarget.dataset.laneIndex,10);e?(keyState[n]||(keyState[n]=!0,keyJustPressed[n]=!0)):(keyState[n]=!1,judgeRelease(n))});t.addEventListener("touchstart",n(!0),{passive:!1}),t.addEventListener("touchend",n(!1)),t.addEventListener("touchcancel",n(!1));const o=document.createElement("div");o.classList.add("key"),dom.keyIndicatorsContainer.appendChild(o)}updateKeyIndicators()}function setKeyCount(e){numLanes=parseInt(e,10),root.style.setProperty("--num-lanes",numLanes),activeKeys=keyConfigs[numLanes],initKeyConfig(),initGameUI()}function updateKeyIndicators(){const e=keyConfigs[numLanes]||[];dom.keyConfigInputsContainer.childNodes.forEach((t,n)=>{e[n]&&(t.textContent=e[n])}),dom.keyIndicatorsContainer&&dom.keyIndicatorsContainer.childNodes.forEach((t,n)=>{e[n]&&(t.textContent=e[n])})}function updateLaneLights(){for(let e=0;e<numLanes;e++)dom.keyIndicatorsContainer.children[e]&&dom.keyIndicatorsContainer.children[e].classList.toggle("active",keyState[e])}function showJudgment(e){const t=dom.judgmentTextElement,n={"PERFECT+":{color:"#FFD700"},PERFECT:{color:"#4CAF50"},GREAT:{color:"#2196F3"},GOOD:{color:"#FFC107"},OK:{color:"#dda0dd"},MISS:{color:"#F44336"}};t.textContent=e,t.style.color=n[e]?.color||"white",t.style.animation="none",void t.offsetHeight,t.style.animation=null}function showJudgmentTiming(e){const t=dom.judgmentTimingTextElement;t.textContent=e<-5?"Early":e>5?"Late":"",t.style.animation="none",void t.offsetHeight,t.style.animation=null}function showHitError(e){if(!dom.errorBar)return;const t=document.createElement("div");t.className="error-tick";const n=(e+JUDGMENT_WINDOWS.MISS)/(2*JUDGMENT_WINDOWS.MISS)*100;t.style.left=`${Math.max(0,Math.min(100,n))}%`,dom.errorBar.appendChild(t),setTimeout(()=>t.remove(),1500)}function handleKeydown(e){if("mania"===activeGame&&!e.repeat){const t=document.activeElement,n=t&&("INPUT"===t.tagName||"SELECT"===t.tagName);if(!n){if(isPaused){const t=dom.pauseOverlay.querySelectorAll(".overlay-button");if(0!==t.length)return"ArrowUp"===e.key?(e.preventDefault(),selectedPauseIndex=(selectedPauseIndex-1+t.length)%t.length,void updatePauseSelection()):"ArrowDown"===e.key?(e.preventDefault(),selectedPauseIndex=(selectedPauseIndex+1)%t.length,void updatePauseSelection()):void("Enter"===e.key&&(e.preventDefault(),t[selectedPauseIndex].click()))}if(!isGameRunning||isAutoPlay){const t=activeKeys.indexOf(e.key.toUpperCase());-1!==t&&(e.preventDefault(),keyState[t]||(keyState[t]=!0,keyJustPressed[t]=!0))}}}}function handleKeyup(e){if("mania"===activeGame&&isGameRunning&&!isPaused&&!isAutoPlay){const t=activeKeys.indexOf(e.key.toUpperCase());-1!==t&&(keyState[t]=!1,judgeRelease(t))}}function applyBrightness(e){root.style.setProperty("--background-brightness",e/100),dom.brightnessValue&&(dom.brightnessValue.textContent=e)}function applyLaneWidth(e){const t=e/100;root.style.setProperty("--lane-width-scale",t),root.style.setProperty("--note-height",22*t+"px"),root.style.setProperty("--receptor-size",70*t+"px"),dom.laneWidthValue&&(dom.laneWidthValue.textContent=e)}function applyLaneOpacity(e){const t="circle"===dom.noteStyleSelector.value?"--playfield-bg-opacity":"--lane-opacity";root.style.setProperty(t,e/100),dom.laneOpacityValue&&(dom.laneOpacityValue.textContent=e)}function applyComboSize(e){root.style.setProperty("--combo-size-scale",e/100),dom.comboSizeValue&&(dom.comboSizeValue.textContent=e)}function applyComboPositionY(e){root.style.setProperty("--combo-position-y",e+"%"),dom.comboPositionValue&&(dom.comboPositionValue.textContent=e)}function applyJudgmentPositionY(e){root.style.setProperty("--judgment-text-top",e+"vh"),dom.judgmentPositionValue&&(dom.judgmentPositionValue.textContent=e)}function applyNoteStyle(e){dom.playfield.classList.toggle("note-style-circle","circle"===e),updateOpacitySliderLabel(),applyLaneOpacity(dom.laneOpacitySlider.value)}function updateSpeed(){dom.speedLabel.textContent=`ノーツ速度 (x${parseFloat(dom.speedSlider.value).toFixed(1)})`}function getFallMs(){return 1200/parseFloat(dom.speedSlider.value)}function updatePauseSelection(){dom.pauseOverlay.querySelectorAll(".overlay-button").forEach((e,t)=>e.classList.toggle("selected",t===selectedPauseIndex))}function checkReadyState(){dom.startButton.disabled=!(beatmap&&audioLoaded)}function setupMods(){dom.modSelectContainer.addEventListener("click",e=>{const t=e.target.closest(".mod-button");if(!t)return;const n=t.dataset.mod;activeMods[n]=!activeMods[n],t.classList.toggle("active",activeMods[n]),"HT"===n&&activeMods.HT&&(activeMods.DT=!1,dom.modSelectContainer.querySelector('[data-mod="DT"]').classList.remove("active")),"DT"===n&&activeMods.DT&&(activeMods.HT=!1,dom.modSelectContainer.querySelector('[data-mod="HT"]').classList.remove("active")),saveSettings()})}function updateOpacitySliderLabel(){dom.laneOpacityLabel.firstChild.textContent="circle"===dom.noteStyleSelector.value?"プレイエリアの不透明度: ":"レーンの不透明度: "}function initKeyConfig(){dom.keyConfigInputsContainer.innerHTML="";const e=keyConfigs[numLanes]||[];for(let t=0;t<numLanes;t++){const n=document.createElement("div");n.className="key-config-input",n.textContent=e[t]||"...",n.dataset.laneIndex=t,n.tabIndex=0,n.addEventListener("click",e=>{isGameRunning||(root.querySelectorAll(".key-config-input.is-waiting").forEach(e=>e.blur()),e.currentTarget.textContent="...",e.currentTarget.classList.add("is-waiting"))}),n.addEventListener("blur",t=>{t.currentTarget.classList.remove("is-waiting"),t.currentTarget.textContent=e[t.currentTarget.dataset.laneIndex]}),n.addEventListener("keydown",t=>{if(t.preventDefault(),!t.currentTarget.classList.contains("is-waiting"))return;if("Escape"===t.key)return void t.currentTarget.blur();const n=t.key.toUpperCase();if(1!==n.length&&" "!==n)return;const o=parseInt(t.currentTarget.dataset.laneIndex,10);if(e.some((e,t)=>e===n&&t!==o))return void alert("そのキーは他のレーンで既に使用されています。");e[o]=n,t.currentTarget.blur(),updateKeyIndicators(),saveSettings()}),dom.keyConfigInputsContainer.appendChild(n)}}function updateBackgroundSelector(){const e=Object.keys(currentOszFiles.video).length>0,t=Object.keys(currentOszFiles.image).length>0;dom.backgroundSelector.innerHTML="",e||t?(dom.backgroundSelector.add(new Option("自動","auto")),e&&dom.backgroundSelector.add(new Option("動画","video")),t&&dom.backgroundSelector.add(new Option("画像","image")),dom.backgroundSelector.add(new Option("なし","none")),dom.backgroundSelectorContainer.style.display="block"):dom.backgroundSelectorContainer.style.display="none"}function applyBackgroundChoice(){const e=dom.backgroundSelector.value,t=Object.values(currentOszFiles.video)[0],n=Object.values(currentOszFiles.image)[0];let o;dom.videoBackground.style.display="none",dom.imageBackground.style.display="none",o="auto"===e?t?"video":n?"image":"none":e,"video"===o&&t?(dom.videoBackground.src=t,dom.videoBackground.style.display="block"):"image"===o&&n&&(dom.imageBackground.src=n,dom.imageBackground.style.display="block")}return{initialize:initialize,togglePauseExternal:togglePause,retryGameExternal:function(){(isGameRunning||isPaused||"flex"===dom.resultsOverlay.style.display)&&retryGame()},returnToControlsExternal:function(){(isGameRunning||isPaused||"flex"===dom.resultsOverlay.style.display)&&returnToControls()}}})();

    // --- osu!taiko Game Logic (Scoped) ---
    const TaikoGame = (() => {
        const root = document.getElementById('taiko-wrapper');
        const dom = {
            appContainer: root.querySelector('#app-container'),
            gameContainer: root.querySelector('#taiko-game-container'),
            oszFileInput: root.querySelector('#taiko-osz-file'),
            oszFileLabel: root.querySelector('#osz-file-label'),
            beatmapSelectorContainer: root.querySelector('#taiko-beatmap-selector-container'),
            beatmapSelector: root.querySelector('#taiko-beatmap-selector'),
            songTitleElement: root.querySelector('#taiko-song-title'),
            songArtistElement: root.querySelector('#taiko-song-artist'),
            donSoundFileInput: root.querySelector('#don-sound-file'),
            katsuSoundFileInput: root.querySelector('#katsu-sound-file'),
            speedSlider: root.querySelector('#taiko-speed-slider'),
            speedLabel: root.querySelector('#taiko-speed-label'),
            offsetInput: root.querySelector('#taiko-offset-input'),
            individualOffsetInput: root.querySelector('#taiko-individual-offset-input'),
            videoOffsetInput: root.querySelector('#video-offset-input'),
            seOffsetInput: root.querySelector('#se-offset-input'),
            autoPlayCheckbox: root.querySelector('#taiko-auto-play-checkbox'),
            singleHandBigNoteCheckbox: root.querySelector('#single-hand-big-note-checkbox'),
            autoSeCheckbox: root.querySelector('#auto-se-checkbox'),
            keyConfigInputs: root.querySelector('#taiko-key-config-inputs'),
            startButton: root.querySelector('#taiko-start-button'),
            saveSongToPcButton: root.querySelector('#save-song-to-pc-button'),
            backgroundVideo: root.querySelector('#taiko-background-video'),
            backgroundImage: root.querySelector('#taiko-background-image'),
            playfield: root.querySelector('#taiko-playfield'),
            canvas: root.querySelector('#game-canvas'),
            ctx: root.querySelector('#game-canvas').getContext('2d'),
            scoreElement: root.querySelector('#taiko-score'),
            accuracyElement: root.querySelector('#taiko-accuracy'),
            comboElement: root.querySelector('#combo'),
            comboDisplay: root.querySelector('#combo-display'),
            rollCounterDisplay: root.querySelector('#roll-counter-display'),
            judgmentTextElement: root.querySelector('#taiko-judgment-text'),
            pauseOverlay: root.querySelector('#taiko-pause-overlay'),
            resumeButton: root.querySelector('#taiko-resume-button'),
            retryButton: root.querySelector('#taiko-retry-button'),
            backToTitlePause: root.querySelector('#back-to-title-button-pause'),
            backToTitleResults: root.querySelector('#back-to-title-button-results'),
            switchToManiaButton: root.querySelector('#switch-to-mania-button'),
            resultsOverlay: root.querySelector('#taiko-results-overlay'),
            resultsSongTitle: root.querySelector('#results-song-title'),
            resultsScoreValue: root.querySelector('#taiko-results-score-value'),
            resultsRankValue: root.querySelector('#results-rank-value'),
            resultsMaxComboValue: root.querySelector('#taiko-results-max-combo-value'),
            resultsRyoValue: root.querySelector('#results-ryo-value'),
            resultsKaValue: root.querySelector('#results-ka-value'),
            resultsFukaValue: root.querySelector('#results-fuka-value'),
            resultsRetryButton: root.querySelector('#taiko-results-retry-button'),
            audioPlayer: root.querySelector('#audio-player'),
            drumDonLeft: root.querySelector('#drum-don-left'),
            drumDonRight: root.querySelector('#drum-don-right'),
            drumKatsuLeft: root.querySelector('#drum-katsu-left'),
            drumKatsuRight: root.querySelector('#drum-katsu-right'),
            savedSongsList: root.querySelector('#saved-songs-list'),
            deleteSongButton: root.querySelector('#delete-song-button'),
            songSearchInput: root.querySelector('#song-search-input'),
            errorBar: root.querySelector('#taiko-error-bar'),
            openTaikoSettingsButton: root.querySelector('#open-taiko-settings-button'),
            taikoSettingsOverlay: root.querySelector('#taiko-settings-overlay'),
            laneOpacitySlider: root.querySelector('#taiko-lane-opacity-slider'),
            laneOpacityLabel: root.querySelector('#taiko-lane-opacity-label'),
            bgBrightnessSlider: root.querySelector('#bg-brightness-slider'),
            bgBrightnessLabel: root.querySelector('#bg-brightness-label'),
            laneCoverSlider: root.querySelector('#lane-cover-slider'),
            laneCoverLabel: root.querySelector('#lane-cover-label'),
            backgroundSelectWrapper: root.querySelector('#background-select-wrapper'),
            backgroundSelect: root.querySelector('#background-select'),
        };
        const db = { _db: null, DB_NAME: 'TaikoPlayerDB', STORE_NAME: 'songs', init() { return new Promise((resolve, reject) => { const request = indexedDB.open(this.DB_NAME, 1); request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains(this.STORE_NAME)) { db.createObjectStore(this.STORE_NAME, { keyPath: 'id' }); } }; request.onsuccess = (event) => { this._db = event.target.result; resolve(); }; request.onerror = (event) => { console.error('Database error:', event.target.errorCode); reject(event.target.errorCode); }; }); }, addSong(songData) { return new Promise((resolve, reject) => { const transaction = this._db.transaction([this.STORE_NAME], 'readwrite'); const store = transaction.objectStore(this.STORE_NAME); const request = store.add(songData); request.onsuccess = () => resolve(); request.onerror = (event) => reject(event.target.error); }); }, getSongsMeta() { return new Promise((resolve, reject) => { const transaction = this._db.transaction([this.STORE_NAME], 'readonly'); const store = transaction.objectStore(this.STORE_NAME); const request = store.getAll(); request.onsuccess = (event) => { const songs = event.target.result.map(({ id, title, artist }) => ({ id, title, artist })); resolve(songs); }; request.onerror = (event) => reject(event.target.error); }); }, getSongBlob(id) { return new Promise((resolve, reject) => { const transaction = this._db.transaction([this.STORE_NAME], 'readonly'); const store = transaction.objectStore(this.STORE_NAME); const request = store.get(id); request.onsuccess = (event) => { if (event.target.result) { resolve(event.target.result.blob); } else { reject('Song not found'); } }; request.onerror = (event) => reject(event.target.error); }); }, deleteSong(id) { return new Promise((resolve, reject) => { const transaction = this._db.transaction([this.STORE_NAME], 'readwrite'); const store = transaction.objectStore(this.STORE_NAME); const request = store.delete(id); request.onsuccess = () => resolve(); request.onerror = (event) => reject(event.target.error); }); } };
        let laneSizeScale = 1.0;
        let KEYS = { don_left: 'D', don_right: 'K', katsu_left: 'S', katsu_right: 'L' };
        const BASE_SCROLL_SPEED = 6;
        let uiScrollSpeed = BASE_SCROLL_SPEED;
        const HIT_WINDOW_PERFECT = 25, HIT_WINDOW_GOOD = 70, HIT_WINDOW_BAD = 100;
        const EARLY_MISS_WINDOW = 100;
        let JUDGE_POINT_X = 390;
        let audioContext;
        let donSoundBuffer = null, katsuSoundBuffer = null;
        let fileContent = null, audioSrc = null;
        let songInfo = { title: '', artist: '', version: '', audioFilename: '' };
        let hitObjects = [], barLines = [], goGoSections = [];
        let audioLoaded = false, beatmapLoaded = false;
        let isGameRunning = false, isPaused = false, isAutoPlay = false, isAutoSE = false;
        let pausedTime = 0;
        let isSingleHandBigNoteEnabled = true;
        let score = 0, combo = 0, offset = 0, maxCombo = 0, accuracy = 100;
        let judgmentCounts = { ryo: 0, ka: 0, fuka: 0 };
        let animationFrameId = null;
        let lastNoteTime = 0;
        let gameStartTime = 0;
        let pauseStartTime = 0;
        let totalPauseDuration = 0;
        let selectedPauseIndex = 0;
        let pressedKeys = new Set();
        let osz_zip = null;
        let osz_beatmaps = [];
        let availableBackgrounds = { video: null, image: null };
        let selectedBackgroundType = 'none';
        let lastCheckedNoteIndex = 0;
        let lastAutoSEIndex = 0;
        let activeRollHits = 0;
        let rollCounterClearTime = 0;
        let isGoGoNow = false;
        let drumHitTimeouts = {};
        const SETTINGS_KEY = 'taikoPlayerSettings';
        let laneCoverPercentage = 0;
        let isPauseButtonCoolingDown = false;
        let isInitialCooldown = false;
        let autoPlayHitCounter = 0;
        let currentSongId = null;

        function initAudioContext() { if (!audioContext) { try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (audioContext.state === 'suspended') { audioContext.resume(); } } catch (e) { console.error("Web Audio API is not supported in this browser"); } } document.body.removeEventListener('click', initAudioContext, true); document.body.removeEventListener('keydown', initAudioContext, true); }
        document.body.addEventListener('click', initAudioContext, true);
        document.body.addEventListener('keydown', initAudioContext, true);
        
        function saveSettings() {
            try {
                const settings = {
                    offset: dom.offsetInput.value,
                    videoOffset: dom.videoOffsetInput.value,
                    seOffset: dom.seOffsetInput.value,
                    keys: KEYS,
                    autoPlay: dom.autoPlayCheckbox.checked,
                    singleHandBigNote: dom.singleHandBigNoteCheckbox.checked,
                    autoSE: dom.autoSeCheckbox.checked,
                    laneOpacity: dom.laneOpacitySlider.value,
                    bgBrightness: dom.bgBrightnessSlider.value,
                    laneCover: dom.laneCoverSlider.value
                };
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            } catch (e) { console.error("Failed to save settings:", e); }
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (!savedSettings) return;
            try {
                const settings = JSON.parse(savedSettings);
                if (settings.offset !== undefined) dom.offsetInput.value = settings.offset;
                if (settings.videoOffset !== undefined) dom.videoOffsetInput.value = settings.videoOffset;
                if (settings.seOffset !== undefined) dom.seOffsetInput.value = settings.seOffset;
                if (settings.keys) { KEYS = settings.keys; for (const keyId in KEYS) { const el = root.querySelector(`#key-${keyId.replace('_', '-')}`); if (el) el.textContent = KEYS[keyId]; } }
                if (settings.autoPlay !== undefined) dom.autoPlayCheckbox.checked = settings.autoPlay;
                if (settings.singleHandBigNote !== undefined) dom.singleHandBigNoteCheckbox.checked = settings.singleHandBigNote;
                if (settings.autoSE !== undefined) dom.autoSeCheckbox.checked = settings.autoSE;
                if (settings.laneOpacity !== undefined) dom.laneOpacitySlider.value = settings.laneOpacity;
                if (settings.bgBrightness !== undefined) dom.bgBrightnessSlider.value = settings.bgBrightness;
                if (settings.laneCover !== undefined) dom.laneCoverSlider.value = settings.laneCover;
            } catch (e) { console.error("Failed to load settings:", e); localStorage.removeItem(SETTINGS_KEY); }
        }

        // (The rest of the TaikoGame code, but with laneSize related logic removed)
        // ...
        function getTaikoBeatmapSettingsKey() { if (currentSongId && songInfo && songInfo.version) { const sanitizedVersion = songInfo.version.replace(/[^a-zA-Z0-9-_]/g, ''); return `taiko_${currentSongId}_${sanitizedVersion}`; } return null; }
        function saveTaikoBeatmapSpecificSettings() { const key = getTaikoBeatmapSettingsKey(); if (!key) return; let settings = JSON.parse(localStorage.getItem('taikoPlayerBeatmapSettings')) || {}; settings[key] = { individualOffset: dom.individualOffsetInput.value, speed: dom.speedSlider.value, backgroundChoice: dom.backgroundSelect.value }; localStorage.setItem('taikoPlayerBeatmapSettings', JSON.stringify(settings)); }
        function loadTaikoBeatmapSpecificSettings() { const key = getTaikoBeatmapSettingsKey(); let individualOffset = 0, speed = 0, backgroundChoice = 'video'; if (key) { const settings = JSON.parse(localStorage.getItem('taikoPlayerBeatmapSettings')) || {}; const saved = settings[key]; if (typeof saved === 'object' && saved !== null) { individualOffset = saved.individualOffset || 0; if (saved.speed !== undefined && saved.speed !== null) speed = saved.speed; backgroundChoice = saved.backgroundChoice || 'video'; } } dom.individualOffsetInput.value = individualOffset; dom.speedSlider.value = speed; updateSpeed(); if (dom.backgroundSelectWrapper.style.display === 'block') { dom.backgroundSelect.value = backgroundChoice; selectedBackgroundType = backgroundChoice; } }
        function parseOsuFile(content) { try { hitObjects = []; barLines = []; goGoSections = []; songInfo = { title: '', artist: '', version: '', audioFilename: '' }; let uninheritedTimingPoints = [], velocityChanges = [], allTimingPoints = []; const lines = content.split('\n').map(l => l.trim()); let section = '', sliderMultiplier = 1.4, gameMode = -1; for (const line of lines) { if (line.startsWith('[')) { section = line.toLowerCase(); continue; } if (!section) continue; const lowerLine = line.toLowerCase(); if (section === '[general]' && lowerLine.startsWith('mode:')) gameMode = parseInt(line.split(':')[1].trim(), 10); else if (section === '[general]' && lowerLine.startsWith('audiofilename:')) songInfo.audioFilename = line.substring(line.indexOf(':') + 1).trim(); else if (section === '[metadata]') { if (lowerLine.startsWith('title:')) songInfo.title = line.substring(line.indexOf(':') + 1).trim(); else if (lowerLine.startsWith('artist:')) songInfo.artist = line.substring(line.indexOf(':') + 1).trim(); else if (lowerLine.startsWith('version:')) songInfo.version = line.substring(line.indexOf(':') + 1).trim(); } else if (section === '[difficulty]') { if (lowerLine.startsWith('slidermultiplier:')) sliderMultiplier = parseFloat(line.split(':')[1]); } else if (section === '[timingpoints]') { const parts = line.split(','); if (parts.length < 2) continue; const time = parseFloat(parts[0]), val = parseFloat(parts[1]), meter = parts.length > 2 ? parseInt(parts[2], 10) : 4, kiai = parts.length > 7 ? (parseInt(parts[7], 10) & 1) !== 0 : false; allTimingPoints.push({ time, kiai }); if (val > 0) uninheritedTimingPoints.push({ time, beatLength: val, meter }); else if (val < 0) velocityChanges.push({ time, multiplier: -100 / val }); } } if (gameMode !== 1) { console.warn(`Unsupported game mode: ${gameMode}. Only Taiko (mode 1) is supported.`); return false; } if (uninheritedTimingPoints.length === 0) uninheritedTimingPoints.push({ time: 0, beatLength: 500, meter: 4 }); velocityChanges.sort((a, b) => a.time - b.time); const getScrollMultiplier = time => { for (let i = velocityChanges.length - 1; i >= 0; i--) if (velocityChanges[i].time <= time) return velocityChanges[i].multiplier; return 1.0; }; section = ''; for (const line of lines) { if (line.startsWith('[')) { section = line.toLowerCase(); continue; } if (section !== '[hitobjects]') continue; const parts = line.split(','), time = parseInt(parts[2], 10), type = parseInt(parts[3], 10), hitSound = parseInt(parts[4], 10), isBig = (hitSound & 4) !== 0, scrollMultiplier = getScrollMultiplier(time), noteProps = { time, judged: false, scrollSpeed: scrollMultiplier, sePlayed: false }; if (type & 2) { const parentTimingPoint = uninheritedTimingPoints.findLast(p => p.time <= time) || uninheritedTimingPoints[0], pixelLength = parseFloat(parts[7]), duration = pixelLength / (sliderMultiplier * scrollMultiplier * 100) * parentTimingPoint.beatLength; hitObjects.push({ ...noteProps, type: 'roll', isBig, endTime: time + duration, lastAutoHitTime: 0, hitsMade: 0 }); } else if (type & 8) { const endTime = parseInt(parts[5], 10), duration = endTime - time, hitsRequired = Math.max(3, Math.ceil(duration / 200)); hitObjects.push({ ...noteProps, type: 'balloon', endTime, hitsRequired, hitsMade: 0, lastAutoHitTime: 0 }); } else if (type & 1) { let noteType = 'don'; if ((hitSound & 2) || (hitSound & 8)) noteType = 'katsu'; hitObjects.push({ ...noteProps, type: noteType, isBig }); } } allTimingPoints.sort((a, b) => a.time - b.time); let kiaiActive = false, kiaiStartTime = 0; const currentLastNoteTime = hitObjects.reduce((max, note) => Math.max(max, note.endTime || note.time), 0); for (const point of allTimingPoints) { if (point.kiai && !kiaiActive) { kiaiActive = true; kiaiStartTime = point.time; } else if (!point.kiai && kiaiActive) { kiaiActive = false; goGoSections.push({ start: kiaiStartTime, end: point.time }); } } if (kiaiActive) goGoSections.push({ start: kiaiStartTime, end: currentLastNoteTime + 5000 }); if (uninheritedTimingPoints.length > 0 && hitObjects.length > 0) for (let i = 0; i < uninheritedTimingPoints.length; i++) { const currentPoint = uninheritedTimingPoints[i], measureLength = currentPoint.beatLength * currentPoint.meter; if (measureLength <= 0) continue; const barEndTime = (i + 1 < uninheritedTimingPoints.length) ? uninheritedTimingPoints[i + 1].time : currentLastNoteTime + 2000; for (let t = currentPoint.time; t < barEndTime; t += measureLength) barLines.push({ time: t, scrollSpeed: getScrollMultiplier(t) }); } hitObjects.sort((a, b) => a.time - b.time); lastNoteTime = hitObjects.length > 0 ? (hitObjects[hitObjects.length - 1].endTime || hitObjects[hitObjects.length - 1].time) : 1; return hitObjects.length > 0; } catch (error) { console.error("Error during .osu parsing:", error); alert("譜面の解析に失敗しました。"); return false; } }
        function setupFileListeners() { dom.oszFileInput.addEventListener('change', handleNewFiles); dom.oszFileLabel.addEventListener('click', () => isRequestingFile = true); dom.donSoundFileInput.addEventListener('change', e => { isRequestingFile = true; loadAndDecodeSound(e.target.files[0], true); }); dom.katsuSoundFileInput.addEventListener('change', e => { isRequestingFile = true; loadAndDecodeSound(e.target.files[0], false); }); dom.beatmapSelector.addEventListener('change', handleBeatmapSelection); dom.savedSongsList.addEventListener('change', handleSavedSongSelect); dom.deleteSongButton.addEventListener('click', handleDeleteSong); dom.songSearchInput.addEventListener('input', handleSongSearch); }
        async function loadSavedSongsList() { try { const songsMeta = await db.getSongsMeta(); dom.savedSongsList.innerHTML = '<option value="">-- 保存済み譜面を選択 --</option>'; songsMeta.sort((a, b) => `${a.artist} - ${a.title}`.localeCompare(`${b.artist} - ${b.title}`)).forEach(meta => { const option = document.createElement('option'); option.value = meta.id; option.textContent = `${meta.artist} - ${meta.title}`; dom.savedSongsList.appendChild(option); }); handleSongSearch(); } catch (e) { console.error('Failed to load saved songs list:', e); } }
        function handleSongSearch() { const searchTerm = dom.songSearchInput.value.toLowerCase(); for (const option of dom.savedSongsList.options) { if (option.value === "") continue; option.style.display = option.textContent.toLowerCase().includes(searchTerm) ? '' : 'none'; } }
        async function handleSavedSongSelect(e) { const songId = e.target.value; currentSongId = songId; dom.saveSongToPcButton.disabled = !songId; if (!songId) { resetGameAndFiles(false); return; } try { dom.beatmapSelectorContainer.style.display = 'none'; dom.songTitleElement.textContent = '読み込み中...'; const blob = await db.getSongBlob(songId); await processOszBlob(blob); } catch (e) { alert('保存済み譜面の読み込みに失敗しました。'); console.error(e); } }
        async function handleDeleteSong() { const songId = dom.savedSongsList.value; if (!songId) return alert('削除する譜面を選択してください。'); if (confirm(`「${dom.savedSongsList.options[dom.savedSongsList.selectedIndex].text}」を削除しますか？`)) try { await db.deleteSong(songId); await loadSavedSongsList(); resetGameAndFiles(true); alert('譜面を削除しました。'); } catch (e) { alert('譜面の削除に失敗しました。'); console.error(e); } }
        function loadAndDecodeSound(file, isDon) { if (!file || !audioContext) return; const reader = new FileReader(); reader.onload = e => { audioContext.decodeAudioData(e.target.result, buffer => { if (isDon) donSoundBuffer = buffer; else katsuSoundBuffer = buffer; }, error => { console.error(`Error decoding audio data for ${isDon ? 'Don' : 'Katsu'}:`, error); alert("サウンドファイルのデコードに失敗しました。"); }); }; reader.onerror = () => alert("サウンドファイルの読み込みに失敗しました。"); reader.readAsArrayBuffer(file); }
        async function handleNewFiles(e) { const files = e.target.files; if (!files || files.length === 0) return; dom.oszFileLabel.classList.add('is-loading'); dom.oszFileInput.disabled = true; let successCount = 0, errorCount = 0; for (let i = 0; i < files.length; i++) { const file = files[i]; dom.songTitleElement.textContent = `処理中 (${i + 1}/${files.length})...`; dom.songArtistElement.textContent = file.name; if (!file.name.toLowerCase().endsWith('.osz')) { console.warn(`Skipping non-osz file: ${file.name}`); errorCount++; continue; } try { const loadedZip = await new JSZip().loadAsync(file), osuFiles = []; loadedZip.forEach((relativePath, zipEntry) => { if (relativePath.toLowerCase().endsWith('.osu')) osuFiles.push(zipEntry); }); if (osuFiles.length === 0) { console.warn(`Skipping osz without .osu file: ${file.name}`); errorCount++; continue; } let firstTaikoOsuContent = null; for (const osuFile of osuFiles) { const content = await osuFile.async('string'); let isTaikoMode = false; for (const line of content.split('\n')) { const trimmed = line.trim().toLowerCase(); if (trimmed.startsWith('mode:') && trimmed.includes('1')) { isTaikoMode = true; break; } } if (isTaikoMode) { firstTaikoOsuContent = content; break; } } if (!firstTaikoOsuContent) { console.warn(`Skipping osz without Taiko-mode beatmap: ${file.name}`); errorCount++; continue; } const tempInfo = { title: 'Unknown', artist: 'Unknown' }; for (const line of firstTaikoOsuContent.split('\n')) { const trimmedLine = line.trim().toLowerCase(); if (trimmedLine.startsWith('title:')) tempInfo.title = line.substring(6).trim(); else if (trimmedLine.startsWith('artist:')) tempInfo.artist = line.substring(7).trim(); } await db.addSong({ id: `${Date.now()}-${file.name}`, title: tempInfo.title, artist: tempInfo.artist, blob: file }); successCount++; } catch (err) { console.error(`Failed to process file ${file.name}:`, err); errorCount++; if (err.name === 'QuotaExceededError') alert(`「${file.name}」の保存に失敗しました。\nブラウザの保存容量が上限に達した可能性があります。不要な譜面を削除して、再度お試しください。`); } } dom.songTitleElement.textContent = '譜面を選択してください'; dom.songArtistElement.textContent = ''; dom.oszFileLabel.classList.remove('is-loading'); dom.oszFileInput.disabled = false; e.target.value = ''; let message = `${successCount}個の譜面を保存しました。`; if (errorCount > 0) message += `\n${errorCount}個の譜面は失敗しました。`; if (successCount > 0 || errorCount > 0) alert(message); if (successCount > 0) { await loadSavedSongsList(); resetGameAndFiles(true); } }
        async function processOszBlob(blob) { resetGameAndFiles(false); dom.songTitleElement.textContent = '読み込み中...'; dom.songArtistElement.textContent = ''; try { osz_zip = new JSZip(); const zip = await osz_zip.loadAsync(blob); const filePromises = []; osz_beatmaps = []; const imageExtensions = ['.jpg', '.jpeg', '.png'], videoExtensions = ['.mp4', '.avi', '.webm']; zip.forEach((relativePath, zipEntry) => { const lowerCasePath = relativePath.toLowerCase(); if (lowerCasePath.endsWith('.osu')) filePromises.push(zipEntry.async('string').then(content => { let isTaikoMode = false; for (const line of content.split('\n')) { const trimmedLine = line.trim().toLowerCase(); if (trimmedLine.startsWith('mode:') && trimmedLine.includes('1')) { isTaikoMode = true; break; } } if (isTaikoMode) { const tempInfo = { title: '', artist: '', version: '', difficulty: 0 }; let currentSection = ''; for (const line of content.split('\n')) { const trimmedLine = line.trim(); if (trimmedLine.startsWith('[')) { currentSection = trimmedLine.toLowerCase(); continue; } if (currentSection === '[metadata]') { if (trimmedLine.toLowerCase().startsWith('title:')) tempInfo.title = trimmedLine.substring(6).trim(); else if (trimmedLine.toLowerCase().startsWith('artist:')) tempInfo.artist = trimmedLine.substring(7).trim(); else if (trimmedLine.toLowerCase().startsWith('version:')) tempInfo.version = trimmedLine.substring(8).trim(); } else if (currentSection === '[difficulty]' && trimmedLine.toLowerCase().startsWith('overalldifficulty:')) tempInfo.difficulty = parseFloat(trimmedLine.split(':')[1].trim()); } osz_beatmaps.push({ name: relativePath, content, info: tempInfo }); } })); else if (videoExtensions.some(ext => lowerCasePath.endsWith(ext)) && !availableBackgrounds.video) filePromises.push(zipEntry.async('blob').then(b => availableBackgrounds.video = URL.createObjectURL(b))); else if (imageExtensions.some(ext => lowerCasePath.endsWith(ext)) && !availableBackgrounds.image) filePromises.push(zipEntry.async('blob').then(b => availableBackgrounds.image = URL.createObjectURL(b))); }); await Promise.all(filePromises); updateBackgroundSelector(); if (osz_beatmaps.length === 0) throw new Error('.osuファイルが見つかりませんでした (太鼓モードの譜面がありません)。'); dom.beatmapSelector.innerHTML = '<option value="">-- 難易度を選択 --</option>'; osz_beatmaps.sort((a, b) => a.info.difficulty - b.info.difficulty).forEach((osuFile, index) => { const optionText = `${osuFile.info.version || osuFile.name}${osuFile.info.difficulty ? ` (Lv.${osuFile.info.difficulty.toFixed(2)})` : ''}`; dom.beatmapSelector.add(new Option(optionText, index)); }); dom.beatmapSelectorContainer.style.display = 'block'; dom.beatmapSelector.selectedIndex = 1; handleBeatmapSelection(); } catch (err) { alert('譜面の処理に失敗しました: ' + err.message); console.error(err); resetGameAndFiles(false); } }
        async function handleBeatmapSelection() { const selectedIndex = dom.beatmapSelector.value; beatmapLoaded = false; audioLoaded = false; checkReadyState(); if (selectedIndex === "") { dom.songTitleElement.textContent = '難易度を選択してください'; dom.songArtistElement.textContent = ''; return; } const selectedOsu = osz_beatmaps[parseInt(selectedIndex, 10)]; if (!selectedOsu) return; fileContent = selectedOsu.content; if (parseOsuFile(fileContent)) { beatmapLoaded = true; dom.songTitleElement.textContent = songInfo.title || '（タイトル不明）'; dom.songArtistElement.textContent = songInfo.artist || '（アーティスト不明）'; loadTaikoBeatmapSpecificSettings(); if (dom.backgroundSelectWrapper.style.display === 'block') { if (availableBackgrounds.video) dom.backgroundSelect.value = 'video'; else if (availableBackgrounds.image) dom.backgroundSelect.value = 'image'; selectedBackgroundType = dom.backgroundSelect.value; saveTaikoBeatmapSpecificSettings(); } if (osz_zip && songInfo.audioFilename) { const targetAudioName = songInfo.audioFilename.replace(/\\/g, '/').toLowerCase(), audioFileEntry = Object.values(osz_zip.files).find(f => !f.dir && f.name.replace(/\\/g, '/').toLowerCase().endsWith(targetAudioName)); if (audioFileEntry) try { const audioBlob = await audioFileEntry.async('blob'); if (audioSrc) URL.revokeObjectURL(audioSrc); audioSrc = URL.createObjectURL(audioBlob); dom.audioPlayer.src = audioSrc; audioLoaded = true; } catch (e) { alert(`音声ファイル "${songInfo.audioFilename}" の読み込みに失敗しました。`); } else alert(`音声ファイル "${songInfo.audioFilename}" が見つかりません。`); } } else { beatmapLoaded = false; audioLoaded = false; dom.songTitleElement.textContent = '非対応の譜面です'; dom.songArtistElement.textContent = '太鼓モードの難易度を選択してください'; alert('この譜面は太鼓モードではありません。'); } checkReadyState(); }
        function resetGameAndFiles(fullReset = true) { resetGame(); if (availableBackgrounds.video) URL.revokeObjectURL(availableBackgrounds.video); if (availableBackgrounds.image) URL.revokeObjectURL(availableBackgrounds.image); availableBackgrounds = { video: null, image: null }; updateBackgroundSelector(); dom.saveSongToPcButton.disabled = true; dom.individualOffsetInput.value = 0; if (fullReset) { fileContent = null; osz_zip = null; osz_beatmaps = []; beatmapLoaded = false; audioLoaded = false; dom.beatmapSelectorContainer.style.display = 'none'; dom.beatmapSelector.innerHTML = ''; dom.songTitleElement.textContent = '譜面を選択してください'; dom.songArtistElement.textContent = ''; dom.savedSongsList.value = ''; currentSongId = null; } checkReadyState(); }
        function checkReadyState() { dom.startButton.disabled = !(beatmapLoaded && audioLoaded); }
        function updateBackgroundSelector() { const selector = dom.backgroundSelect, wrapper = dom.backgroundSelectWrapper; selector.innerHTML = ''; let hasOptions = false; if (availableBackgrounds.video || availableBackgrounds.image) { selector.add(new Option('背景なし', 'none')); if (availableBackgrounds.video) selector.add(new Option('動画', 'video')); if (availableBackgrounds.image) selector.add(new Option('画像', 'image')); hasOptions = true; } if (hasOptions) { wrapper.style.display = 'block'; if (availableBackgrounds.video) { selector.value = 'video'; selectedBackgroundType = 'video'; } else if (availableBackgrounds.image) { selector.value = 'image'; selectedBackgroundType = 'image'; } } else { wrapper.style.display = 'none'; selectedBackgroundType = 'none'; } }
        function updateSpeed() { const val = parseFloat(dom.speedSlider.value); dom.speedLabel.textContent = `スクロール速度 (x${(1.0 + val / 6.0).toFixed(1)})`; uiScrollSpeed = BASE_SCROLL_SPEED + val; if (uiScrollSpeed < 1) uiScrollSpeed = 1; }
        function updateLaneOpacity() { const opacity = dom.laneOpacitySlider.value; dom.laneOpacityLabel.textContent = `レーン不透明度 (${Math.round(opacity * 100)}%)`; dom.playfield.style.backgroundColor = `rgba(18, 18, 18, ${opacity})`; }
        function updateBgBrightness() { const brightness = dom.bgBrightnessSlider.value; dom.bgBrightnessLabel.textContent = `背景の明るさ (${Math.round(brightness * 100)}%)`; const filterValue = `brightness(${brightness})`; dom.backgroundVideo.style.filter = filterValue; dom.backgroundImage.style.filter = filterValue; }
        function updateLaneCover() { laneCoverPercentage = parseInt(dom.laneCoverSlider.value, 10); dom.laneCoverLabel.textContent = `レーンカバー (${laneCoverPercentage}%)`; }
        function initKeyConfig() { dom.keyConfigInputs.querySelectorAll('.key-config-input').forEach(keyInput => { keyInput.addEventListener('click', e => { if (isGameRunning) return; root.querySelectorAll('.key-config-input.is-waiting').forEach(el => el.blur()); e.currentTarget.textContent = '...'; e.currentTarget.classList.add('is-waiting'); }); keyInput.addEventListener('blur', e => { const keyId = e.currentTarget.dataset.keyId; e.currentTarget.classList.remove('is-waiting'); e.currentTarget.textContent = KEYS[keyId]; saveSettings(); }); keyInput.addEventListener('keydown', e => { e.preventDefault(); const keyDiv = e.currentTarget; if (!keyDiv.classList.contains('is-waiting')) return; if (e.key === 'Escape') { keyDiv.blur(); return; } const newKey = e.key.toUpperCase(); if (newKey.length > 1 && !['SPACE', 'BACKSPACE', 'ENTER'].includes(newKey)) return; const keyId = keyDiv.dataset.keyId; if (Object.values(KEYS).some((k, i) => k === newKey && Object.keys(KEYS)[i] !== keyId)) { alert('そのキーは他のアクションで既に使用されています。'); return; } KEYS[keyId] = newKey; keyDiv.blur(); }); }); }
        function initGameUI() { const rect = dom.playfield.getBoundingClientRect(); dom.canvas.width = rect.width; dom.canvas.height = rect.height; }
        function resetGame() { score = 0; combo = 0; maxCombo = 0; totalPauseDuration = 0; judgmentCounts = { ryo: 0, ka: 0, fuka: 0 }; accuracy = 100; dom.scoreElement.textContent = score; dom.accuracyElement.textContent = `S 100.00%`; if (dom.errorBar) dom.errorBar.innerHTML = ''; updateComboDisplay(); if (animationFrameId) cancelAnimationFrame(animationFrameId); if (hitObjects && hitObjects.length > 0) hitObjects.forEach(note => { note.judged = false; note.sePlayed = false; if ('hitsMade' in note) note.hitsMade = 0; }); lastCheckedNoteIndex = 0; lastAutoSEIndex = 0; activeRollHits = 0; rollCounterClearTime = 0; isGoGoNow = false; pressedKeys.clear(); autoPlayHitCounter = 0; dom.resultsOverlay.style.display = 'none'; isGameRunning = false; isPaused = false; const canvas = root.querySelector('#taiko-gameplay-progress-pie'); if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); }
        async function startGame() { if (isGameRunning || !beatmapLoaded || !audioLoaded) return; if (audioSrc && dom.audioPlayer.currentSrc !== audioSrc) dom.audioPlayer.src = audioSrc; if (audioContext && audioContext.state === 'suspended') await audioContext.resume(); resetGame(); dom.appContainer.style.display = 'none'; dom.gameContainer.style.display = 'block'; dom.gameContainer.classList.add('playing'); initGameUI(); dom.backgroundVideo.style.display = 'none'; dom.backgroundImage.style.display = 'none'; drawProgressPie('taiko-gameplay-progress-pie', 0); isAutoPlay = dom.autoPlayCheckbox.checked; isAutoSE = dom.autoSeCheckbox.checked; isSingleHandBigNoteEnabled = dom.singleHandBigNoteCheckbox.checked; offset = 131; const audioReadyPromise = new Promise(resolve => { if (dom.audioPlayer.readyState >= 4) resolve(); else dom.audioPlayer.addEventListener('canplaythrough', resolve, { once: true }); }); let videoReadyPromise = Promise.resolve(); if (selectedBackgroundType === 'video' && availableBackgrounds.video) videoReadyPromise = new Promise(resolve => { const videoEl = dom.backgroundVideo, onSuccess = () => { videoEl.removeEventListener('error', onError); resolve(); }, onError = () => { videoEl.removeEventListener('loadeddata', onSuccess); console.error("Video loading failed."); resolve('video_error'); }; videoEl.addEventListener('loadeddata', onSuccess, { once: true }); videoEl.addEventListener('error', onError, { once: true }); videoEl.src = availableBackgrounds.video; videoEl.load(); videoEl.style.display = 'block'; if (videoEl.readyState >= 2) onSuccess(); }); else if (selectedBackgroundType === 'image' && availableBackgrounds.image) { dom.backgroundImage.src = availableBackgrounds.image; dom.backgroundImage.style.display = 'block'; } const [_, videoResult] = await Promise.all([audioReadyPromise, videoReadyPromise]); if (videoResult === 'video_error') { alert("動画の読み込みに失敗しました。背景を画像（あれば）に切り替えます。"); dom.backgroundVideo.style.display = 'none'; if (availableBackgrounds.image) { dom.backgroundImage.src = availableBackgrounds.image; dom.backgroundImage.style.display = 'block'; selectedBackgroundType = 'image'; if (dom.backgroundSelect) dom.backgroundSelect.value = 'image'; } else { selectedBackgroundType = 'none'; if (dom.backgroundSelect) dom.backgroundSelect.value = 'none'; } } isGameRunning = true; isPaused = false; const initialDelay = 3000, videoOffsetMs = parseInt(dom.videoOffsetInput.value, 10) || 0; gameStartTime = performance.now() + initialDelay; totalPauseDuration = 0; dom.audioPlayer.currentTime = 0; let videoPlayDelay = 0, audioPlayDelay = 0; if (selectedBackgroundType === 'video' && availableBackgrounds.video) { dom.backgroundVideo.currentTime = 0; if (videoOffsetMs > 0) videoPlayDelay = videoOffsetMs; else { audioPlayDelay = Math.abs(videoOffsetMs); dom.backgroundVideo.currentTime = Math.abs(videoOffsetMs) / 1000; } } isInitialCooldown = true; setTimeout(() => { if (!isGameRunning || isPaused) return; setTimeout(() => { if (isGameRunning && !isPaused) dom.audioPlayer.play(); }, audioPlayDelay); if (selectedBackgroundType === 'video' && availableBackgrounds.video && videoResult !== 'video_error') setTimeout(() => { if (isGameRunning && !isPaused) dom.backgroundVideo.play(); }, videoPlayDelay); setTimeout(() => isInitialCooldown = false, 500); }, initialDelay); animationFrameId = requestAnimationFrame(gameLoop); }
        function getGameTime() { return isPaused ? pauseStartTime - gameStartTime - totalPauseDuration : performance.now() - gameStartTime - totalPauseDuration; }
        function updateLastCheckedNoteIndex() { while (hitObjects[lastCheckedNoteIndex] && hitObjects[lastCheckedNoteIndex].judged) lastCheckedNoteIndex++; }
        function drawCapsule(ctx, x1, x2, y, radius, color) { if (x1 > x2) [x1, x2] = [x2, x1]; ctx.beginPath(); ctx.arc(x1, y, radius, Math.PI / 2, -Math.PI / 2); ctx.arc(x2, y, radius, -Math.PI / 2, Math.PI / 2); ctx.closePath(); if (color) { ctx.fillStyle = color; ctx.fill(); } }
        function gameLoop() { if (!isGameRunning) return; animationFrameId = requestAnimationFrame(gameLoop); if (isPaused) return; const elapsedTime = getGameTime() - offset; isGoGoNow = goGoSections.some(s => elapsedTime >= s.start && elapsedTime < s.end); dom.ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height); drawJudgmentFrame(); if (isGoGoNow) drawGameArea(true); if (laneCoverPercentage > 0) { const visibleWidth = dom.canvas.width * (1 - laneCoverPercentage / 100); dom.ctx.save(); dom.ctx.beginPath(); dom.ctx.rect(0, 0, visibleWidth, dom.canvas.height); dom.ctx.clip(); } drawBarLines(elapsedTime); drawNotes(elapsedTime); if (laneCoverPercentage > 0) dom.ctx.restore(); drawRollCounter(elapsedTime); if (isAutoPlay) autoPlayHandler(elapsedTime); else { checkMisses(elapsedTime); if (isAutoSE) autoSEHandler(elapsedTime); } updateLastCheckedNoteIndex(); const progress = Math.min(1, elapsedTime / lastNoteTime); drawProgressPie('taiko-gameplay-progress-pie', progress); if (progress >= 1 && elapsedTime > lastNoteTime + 3000) showResults(); }
        function drawJudgmentFrame() { const y = dom.canvas.height / 2, ctx = dom.ctx, normalNoteRadius = y * 0.41, bigNoteRadius = y * 0.65, centerCircleRadius = y * 0.35; ctx.strokeStyle = '#666666'; ctx.lineWidth = 4 * laneSizeScale; ctx.beginPath(); ctx.arc(JUDGE_POINT_X, y, bigNoteRadius, 0, 2 * Math.PI); ctx.stroke(); ctx.strokeStyle = '#CCCCCC'; ctx.lineWidth = 2 * laneSizeScale; ctx.beginPath(); ctx.arc(JUDGE_POINT_X, y, normalNoteRadius, 0, 2 * Math.PI); ctx.stroke(); ctx.fillStyle = '#777777'; ctx.beginPath(); ctx.arc(JUDGE_POINT_X, y, centerCircleRadius, 0, 2 * Math.PI); ctx.fill(); }
        function drawGameArea(isGoGo) { if (!isGoGo) return; const fireGradient = dom.ctx.createLinearGradient(0, 0, 0, dom.canvas.height); fireGradient.addColorStop(0, "rgba(255, 100, 0, 0.3)"); fireGradient.addColorStop(0.5, "rgba(255, 69, 0, 0.2)"); fireGradient.addColorStop(1, "rgba(255, 100, 0, 0.3)"); dom.ctx.fillStyle = fireGradient; dom.ctx.fillRect(0, 0, dom.canvas.width, dom.canvas.height); }
        function drawBarLines(elapsedTime) { const pixelMultiplier = uiScrollSpeed * 0.1; dom.ctx.strokeStyle = '#FFFFFF'; dom.ctx.lineWidth = 2; dom.ctx.globalAlpha = 0.5; barLines.forEach(line => { const x = JUDGE_POINT_X + (line.time - elapsedTime) * line.scrollSpeed * pixelMultiplier; if (x < JUDGE_POINT_X - 50) return; dom.ctx.beginPath(); dom.ctx.moveTo(x, 0); dom.ctx.lineTo(x, dom.canvas.height); dom.ctx.stroke(); }); dom.ctx.globalAlpha = 1.0; }
        function drawNotes(elapsedTime) { const y = dom.canvas.height / 2, pixelMultiplier = uiScrollSpeed * 0.1, BEIGE_RING = '#F0EAD6', BLACK_BORDER = '#000000'; for (let i = hitObjects.length - 1; i >= 0; i--) { const note = hitObjects[i]; if (note.judged) continue; const startX = JUDGE_POINT_X + (note.time - elapsedTime) * note.scrollSpeed * pixelMultiplier; if (note.type === 'roll') { const endX = JUDGE_POINT_X + (note.endTime - elapsedTime) * note.scrollSpeed * pixelMultiplier; if (endX < JUDGE_POINT_X - 50 || startX > dom.canvas.width + 50) continue; const barHeight = y * 0.8, headRadius = barHeight / 2, barRadius = headRadius * 1.046, BLACK_BORDER_THICKNESS = 2 * laneSizeScale, WHITE_BORDER_THICKNESS = 6 * laneSizeScale; drawCapsule(dom.ctx, startX, endX, y, barRadius, BLACK_BORDER); drawCapsule(dom.ctx, startX, endX, y, barRadius - BLACK_BORDER_THICKNESS, BEIGE_RING); drawCapsule(dom.ctx, startX, endX, y, barRadius - BLACK_BORDER_THICKNESS - WHITE_BORDER_THICKNESS, '#FFC700'); dom.ctx.fillStyle = BLACK_BORDER; dom.ctx.beginPath(); dom.ctx.arc(startX, y, headRadius, 0, 2 * Math.PI); dom.ctx.fill(); dom.ctx.fillStyle = BEIGE_RING; dom.ctx.beginPath(); dom.ctx.arc(startX, y, headRadius - BLACK_BORDER_THICKNESS, 0, 2 * Math.PI); dom.ctx.fill(); dom.ctx.fillStyle = '#FFC700'; dom.ctx.beginPath(); dom.ctx.arc(startX, y, headRadius - BLACK_BORDER_THICKNESS - WHITE_BORDER_THICKNESS, 0, 2 * Math.PI); dom.ctx.fill(); } else if (note.type === 'balloon') { const endX = JUDGE_POINT_X + (note.endTime - elapsedTime) * note.scrollSpeed * pixelMultiplier, radius = y * 0.45; let currentX = startX; if (startX < JUDGE_POINT_X && endX > JUDGE_POINT_X) currentX = JUDGE_POINT_X; if (currentX < -radius) continue; const BLACK_BORDER_THICKNESS = 2 * laneSizeScale, WHITE_BORDER_THICKNESS = 6 * laneSizeScale, ORANGE_FILL = '#F98025'; dom.ctx.fillStyle = BLACK_BORDER; dom.ctx.beginPath(); dom.ctx.arc(currentX, y, radius, 0, 2 * Math.PI); dom.ctx.fill(); dom.ctx.fillStyle = BEIGE_RING; dom.ctx.beginPath(); dom.ctx.arc(currentX, y, radius - BLACK_BORDER_THICKNESS, 0, 2 * Math.PI); dom.ctx.fill(); dom.ctx.fillStyle = ORANGE_FILL; dom.ctx.beginPath(); dom.ctx.arc(currentX, y, radius - BLACK_BORDER_THICKNESS - WHITE_BORDER_THICKNESS, 0, 2 * Math.PI); dom.ctx.fill(); const remainingHits = note.hitsRequired - note.hitsMade; if (remainingHits > 0) { dom.ctx.fillStyle = '#fff'; dom.ctx.strokeStyle = 'rgba(0,0,0,0.5)'; dom.ctx.lineWidth = 4; dom.ctx.font = `bold ${radius}px sans-serif`; dom.ctx.textAlign = 'center'; dom.ctx.textBaseline = 'middle'; dom.ctx.strokeText(remainingHits, currentX, y); dom.ctx.fillText(remainingHits, currentX, y); } } else { if (startX > dom.canvas.width + 50 || startX < JUDGE_POINT_X - 50) continue; const color = note.type === 'don' ? '#F83838' : '#46B6B6', baseRadius = note.isBig ? y * 0.65 : y * 0.42, BLACK_BORDER_THICKNESS = 2 * laneSizeScale, WHITE_BORDER_THICKNESS = 6 * laneSizeScale; dom.ctx.fillStyle = BLACK_BORDER; dom.ctx.beginPath(); dom.ctx.arc(startX, y, baseRadius, 0, 2 * Math.PI); dom.ctx.fill(); dom.ctx.fillStyle = BEIGE_RING; dom.ctx.beginPath(); dom.ctx.arc(startX, y, baseRadius - BLACK_BORDER_THICKNESS, 0, 2 * Math.PI); dom.ctx.fill(); dom.ctx.fillStyle = color; dom.ctx.beginPath(); dom.ctx.arc(startX, y, baseRadius - BLACK_BORDER_THICKNESS - WHITE_BORDER_THICKNESS, 0, 2 * Math.PI); dom.ctx.fill(); } } }
        function drawRollCounter(elapsedTime) { if (rollCounterClearTime > 0 && elapsedTime >= rollCounterClearTime) { activeRollHits = 0; rollCounterClearTime = 0; } if (activeRollHits > 0) { dom.rollCounterDisplay.textContent = activeRollHits; dom.rollCounterDisplay.classList.add('visible'); } else dom.rollCounterDisplay.classList.remove('visible'); }
        function playHitSound(type, offset = 0) { if (!audioContext) return; const buffer = type === 'don' ? donSoundBuffer : katsuSoundBuffer; if (!buffer) return; const source = audioContext.createBufferSource(); source.buffer = buffer; source.connect(audioContext.destination); const offsetInSeconds = offset / 1000; let playTime = audioContext.currentTime, playOffset = 0; if (offsetInSeconds >= 0) playTime += offsetInSeconds; else playOffset = -offsetInSeconds; if (playOffset < buffer.duration) source.start(playTime, playOffset); }
        function autoSEHandler(elapsedTime) { for (let i = lastAutoSEIndex; i < hitObjects.length; i++) { const note = hitObjects[i]; if (note.sePlayed) continue; if (elapsedTime >= note.time) { if (note.type === 'don' || note.type === 'katsu') { playHitSound(note.type); note.sePlayed = true; } } else break; } while (hitObjects[lastAutoSEIndex] && hitObjects[lastAutoSEIndex].sePlayed) lastAutoSEIndex++; }
        function showHitError(diff) { if (!dom.errorBar) return; const tick = document.createElement('div'); tick.className = 'error-tick'; tick.style.left = `${Math.max(0, Math.min(100, (diff + HIT_WINDOW_BAD) / (2 * HIT_WINDOW_BAD) * 100))}%`; dom.errorBar.appendChild(tick); setTimeout(() => tick.remove(), 1500); }
        function autoPlayHandler(elapsedTime) { for (const note of hitObjects) { if (note.judged) continue; if (note.type === 'balloon' || note.type === 'roll') { if (elapsedTime >= note.time && elapsedTime <= note.endTime && elapsedTime - (note.lastAutoHitTime || 0) > 25) { playHitSound('don'); showDrumHit(autoPlayHitCounter % 2 === 0 ? 'don_right' : 'don_left'); autoPlayHitCounter++; let hitScore = 100; if (isGoGoNow) hitScore *= 1.2; score += hitScore; note.hitsMade++; if (note.type === 'roll') { activeRollHits = note.hitsMade; rollCounterClearTime = 0; } else if (note.type === 'balloon' && note.hitsMade >= note.hitsRequired) { let burstBonus = 5000; if (isGoGoNow) burstBonus *= 1.2; score += burstBonus; note.judged = true; } dom.scoreElement.textContent = Math.floor(score); note.lastAutoHitTime = elapsedTime; } if (elapsedTime > note.endTime && !note.judged) { if (note.type === 'roll' && note.hitsMade > 0) rollCounterClearTime = elapsedTime + 2000; note.judged = true; } } else if (elapsedTime >= note.time) { playHitSound(note.type); const isBigNoteTwoHands = note.isBig && !isSingleHandBigNoteEnabled; if (note.type === 'don') { if (isBigNoteTwoHands) { showDrumHit('don_left'); showDrumHit('don_right'); } else showDrumHit(autoPlayHitCounter % 2 === 0 ? 'don_right' : 'don_left'); } else if (note.type === 'katsu') { if (isBigNoteTwoHands) { showDrumHit('katsu_left'); showDrumHit('katsu_right'); } else showDrumHit(autoPlayHitCounter % 2 === 0 ? 'katsu_right' : 'katsu_left'); } autoPlayHitCounter++; handleJudgment('ryo', note, 0); } } }
        function showDrumHit(keyId) { const hitMap = { don_left: dom.drumDonLeft, don_right: dom.drumDonRight, katsu_left: dom.drumKatsuLeft, katsu_right: dom.drumKatsuRight }, element = hitMap[keyId]; if (!element) return; if (drumHitTimeouts[keyId]) clearTimeout(drumHitTimeouts[keyId]); element.classList.add('active'); drumHitTimeouts[keyId] = setTimeout(() => element.classList.remove('active'), 50); }
        function handleKeydown(e) { if (activeGame !== 'taiko' || e.repeat || !isGameRunning || isPaused || isAutoPlay) return; e.preventDefault(); const key = e.key.toUpperCase(); let hitKeyId = null; for (const id in KEYS) if (KEYS[id] === key) { hitKeyId = id; break; } if (!hitKeyId) return; pressedKeys.add(key); const keyType = hitKeyId.startsWith('don') ? 'don' : 'katsu'; showDrumHit(hitKeyId); const elapsedTime = getGameTime() - offset + (parseInt(dom.seOffsetInput.value, 10) || 0); if (elapsedTime < -500) return; let activeLongNote = null; for (let i = lastCheckedNoteIndex; i < hitObjects.length; i++) { const note = hitObjects[i]; if (note.judged) continue; if (elapsedTime >= note.time && elapsedTime <= note.endTime + HIT_WINDOW_BAD && (note.type === 'roll' || note.type === 'balloon')) { activeLongNote = note; break; } if (note.time > elapsedTime + 200) break; } if (activeLongNote) { if (activeLongNote.type === 'roll') { playHitSound(keyType); let scoreToAdd = activeLongNote.isBig ? 200 : 100; if (isGoGoNow) scoreToAdd *= 1.2; score += scoreToAdd; activeLongNote.hitsMade++; activeRollHits = activeLongNote.hitsMade; rollCounterClearTime = 0; dom.scoreElement.textContent = Math.floor(score); } else if (activeLongNote.type === 'balloon' && keyType === 'don') { playHitSound('don'); let scoreToAdd = 300; if (isGoGoNow) scoreToAdd *= 1.2; score += scoreToAdd; activeLongNote.hitsMade++; if (activeLongNote.hitsMade >= activeLongNote.hitsRequired) { let balloonBurstBonus = 5000; if (isGoGoNow) balloonBurstBonus *= 1.2; score += balloonBurstBonus; activeLongNote.judged = true; } dom.scoreElement.textContent = Math.floor(score); } return; } let potentialNote = null, minTimeDiff = Infinity; for (let i = lastCheckedNoteIndex; i < hitObjects.length; i++) { const note = hitObjects[i]; if (note.judged || note.type === 'balloon' || note.type === 'roll' || note.type !== keyType) continue; const timeDiff = Math.abs(note.time - elapsedTime); if (timeDiff < EARLY_MISS_WINDOW && timeDiff < minTimeDiff) { minTimeDiff = timeDiff; potentialNote = note; } if (note.time > elapsedTime + EARLY_MISS_WINDOW + 100) break; } if (potentialNote) { const actualTimeDiff = elapsedTime - potentialNote.time; if (!potentialNote.sePlayed) playHitSound(keyType); if (Math.abs(actualTimeDiff) <= HIT_WINDOW_PERFECT) handleJudgment('ryo', potentialNote, actualTimeDiff); else if (Math.abs(actualTimeDiff) <= HIT_WINDOW_GOOD) handleJudgment('ka', potentialNote, actualTimeDiff); else if (actualTimeDiff < 0) handleJudgment('fuka', potentialNote); } else if (!isAutoSE) playHitSound(keyType); }
        document.addEventListener('keydown', handleKeydown);
        document.addEventListener('keyup', e => { if (activeGame === 'taiko') pressedKeys.delete(e.key.toUpperCase()); });
        function checkMisses(elapsedTime) { for (let i = lastCheckedNoteIndex; i < hitObjects.length; i++) { const note = hitObjects[i]; if (note.judged) continue; if (note.time > elapsedTime + HIT_WINDOW_BAD) break; if (note.type !== 'balloon' && note.type !== 'roll') { if (elapsedTime > note.time + HIT_WINDOW_BAD) handleJudgment('fuka', note); } else if (elapsedTime > note.endTime) { if (note.type === 'roll' && note.hitsMade > 0) rollCounterClearTime = elapsedTime + 2000; note.judged = true; } } }
        function handleJudgment(judgement, note, diff = null) { if (note.judged) return; note.judged = true; note.sePlayed = true; if (diff !== null) showHitError(diff); showJudgment({ ryo: '良', ka: '可', fuka: '不可' }[judgement]); judgmentCounts[judgement]++; if (judgement === 'ryo' || judgement === 'ka') { let scoreMultiplier = 1; if (note.isBig) { if (isSingleHandBigNoteEnabled) scoreMultiplier = 2; else { const isDonHit = note.type === 'don' && pressedKeys.has(KEYS.don_left) && pressedKeys.has(KEYS.don_right), isKatsuHit = note.type === 'katsu' && pressedKeys.has(KEYS.katsu_left) && pressedKeys.has(KEYS.katsu_right); if (isDonHit || isKatsuHit) scoreMultiplier = 2; } } updateScore((judgement === 'ryo' ? 300 : 100) * scoreMultiplier); updateCombo(true); } else updateCombo(false); updateAccuracy(); }
        function updateScore(points) { let currentPoints = points + points * Math.floor(combo / 10) * 0.1; if (isGoGoNow) currentPoints *= 1.2; score += currentPoints; dom.scoreElement.textContent = Math.floor(score); }
        function updateCombo(hit) { if (hit) { combo++; if (combo > maxCombo) maxCombo = combo; } else combo = 0; updateComboDisplay(); }
        function updateAccuracy() { const totalHits = judgmentCounts.ryo + judgmentCounts.ka + judgmentCounts.fuka; accuracy = totalHits === 0 ? 100 : (judgmentCounts.ryo * 300 + judgmentCounts.ka * 150) / (totalHits * 300) * 100; let rank = 'S'; if (accuracy < 95) rank = 'A'; if (accuracy < 90) rank = 'B'; if (accuracy < 80) rank = 'C'; if (accuracy < 70) rank = 'D'; dom.accuracyElement.textContent = `${rank} ${accuracy.toFixed(2)}%`; }
        function showJudgment(text) { const el = dom.judgmentTextElement, styles = { "良": 'gold', "可": 'white', "不可": '#dda0dd' }; el.textContent = text; el.style.color = styles[text] || 'white'; el.style.animation = 'none'; void el.offsetHeight; el.style.animation = null; }
        function updateComboDisplay() { if (combo > 0) { dom.comboElement.textContent = combo; dom.comboDisplay.classList.add('visible'); } else dom.comboDisplay.classList.remove('visible'); }
        function updatePauseSelection() { dom.pauseOverlay.querySelectorAll('.overlay-button').forEach((btn, index) => btn.classList.toggle('selected', index === selectedPauseIndex)); }
        function togglePause() { if (isInitialCooldown || !isGameRunning || isPauseButtonCoolingDown) return; isPauseButtonCoolingDown = true; setTimeout(() => isPauseButtonCoolingDown = false, 500); isPaused = !isPaused; if (isPaused) { pauseStartTime = performance.now(); pausedTime = dom.audioPlayer.currentTime; dom.audioPlayer.pause(); if (selectedBackgroundType === 'video' && availableBackgrounds.video) dom.backgroundVideo.pause(); dom.gameContainer.classList.remove('playing'); cancelAnimationFrame(animationFrameId); dom.pauseOverlay.style.display = 'flex'; selectedPauseIndex = 0; updatePauseSelection(); } else { totalPauseDuration += performance.now() - pauseStartTime; dom.audioPlayer.currentTime = pausedTime; dom.audioPlayer.play(); if (selectedBackgroundType === 'video' && availableBackgrounds.video) dom.backgroundVideo.play(); dom.gameContainer.classList.add('playing'); animationFrameId = requestAnimationFrame(gameLoop); dom.pauseOverlay.style.display = 'none'; } }
        function retryGame() { isGameRunning = false; if (animationFrameId) cancelAnimationFrame(animationFrameId); dom.audioPlayer.pause(); dom.audioPlayer.load(); if (selectedBackgroundType === 'video' && dom.backgroundVideo) dom.backgroundVideo.pause(); dom.pauseOverlay.style.display = 'none'; dom.resultsOverlay.style.display = 'none'; if (beatmapLoaded && audioLoaded) startGame(); else returnToControls(); }
        function returnToControls() { isGameRunning = false; isPaused = false; if (animationFrameId) cancelAnimationFrame(animationFrameId); animationFrameId = null; if (dom.audioPlayer) { dom.audioPlayer.pause(); dom.audioPlayer.currentTime = 0; } if (selectedBackgroundType === 'video' && dom.backgroundVideo) { dom.backgroundVideo.pause(); dom.backgroundVideo.load(); dom.backgroundVideo.currentTime = 0; } dom.pauseOverlay.style.display = 'none'; dom.resultsOverlay.style.display = 'none'; dom.gameContainer.classList.remove('playing'); dom.gameContainer.style.display = 'none'; dom.appContainer.style.display = 'flex'; resetGame(); }
        function showResults() { if (!isGameRunning && dom.resultsOverlay.style.display === 'flex') return; isGameRunning = false; cancelAnimationFrame(animationFrameId); dom.gameContainer.classList.remove('playing'); const totalHits = judgmentCounts.ryo + judgmentCounts.ka + judgmentCounts.fuka, finalAccuracy = totalHits > 0 ? (judgmentCounts.ryo * 300 + judgmentCounts.ka * 150) / (totalHits * 300) * 100 : 100; let rank = 'S'; if (finalAccuracy < 95) rank = 'A'; if (finalAccuracy < 90) rank = 'B'; if (finalAccuracy < 80) rank = 'C'; if (finalAccuracy < 70) rank = 'D'; dom.resultsSongTitle.textContent = `${songInfo.title} - ${songInfo.version}`; dom.resultsScoreValue.textContent = Math.floor(score); dom.resultsRankValue.textContent = rank; dom.resultsMaxComboValue.textContent = maxCombo; dom.resultsRyoValue.textContent = judgmentCounts.ryo; dom.resultsKaValue.textContent = judgmentCounts.ka; dom.resultsFukaValue.textContent = judgmentCounts.fuka; dom.resultsOverlay.style.display = 'flex'; if (selectedBackgroundType === 'video') dom.backgroundVideo.pause(); }
        async function saveSongToPc() { const songId = dom.savedSongsList.value; if (!songId) return alert('PCに保存する譜面を「保存済み譜面」から選択してください。'); dom.saveSongToPcButton.textContent = '準備中...'; dom.saveSongToPcButton.disabled = true; try { const blob = await db.getSongBlob(songId); if (!blob) throw new Error('Blob data not found in DB.'); const fileName = songId.substring(songId.indexOf('-') + 1), url = URL.createObjectURL(blob), a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch (err) { alert('ファイルの保存に失敗しました。'); console.error('Failed to save .osz file from Taiko player:', err); } finally { dom.saveSongToPcButton.textContent = 'PCへ保存'; dom.saveSongToPcButton.disabled = !dom.savedSongsList.value; } }

        return {
            initialize: async function() {
                initKeyConfig(); setupFileListeners(); loadSettings();
                updateLaneOpacity(); updateBgBrightness(); updateLaneCover();
                dom.startButton.addEventListener('click', startGame);
                dom.speedSlider.addEventListener('input', () => { updateSpeed(); saveTaikoBeatmapSpecificSettings(); });
                dom.offsetInput.addEventListener('change', saveSettings);
                dom.videoOffsetInput.addEventListener('change', saveSettings);
                dom.seOffsetInput.addEventListener('change', saveSettings);
                dom.autoPlayCheckbox.addEventListener('change', saveSettings);
                dom.singleHandBigNoteCheckbox.addEventListener('change', saveSettings);
                dom.autoSeCheckbox.addEventListener('change', saveSettings);
                dom.individualOffsetInput.addEventListener('change', saveTaikoBeatmapSpecificSettings);
                dom.saveSongToPcButton.addEventListener('click', saveSongToPc);
                dom.resumeButton.addEventListener('click', togglePause);
                dom.retryButton.addEventListener('click', retryGame);
                dom.backToTitlePause.addEventListener('click', returnToControls);
                dom.resultsRetryButton.addEventListener('click', retryGame);
                dom.backToTitleResults.addEventListener('click', returnToControls);
                dom.switchToManiaButton.addEventListener('click', switchToMania);
                dom.laneOpacitySlider.addEventListener('input', () => { updateLaneOpacity(); saveSettings(); });
                dom.bgBrightnessSlider.addEventListener('input', () => { updateBgBrightness(); saveSettings(); });
                dom.laneCoverSlider.addEventListener('input', () => { updateLaneCover(); saveSettings(); });
                dom.backgroundSelect.addEventListener('change', e => { selectedBackgroundType = e.target.value; saveTaikoBeatmapSpecificSettings(); });
                
                const closeTaikoSettingsButton = dom.taikoSettingsOverlay.querySelector('.overlay-button');
                dom.openTaikoSettingsButton.addEventListener('click', () => dom.taikoSettingsOverlay.style.display = 'flex');
                closeTaikoSettingsButton.addEventListener('click', () => dom.taikoSettingsOverlay.style.display = 'none');
                
                window.addEventListener('resize', initGameUI);
                try {
                    await db.init();
                    await loadSavedSongsList();
                } catch (e) {
                    console.error('Application initialization failed:', e);
                    alert('データベースの初期化に失敗しました。保存機能は利用できません。');
                }
                initializeShortcutKeySetup('taiko-shortcut-retry', 'taiko-shortcut-menu');
            },
            togglePauseExternal: togglePause,
            retryGameExternal: function() { if (isGameRunning || isPaused || dom.resultsOverlay.style.display === 'flex') retryGame(); },
            returnToControlsExternal: function() { if (isGameRunning || isPaused || dom.resultsOverlay.style.display === 'flex') returnToControls(); }
        };
    })();
    </script>
    <!-- ↓ PWAに必要なService Worker登録スクリプトを追加 -->
    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }
    </script>
</body>
</html>
