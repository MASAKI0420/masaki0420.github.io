<!-- 
  ã€ãƒ•ã‚¡ã‚¤ãƒ«å: index.html ã¨ã—ã¦ä¿å­˜æ¨å¥¨ã€‘
  ç”»åƒä¸è¦ãƒ»å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ä½œã™ã‚‹PWAå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒ ã‚¢ãƒ—ãƒª
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çˆ†éŸ³æ™‚è¨ˆ</title>
    <meta name="description" content="ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ãå¼·åŠ›ãªã‚¢ãƒ©ãƒ¼ãƒ ã‚¢ãƒ—ãƒª">
    
    <!-- iOS / PWAç”¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e30000">

    <!-- ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆï¼ˆJSã§å‹•çš„ã«æµã—è¾¼ã¿ã¾ã™ï¼‰ -->
    <link id="pwa-icon" rel="icon" type="image/png" href="">
    <link id="pwa-apple-icon" rel="apple-touch-icon" href="">
    <link id="pwa-manifest" rel="manifest" href="">

    <style>
        /* --- ãƒªã‚»ãƒƒãƒˆ & ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
        :root {
            --primary: #e30000;
            --dark: #121212;
            --gray-bg: #1e1e1e;
            --text: #ffffff;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--dark);
            color: var(--text);
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; height: 100dvh; /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            overflow: hidden;
            user-select: none;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header {
            background-color: var(--primary);
            padding: calc(10px + var(--safe-area-top)) 15px 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .app-title { font-weight: 800; font-size: 1.2rem; letter-spacing: 1px; }

        /* ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
        #install-btn {
            display: none;
            background: white; color: var(--primary);
            border: none; padding: 6px 12px;
            font-size: 0.8rem; font-weight: bold;
            border-radius: 20px; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        @media all and (display-mode: standalone) { #install-btn { display: none !important; } }

        /* --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        nav {
            display: flex; justify-content: space-around;
            background-color: #222; border-top: 1px solid #333;
            padding-bottom: var(--safe-area-bottom);
        }
        nav button {
            background: none; border: none; color: #666;
            font-size: 0.9rem; padding: 15px 0; width: 100%;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        nav button.active { color: var(--text); font-weight: bold; }
        nav button.active::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%;
            height: 3px; background: var(--primary);
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ --- */
        main {
            flex: 1; position: relative; overflow: hidden;
            background: var(--gray-bg);
        }

        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 20px; opacity: 0; transition: opacity 0.2s;
        }
        .view.active { display: flex; opacity: 1; z-index: 1; }

        .time-display {
            font-size: 18vw; line-height: 1; font-weight: 700;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 20px rgba(227, 0, 0, 0.4);
            margin: 20px 0;
        }
        @media (min-width: 600px) { .time-display { font-size: 6rem; } }

        /* --- ãƒœã‚¿ãƒ³å…±é€š --- */
        .controls { display: flex; gap: 20px; margin-top: 20px; }

        button.circle-btn {
            width: 80px; height: 80px; border-radius: 50%;
            border: none; font-size: 1rem; font-weight: bold; color: white;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        button.circle-btn:active { transform: scale(0.95); }
        .btn-start { background: linear-gradient(135deg, #00b84c, #008a38); }
        .btn-stop  { background: linear-gradient(135deg, #ff3b30, #d60000); }
        .btn-reset { background: #444; }

        /* å››è§’ã„ãƒœã‚¿ãƒ³ï¼ˆã‚¢ãƒ©ãƒ¼ãƒ ã‚»ãƒƒãƒˆï¼‰ */
        .btn-rect {
            background: #007acc; color: white; border: none;
            padding: 15px 40px; border-radius: 12px;
            font-size: 1.2rem; font-weight: bold; margin-top: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;
        }
        .btn-rect.active { background: #d60000; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.8;} 100% {opacity:1;} }

        /* --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  --- */
        .timer-setup { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px; }
        .input-group { text-align: center; }
        .input-group input {
            background: #333; border: 2px solid #444; color: white;
            font-size: 2rem; width: 80px; text-align: center;
            padding: 10px; border-radius: 8px; outline: none;
        }
        .input-group input:focus { border-color: var(--primary); }
        .input-group label { font-size: 0.8rem; color: #aaa; margin-top: 5px; display: block; }

        input[type="datetime-local"] {
            background: #333; border: 2px solid #444; color: white;
            font-size: 1.3rem; padding: 15px; border-radius: 10px;
            width: 100%; max-width: 350px; text-align: center;
            color-scheme: dark; margin-bottom: 10px; outline: none;
        }

        /* --- ã‚¢ãƒ©ãƒ¼ãƒ åœæ­¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --- */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 0, 0, 0.96); z-index: 9999;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
            animation: flash 0.5s infinite alternate;
        }
        @keyframes flash { from { background: rgba(220,0,0,0.96); } to { background: rgba(50,0,0,0.96); } }
        
        #overlay h1 { font-size: 3rem; margin-bottom: 40px; text-align: center; }
        
        #stop-btn {
            width: 200px; height: 200px; border-radius: 50%;
            background: transparent; border: 6px solid white;
            color: white; font-size: 1.5rem; font-weight: 900;
            cursor: pointer;
        }

        .status-msg { color: #888; margin-top: 10px; white-space: pre-wrap; text-align: center; line-height: 1.5; }
    </style>

    <!-- â–¼ PWA & Service Worker å‹•çš„ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ â–¼ -->
    <script>
    (function() {
        // 1. ã‚¢ã‚¤ã‚³ãƒ³ã®ç”Ÿæˆ (Canvas)
        const canvas = document.createElement('canvas');
        canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        
        // èƒŒæ™¯: èµ¤
        ctx.fillStyle = "#e30000"; ctx.fillRect(0,0,512,512);
        // æ™‚è¨ˆç›¤
        ctx.beginPath(); ctx.arc(256,256,180,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();
        // é‡
        ctx.strokeStyle="#111"; ctx.lineWidth=35; ctx.lineCap="round";
        ctx.beginPath(); ctx.moveTo(256,256); ctx.lineTo(256, 120); ctx.stroke(); // é•·é‡
        ctx.beginPath(); ctx.moveTo(256,256); ctx.lineTo(360, 300); ctx.stroke(); // çŸ­é‡
        ctx.beginPath(); ctx.arc(256,256,25,0,Math.PI*2); ctx.fillStyle="#111"; ctx.fill();

        const iconUrl = canvas.toDataURL('image/png');
        document.getElementById('pwa-icon').href = iconUrl;
        document.getElementById('pwa-apple-icon').href = iconUrl;

        // 2. ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ç”Ÿæˆ (Blob)
        // scopeã¨start_urlã‚’ './' (ã‚«ãƒ¬ãƒ³ãƒˆ) ã«ã™ã‚‹ã“ã¨ã§ä»–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã®å¹²æ¸‰ã‚’é˜²ã
        const manifest = {
            "name": "çˆ†éŸ³æ™‚è¨ˆ",
            "short_name": "çˆ†éŸ³æ™‚è¨ˆ",
            "start_url": "./",
            "scope": "./",
            "display": "standalone",
            "background_color": "#e30000",
            "theme_color": "#e30000",
            "orientation": "portrait",
            "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/png" }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('pwa-manifest').href = URL.createObjectURL(manifestBlob);

        // 3. Service Workerã®ç”Ÿæˆã¨ç™»éŒ² (Blob)
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥åã«ãƒ©ãƒ³ãƒ€ãƒ ãªIDã‚’å«ã‚ã€æ›´æ–°æ™‚ã«å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«ã™ã‚‹
        const cacheId = 'loud-clock-v' + Date.now(); 

        const swCode = `
            const CACHE_NAME = '${cacheId}';
            
            self.addEventListener('install', e => {
                // å³åº§ã«æœ‰åŠ¹åŒ–
                e.waitUntil(self.skipWaiting());
            });

            self.addEventListener('activate', e => {
                // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆä»–ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã“ã®ã‚¢ãƒ—ãƒªï¼‰ã‚’å‰Šé™¤
                e.waitUntil(
                    caches.keys().then(keys => Promise.all(
                        keys.map(key => {
                            if(key !== CACHE_NAME) return caches.delete(key);
                        })
                    )).then(() => self.clients.claim())
                );
            });

            self.addEventListener('fetch', e => {
                // åŸºæœ¬ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å„ªå…ˆã€å¤±æ•—æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆä»Šå›ã¯å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ãªã®ã§ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
                // ãŸã ã—ã€Blob URLç­‰ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ããªã„ã®ã§ã‚¹ãƒ«ãƒ¼
                if(e.request.url.startsWith('http')) {
                    e.respondWith(fetch(e.request).catch(() => {
                        return caches.match(e.request);
                    }));
                }
            });

            // é€šçŸ¥ãƒœã‚¿ãƒ³ã®å‡¦ç†
            self.addEventListener('notificationclick', e => {
                e.notification.close();
                if (e.action === 'stop') {
                    const bc = new BroadcastChannel('alarm_channel');
                    bc.postMessage('STOP');
                } else {
                    e.waitUntil(
                        clients.matchAll({type: 'window'}).then(cl => {
                            for(let c of cl) if(c.focus) return c.focus();
                            if(clients.openWindow) return clients.openWindow('./');
                        })
                    );
                }
            });
        `;
        
        if ('serviceWorker' in navigator) {
            const swBlob = new Blob([swCode], {type: 'text/javascript'});
            const swUrl = URL.createObjectURL(swBlob);
            // scope: './' ã‚’æ˜ç¤ºã—ã¦ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ä»¥ä¸‹ã®ã¿ã‚’åˆ¶å¾¡å¯¾è±¡ã«ã™ã‚‹
            navigator.serviceWorker.register(swUrl, { scope: './' })
                .then(reg => console.log('SW Registered', reg))
                .catch(err => console.log('SW Fail', err));
        }
    })();
    </script>
</head>
<body>

    <header>
        <div class="app-title">âš ï¸ çˆ†éŸ³æ™‚è¨ˆ</div>
        <button id="install-btn">ã‚¢ãƒ—ãƒªã‚’å…¥ã‚Œã‚‹</button>
    </header>

    <main>
        <!-- ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ -->
        <div id="view-timer" class="view active">
            <div id="timer-ui-setup" class="timer-setup">
                <div class="input-group">
                    <input type="number" id="t-min" value="3" min="0" max="99" inputmode="numeric">
                    <label>åˆ†</label>
                </div>
                <div class="input-group">
                    <input type="number" id="t-sec" value="0" min="0" max="59" inputmode="numeric">
                    <label>ç§’</label>
                </div>
            </div>
            
            <div id="timer-ui-count" class="time-display" style="display:none">03:00</div>

            <div class="controls">
                <button class="circle-btn btn-start" id="btn-t-start" onclick="startTimer()">é–‹å§‹</button>
                <button class="circle-btn btn-stop" id="btn-t-stop" onclick="stopTimer()" style="display:none">åœæ­¢</button>
                <button class="circle-btn btn-reset" onclick="resetTimer()">å¾©å¸°</button>
            </div>
        </div>

        <!-- ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒç”»é¢ -->
        <div id="view-stopwatch" class="view">
            <div class="time-display" id="sw-display">00:00.00</div>
            <div class="controls">
                <button class="circle-btn btn-start" id="btn-sw-start" onclick="startSw()">é–‹å§‹</button>
                <button class="circle-btn btn-stop" id="btn-sw-stop" onclick="stopSw()" style="display:none">åœæ­¢</button>
                <button class="circle-btn btn-reset" onclick="resetSw()">å¾©å¸°</button>
            </div>
        </div>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒ ç”»é¢ -->
        <div id="view-alarm" class="view">
            <div style="width:100%; max-width:400px; text-align:center;">
                <input type="datetime-local" id="alarm-input">
                <div id="alarm-msg" class="status-msg">ã‚¢ãƒ©ãƒ¼ãƒ æœªè¨­å®š</div>
                <button id="btn-alarm-toggle" class="btn-rect" onclick="toggleAlarm()">ã‚¢ãƒ©ãƒ¼ãƒ ã‚»ãƒƒãƒˆ</button>
                <div id="perm-warn" style="color:#ffaa00; font-size:0.8rem; margin-top:10px; display:none;">âš ï¸é€šçŸ¥æ¨©é™ãŒå¿…è¦ã§ã™</div>
            </div>
        </div>
    </main>

    <nav>
        <button onclick="setView('timer')" id="nav-timer" class="active">ã‚¿ã‚¤ãƒãƒ¼</button>
        <button onclick="setView('stopwatch')" id="nav-stopwatch">ã‚¦ã‚©ãƒƒãƒ</button>
        <button onclick="setView('alarm')" id="nav-alarm">ã‚¢ãƒ©ãƒ¼ãƒ </button>
    </nav>

    <!-- éŸ³åœæ­¢ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="overlay">
        <h1 style="color:white;">æ™‚é–“ã§ã™ï¼</h1>
        <button id="stop-btn" onclick="stopAll()">éŸ³ã‚’æ­¢ã‚ã‚‹</button>
    </div>

    <script>
        /* --- ã‚·ã‚¹ãƒ†ãƒ ãƒ»éŸ³å£°å‡¦ç† --- */
        let audioCtx;
        let oscillators = [];
        let isSoundPlaying = false;
        let silentSource = null; // ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ç”¨

        const bc = new BroadcastChannel('alarm_channel');
        bc.onmessage = (e) => { if(e.data === 'STOP') stopAll(); };

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼ˆç„¡éŸ³å†ç”Ÿï¼‰
        function startSilent() {
            initAudio();
            if (silentSource) return;
            const buf = audioCtx.createBuffer(1, 1, 22050);
            silentSource = audioCtx.createBufferSource();
            silentSource.buffer = buf;
            silentSource.loop = true;
            silentSource.connect(audioCtx.destination);
            silentSource.start();
        }

        function stopSilent() {
            if (silentSource) {
                try { silentSource.stop(); } catch(e){}
                silentSource = null;
            }
        }

        // é€šçŸ¥
        function notify() {
            if (Notification.permission === 'granted') {
                const opt = {
                    body: 'ã‚¿ãƒƒãƒ—ã—ã¦åœæ­¢',
                    icon: document.getElementById('pwa-icon').href,
                    tag: 'alarm',
                    renotify: true,
                    requireInteraction: true,
                    actions: [{action:'stop', title:'ğŸ”• åœæ­¢'}]
                };
                if(navigator.serviceWorker && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(r => r.showNotification('çˆ†éŸ³æ™‚è¨ˆ', opt));
                } else {
                    new Notification('çˆ†éŸ³æ™‚è¨ˆ', opt);
                }
            }
        }

        // çˆ†éŸ³å†ç”Ÿ
        function playAlarm() {
            if (isSoundPlaying) return;
            initAudio();
            isSoundPlaying = true;
            
            document.getElementById('overlay').style.display = 'flex';
            notify();

            // 2ã¤ã®ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ä¸å”å’ŒéŸ³ã‚’ä½œã‚‹
            const t = audioCtx.currentTime;
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc1.type = 'square'; osc1.frequency.setValueAtTime(800, t);
            osc2.type = 'sawtooth'; osc2.frequency.setValueAtTime(900, t);

            // éŸ³é‡å¤‰åŒ–
            gain.gain.setValueAtTime(1, t);

            osc1.connect(gain); osc2.connect(gain);
            gain.connect(audioCtx.destination);

            osc1.start(); osc2.start();
            oscillators = [osc1, osc2];

            // ã‚µã‚¤ãƒ¬ãƒ³åŠ¹æœ
            const sirentInt = setInterval(() => {
                if(!isSoundPlaying) { clearInterval(sirentInt); return; }
                const now = audioCtx.currentTime;
                osc1.frequency.linearRampToValueAtTime(1200, now+0.3);
                osc1.frequency.linearRampToValueAtTime(800, now+0.6);
                osc2.frequency.linearRampToValueAtTime(1300, now+0.3);
                osc2.frequency.linearRampToValueAtTime(900, now+0.6);
            }, 600);
        }

        function stopAll() {
            isSoundPlaying = false;
            stopSilent();
            oscillators.forEach(o => { try{o.stop()}catch(e){} });
            oscillators = [];
            document.getElementById('overlay').style.display = 'none';
            if(navigator.serviceWorker) navigator.serviceWorker.ready.then(r => r.getNotifications().then(ns => ns.forEach(n=>n.close())));
        }

        /* --- UIåˆ‡æ›¿ --- */
        function setView(id) {
            initAudio();
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.getElementById('nav-'+id).classList.add('active');
        }

        /* --- ã‚¿ã‚¤ãƒãƒ¼ --- */
        let tmrInt, tmrSec = 0;
        function startTimer() {
            startSilent();
            Notification.requestPermission();
            
            const min = parseInt(document.getElementById('t-min').value)||0;
            const sec = parseInt(document.getElementById('t-sec').value)||0;
            
            // åˆå›é–‹å§‹æ™‚ã®ã¿æ™‚é–“ã‚’ã‚»ãƒƒãƒˆï¼ˆä¸€æ™‚åœæ­¢ã‹ã‚‰ã®å†é–‹æ™‚ã¯ä»Šã®tmrSecã‚’ä½¿ã†ï¼‰
            if(document.getElementById('timer-ui-setup').style.display !== 'none') {
                tmrSec = min * 60 + sec;
            }
            if(tmrSec <= 0) return;

            document.getElementById('timer-ui-setup').style.display = 'none';
            document.getElementById('timer-ui-count').style.display = 'block';
            document.getElementById('btn-t-start').style.display = 'none';
            document.getElementById('btn-t-stop').style.display = 'flex';
            
            updateTimerDisplay();
            
            tmrInt = setInterval(() => {
                tmrSec--;
                updateTimerDisplay();
                if(tmrSec <= 0) {
                    clearInterval(tmrInt);
                    playAlarm();
                    resetTimer();
                }
            }, 1000);
        }
        function updateTimerDisplay() {
            const m = Math.floor(tmrSec/60).toString().padStart(2,'0');
            const s = (tmrSec%60).toString().padStart(2,'0');
            document.getElementById('timer-ui-count').innerText = `${m}:${s}`;
        }
        function stopTimer() {
            clearInterval(tmrInt);
            stopSilent();
            document.getElementById('btn-t-start').style.display = 'flex';
            document.getElementById('btn-t-stop').style.display = 'none';
        }
        function resetTimer() {
            stopTimer();
            document.getElementById('timer-ui-setup').style.display = 'flex';
            document.getElementById('timer-ui-count').style.display = 'none';
        }

        /* --- ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ --- */
        let swInt, swStartT, swElap = 0;
        function startSw() {
            startSilent();
            swStartT = Date.now() - swElap;
            document.getElementById('btn-sw-start').style.display='none';
            document.getElementById('btn-sw-stop').style.display='flex';
            swInt = setInterval(() => {
                swElap = Date.now() - swStartT;
                const date = new Date(swElap);
                const m = date.getUTCMinutes().toString().padStart(2,'0');
                const s = date.getUTCSeconds().toString().padStart(2,'0');
                const ms = Math.floor(date.getUTCMilliseconds()/10).toString().padStart(2,'0');
                document.getElementById('sw-display').innerText = `${m}:${s}.${ms}`;
            }, 16); // 60fps
        }
        function stopSw() {
            clearInterval(swInt);
            stopSilent();
            document.getElementById('btn-sw-start').style.display='flex';
            document.getElementById('btn-sw-stop').style.display='none';
        }
        function resetSw() {
            stopSw();
            swElap = 0;
            document.getElementById('sw-display').innerText = "00:00.00";
        }

        /* --- ã‚¢ãƒ©ãƒ¼ãƒ  --- */
        let alarmInt, isAlarmSet = false, alarmIso = "";
        function toggleAlarm() {
            const inp = document.getElementById('alarm-input');
            const msg = document.getElementById('alarm-msg');
            const btn = document.getElementById('btn-alarm-toggle');

            if(!isAlarmSet) {
                if(!inp.value) return alert('æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                const target = new Date(inp.value);
                if(target < new Date()) return alert('æœªæ¥ã®æ—¥æ™‚ã‚’è¨­å®šã—ã¦ãã ã•ã„');

                Notification.requestPermission().then(p=>{
                    document.getElementById('perm-warn').style.display = (p!=='granted')?'block':'none';
                });
                startSilent();

                isAlarmSet = true;
                alarmIso = inp.value;
                inp.disabled = true;
                btn.innerText = "è§£é™¤";
                btn.classList.add('active');
                msg.innerText = "å¾…æ©Ÿä¸­: " + target.toLocaleString();
                msg.style.color = "#00b84c";

                alarmInt = setInterval(() => {
                    const now = new Date();
                    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã®ISOæ–‡å­—åˆ—(åˆ†ã¾ã§)ã‚’ä½œæˆã—ã¦æ¯”è¼ƒ
                    const nowIso = new Date(now.getTime() - (now.getTimezoneOffset()*60000)).toISOString().slice(0,16);
                    if(nowIso === alarmIso && now.getSeconds() < 2) {
                        playAlarm();
                        toggleAlarm(); // è§£é™¤
                    }
                }, 1000);
            } else {
                isAlarmSet = false;
                clearInterval(alarmInt);
                stopSilent();
                inp.disabled = false;
                btn.innerText = "ã‚¢ãƒ©ãƒ¼ãƒ ã‚»ãƒƒãƒˆ";
                btn.classList.remove('active');
                msg.innerText = "ã‚¢ãƒ©ãƒ¼ãƒ æœªè¨­å®š";
                msg.style.color = "#888";
            }
        }

        /* --- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« --- */
        let defPrompt;
        const instBtn = document.getElementById('install-btn');
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault(); defPrompt = e;
            instBtn.style.display = 'block';
        });
        instBtn.addEventListener('click', () => {
            if(defPrompt) defPrompt.prompt();
            else alert("ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠã—ã¦ãã ã•ã„");
        });
    </script>
</body>
</html>
