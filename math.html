<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>計算トレーニング</title>
    
    <!-- ▼▼▼ 修正点: hrefをJavaScriptで動的に設定するため、idを付与 ▼▼▼ -->
    <link rel="manifest" id="manifest-link">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="計算トレーニング">
    <meta name="theme-color" content="#3498db">

    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #9b59b6;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --dark-color: #34495e;
            --light-color: #f4f7f9;
            --operator-bg-color: #f39c12;
            --operator-checked-bg-color: #e67e22;
            --icon-bg-color: #5f6368;
            --icon-highlight-color: rgba(255, 255, 255, 0.4);
        }
        html, body {
            height: 100%; width: 100%; overflow: hidden;
        }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex; justify-content: center; align-items: center;
            margin: 0; background-color: var(--light-color); color: #333;
            -webkit-user-select: none; user-select: none;
            transition: all 0.2s ease-in-out;
        }
        .container {
            text-align: center; padding: 30px 40px; background-color: #fff;
            border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            width: 90%; max-width: 500px;
        }
        h1, h2 { color: var(--dark-color); }
        .screen { display: none; }
        #start-screen { display: block; }

        button {
            font-size: 1.1em; padding: 12px 25px; margin: 8px; border: none;
            border-radius: 8px; cursor: pointer; color: #fff;
            transition: background-color 0.3s, transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #8e44ad; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #27ae60; }

        #mode-selection button { width: 80%; }
        #time-attack-options, #custom-settings-screen { margin-top: 20px; }

        #install-pwa-btn {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        #install-pwa-btn.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; text-align: left; }
        .setting-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .setting-group input[type="number"] { width: 80%; padding: 8px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; }
        .operators-group { grid-column: 1 / -1; }

        .op-checkboxes { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .op-checkboxes input { display: none; }
        .op-checkboxes label {
            display: inline-flex; justify-content: center; align-items: center;
            width: 70px; height: 70px; background-color: var(--operator-bg-color);
            border: 3px solid transparent; border-radius: 12px; cursor: pointer;
            transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .op-checkboxes label:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
        .op-checkboxes input:checked + label {
            background-color: var(--operator-checked-bg-color);
            border-color: rgba(255, 255, 255, 0.7); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #error-message { color: var(--danger-color); height: 20px; }
        #game-info { display: flex; justify-content: space-between; font-size: 1.4em; font-weight: bold; margin-bottom: 20px; }
        #timer { color: var(--danger-color); }
        #score { color: var(--success-color); }
        #question { font-size: 2.8em; margin: 25px 0; color: var(--dark-color); }
        #answer { font-size: 1.4em; padding: 10px; width: 180px; text-align: center; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 20px; -webkit-user-select: text; user-select: text; }
        #feedback { height: 25px; font-size: 1.2em; font-weight: bold; }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--danger-color); }
        #custom-mode-controls button { font-size: 0.9em; padding: 8px 15px; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        #final-score { font-size: 3.5em; font-weight: bold; color: #e67e22; margin: 15px 0; }
        #memo-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: #fff; }
        .memo-content { width: 100%; height: 100%; position: relative; }
        #memo-canvas { display: block; touch-action: none; }
        .memo-buttons { position: absolute; bottom: 20px; right: 20px; z-index: 2; display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 10px; }
        .tool-btn { border: 2px solid var(--dark-color); background-color: #fff; color: var(--dark-color); }
        .tool-btn.active-tool { background-color: var(--dark-color); color: #fff; }
        #eraser-size-options { display: none; gap: 5px; align-items: center; }
        #eraser-size-options.visible { display: flex; }
        #eraser-size-options .size-btn { padding: 8px; width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ccc; background-color: #fff; color: #333; }
        #eraser-size-options .size-btn.active-size { border-color: var(--primary-color); background-color: #eaf5ff; }
        #eraser-cursor { display: none; position: absolute; border-radius: 50%; border: 1px solid rgba(0, 0, 0, 0.5); background-color: rgba(0, 0, 0, 0.1); pointer-events: none; transform: translate(-50%, -50%); }

        #calculator-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .calculator { width: 280px; background-color: #333; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #calc-display { background-color: #ddd; color: #333; font-size: 2.2em; text-align: right; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        #calc-keys button { font-size: 1.5em; padding: 15px 0; margin: 0; border-radius: 5px; background-color: #555; border: none; }
        #calc-keys .operator { background-color: #f39c12; }
        #close-calc-btn { width: 100%; margin-top: 15px; background-color: var(--danger-color); }

        .keypad-container { margin: 20px auto 0; max-width: 280px; }
        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .keypad-btn { font-size: 1.6em; padding: 15px 0; margin: 0; border-radius: 8px; border: 1px solid #bdc3c7; background-color: #fff; color: #333; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .keypad-btn:active { background-color: #ecf0f1; }
        .keypad-btn.key-enter { background-color: var(--success-color); border-color: var(--success-color); color: #fff; }
        .keypad-btn.key-clear { background-color: var(--danger-color); border-color: var(--danger-color); color: #fff; }

        .calc-icon { position: relative; width: 32px; height: 32px; }
        .calc-icon::before, .calc-icon::after, .calc-icon .icon-bar {
            content: ''; position: absolute; background-color: var(--icon-bg-color);
            background-image: radial-gradient(circle at 4px 4px, var(--icon-highlight-color), transparent 60%);
        }
        .icon-add::before { left: 50%; top: 0; width: 9px; height: 100%; transform: translateX(-50%); border-radius: 4px; }
        .icon-add::after { top: 50%; left: 0; width: 100%; height: 9px; transform: translateY(-50%); border-radius: 4px; }
        .icon-sub::before { top: 50%; left: 0; width: 100%; height: 9px; transform: translateY(-50%); border-radius: 4px; }
        .icon-mul::before, .icon-mul::after { top: 50%; left: 0; width: 105%; height: 9px; margin-top: -4.5px; margin-left: -2.5%; border-radius: 4px; }
        .icon-mul::before { transform: rotate(45deg); }
        .icon-mul::after { transform: rotate(-45deg); }
        .icon-div .icon-bar { top: 50%; left: 0; width: 100%; height: 7px; transform: translateY(-50%); border-radius: 3.5px; background-image: radial-gradient(circle at 4px 3px, var(--icon-highlight-color), transparent 60%); }
        .icon-div::before, .icon-div::after { left: 50%; width: 9px; height: 9px; border-radius: 50%; transform: translateX(-50%); }
        .icon-div::before { top: 0px; }
        .icon-div::after { bottom: 0px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="start-screen" class="screen">
            <h1>計算トレーニング</h1>
            <div id="mode-selection">
                <button class="btn-primary" onclick="showScreen('time-attack-options')">タイムアタックモード</button>
                <button class="btn-secondary" onclick="showScreen('custom-settings-screen')">カスタムモード</button>
                <button id="fullscreen-btn" class="btn-success" onclick="toggleFullScreen()">フルスクリーン</button>
                <button id="install-pwa-btn" class="btn-primary">アプリをダウンロード</button>
            </div>
        </div>
        
        <div id="time-attack-options" class="screen">
            <h2>タイムアタック</h2>
            <p>時間を選択してスタート！</p>
            <button class="btn-primary" onclick="startTimeAttack(10)">10秒</button>
            <button class="btn-primary" onclick="startTimeAttack(20)">20秒</button>
            <button class="btn-primary" onclick="startTimeAttack(30)">30秒</button>
            <br><button class="btn-danger" onclick="showScreen('start-screen')">戻る</button>
        </div>
    
        <div id="custom-settings-screen" class="screen">
            <h2>カスタムモード設定</h2>
            <div class="settings-grid">
                <div class="setting-group"><label for="digits1">数字1の桁数</label><input type="number" id="digits1" value="2" min="1" max="5"></div>
                <div class="setting-group"><label for="digits2">数字2の桁数</label><input type="number" id="digits2" value="2" min="1" max="5"></div>
                <div class="operators-group">
                    <label>計算の種類（複数選択可）</label>
                    <div class="op-checkboxes">
                        <span><input type="checkbox" id="op-add" value="+" checked><label for="op-add"><span class="calc-icon icon-add"></span></label></span>
                        <span><input type="checkbox" id="op-sub" value="-"><label for="op-sub"><span class="calc-icon icon-sub"></span></label></span>
                        <span><input type="checkbox" id="op-mul" value="×"><label for="op-mul"><span class="calc-icon icon-mul"></span></label></span>
                        <span><input type="checkbox" id="op-div" value="÷"><label for="op-div"><span class="calc-icon icon-div"><span class="icon-bar"></span></span></label></span>
                    </div>
                </div>
            </div>
            <div id="error-message"></div>
            <button class="btn-success" onclick="startCustomGame()">スタート</button>
            <button class="btn-danger" onclick="showScreen('start-screen')">戻る</button>
        </div>
    
        <div id="game-screen" class="screen">
            <div id="game-info"><div id="timer"></div><div id="score"></div></div>
            <div id="question">1 + 1</div>
            <input type="tel" id="answer" placeholder="答え" pattern="[0-9-]*" inputmode="numeric" readonly>
            <div id="feedback"></div>
            <div id="custom-mode-controls">
                <button class="btn-danger" onclick="quitGame()">やめる</button>
                <button class="btn-secondary" onclick="openMemo()">ひっ算メモ</button>
                <button class="btn-secondary" onclick="openCalculator()">電卓</button>
            </div>
        </div>
    
        <div id="result-screen" class="screen">
            <h2>タイムアップ！</h2>
            <p>あなたのスコアは...</p>
            <div id="final-score">15 <span>問</span></div>
            <button class="btn-secondary" onclick="showScreen('start-screen')">もう一度挑戦する</button>
        </div>
    </div>
    
    <div id="memo-modal">
        <div class="memo-content">
            <canvas id="memo-canvas"></canvas>
            <div id="eraser-cursor"></div>
            <div class="memo-buttons">
                <div id="eraser-size-options">
                    <button class="size-btn" data-size="10">小</button> <button class="size-btn" data-size="20">中</button> <button class="size-btn" data-size="40">大</button>
                </div>
                <button id="pen-btn" class="tool-btn" onclick="selectTool('pen')">ペン</button> <button id="eraser-btn" class="tool-btn" onclick="selectTool('eraser')">消しゴム</button>
                <button class="btn-danger" onclick="clearCanvas()">全消し</button> <button class="btn-primary" onclick="closeMemo()">閉じる</button>
            </div>
        </div>
    </div>
    
    <div id="calculator-modal">
        <div class="calculator">
            <div id="calc-display">0</div>
            <div id="calc-keys">
                <button class="operator" data-key="clear">C</button> <button data-key="backspace">⌫</button> <button class="operator" data-key="%">%</button> <button class="operator" data-key="/">÷</button>
                <button data-key="7">7</button> <button data-key="8">8</button> <button data-key="9">9</button> <button class="operator" data-key="*">×</button>
                <button data-key="4">4</button> <button data-key="5">5</button> <button data-key="6">6</button> <button class="operator" data-key="-">-</button>
                <button data-key="1">1</button> <button data-key="2">2</button> <button data-key="3">3</button> <button class="operator" data-key="+">+</button>
                <button data-key="0" style="grid-column: 1 / 3;">0</button> <button data-key=".">.</button> <button class="operator" data-key="=">=</button>
            </div>
            <button id="close-calc-btn" onclick="closeCalculator()">閉じる</button>
        </div>
    </div>

<script>
    // --- 定数とグローバル変数の定義 ---
    const allElements = {
        screens: document.querySelectorAll('.screen'), timer: document.getElementById('timer'), score: document.getElementById('score'),
        question: document.getElementById('question'), feedback: document.getElementById('feedback'), answer: document.getElementById('answer'),
        finalScore: document.getElementById('final-score'), customControls: document.getElementById('custom-mode-controls'),
        memo: { modal: document.getElementById('memo-modal'), canvas: document.getElementById('memo-canvas'), ctx: document.getElementById('memo-canvas').getContext('2d'),
            penBtn: document.getElementById('pen-btn'), eraserBtn: document.getElementById('eraser-btn'), cursor: document.getElementById('eraser-cursor'),
            sizeOptions: document.getElementById('eraser-size-options'), sizeBtns: document.querySelectorAll('.size-btn') },
        calc: { modal: document.getElementById('calculator-modal'), display: document.getElementById('calc-display'), keys: document.getElementById('calc-keys') }
    };
    let gameState = { mode: '', settings: {}, correctAnswer: 0, score: 0, timeLeft: 0, timerInterval: null };
    
    // --- ゲームロジックなど (変更なし) ---
    function showScreen(id) { allElements.screens.forEach(s => s.style.display = 'none'); document.getElementById(id).style.display = 'block'; }
    function startTimeAttack(sec) {
        Object.assign(gameState, { mode: 'time-attack', score: 0, timeLeft: sec });
        showScreen('game-screen');
        allElements.timer.style.display = 'block'; allElements.customControls.style.display = 'none';
        allElements.score.textContent = `スコア: ${gameState.score}`; allElements.timer.textContent = `時間: ${gameState.timeLeft}`;
        generateQuestion(); allElements.answer.focus();
        gameState.timerInterval = setInterval(() => { gameState.timeLeft--; allElements.timer.textContent = `時間: ${gameState.timeLeft}`; if (gameState.timeLeft <= 0) endGame(); }, 1000);
    }
    function endGame() { clearInterval(gameState.timerInterval); showScreen('result-screen'); allElements.finalScore.innerHTML = `${gameState.score} <span>問</span>`; }
    function startCustomGame() {
        const d1 = parseInt(document.getElementById('digits1').value), d2 = parseInt(document.getElementById('digits2').value), ops = Array.from(document.querySelectorAll('.op-checkboxes input:checked')).map(el => el.value);
        if (ops.length === 0) { document.getElementById('error-message').textContent = '計算の種類を1つ以上選んでください。'; return; }
        document.getElementById('error-message').textContent = '';
        Object.assign(gameState, { settings: { digits1: d1, digits2: d2, operators: ops }, mode: 'custom', score: 0 });
        showScreen('game-screen');
        allElements.timer.style.display = 'none'; allElements.customControls.style.display = 'block';
        allElements.score.textContent = `正解数: ${gameState.score}`; generateQuestion(); allElements.answer.focus();
    }
    function quitGame() { showScreen('start-screen'); if (gameState.timerInterval) clearInterval(gameState.timerInterval); }
    function getRandomNumberByDigits(d) { return Math.floor(Math.random() * (10**d - 10**(d-1))) + 10**(d-1); }
    function generateQuestion() {
        allElements.feedback.textContent = ''; let n1, n2, op, qText;
        if (gameState.mode === 'time-attack') {
            const operators = ['+', '-', '×', '÷']; op = operators[Math.floor(Math.random() * operators.length)];
            if (op === '÷') { n2 = Math.floor(Math.random() * 9) + 2; const res = Math.floor(Math.random() * 9) + 2; n1 = n2 * res; }
            else { n1 = Math.floor(Math.random() * 10) + 1; n2 = Math.floor(Math.random() * 10) + 1; }
        } else { 
            n1 = getRandomNumberByDigits(gameState.settings.digits1); n2 = getRandomNumberByDigits(gameState.settings.digits2);
            op = gameState.settings.operators[Math.floor(Math.random() * gameState.settings.operators.length)]; 
        }
        switch (op) {
            case '+': qText = `${n1} + ${n2}`; gameState.correctAnswer = n1 + n2; break;
            case '-': if (n1 < n2) [n1, n2] = [n2, n1]; qText = `${n1} - ${n2}`; gameState.correctAnswer = n1 - n2; break;
            case '×': qText = `${n1} × ${n2}`; gameState.correctAnswer = n1 * n2; break;
            case '÷':
                let dividend = n1 * n2;
                if (Math.random() > 0.5) { qText = `${dividend} ÷ ${n1}`; gameState.correctAnswer = n2; }
                else { qText = `${dividend} ÷ ${n2}`; gameState.correctAnswer = n1; }
                break;
        }
        allElements.question.textContent = qText; allElements.answer.value = '';
    }
    function checkAnswer() {
        if (allElements.answer.value === '') return;
        const userAnswer = parseInt(allElements.answer.value.replace(/,/g, ''), 10);
        if (!isNaN(userAnswer)) {
            if (userAnswer === gameState.correctAnswer) { 
                gameState.score++; allElements.feedback.textContent = "○ 正解！"; allElements.feedback.className = 'correct'; 
            } else { 
                allElements.feedback.textContent = `× 不正解 (答え: ${gameState.correctAnswer.toLocaleString()})`; allElements.feedback.className = 'incorrect'; 
            }
            allElements.score.textContent = gameState.mode === 'time-attack' ? `スコア: ${gameState.score}` : `正解数: ${gameState.score}`;
            if (gameState.mode !== 'time-attack') { setTimeout(generateQuestion, 400); } else { generateQuestion(); }
        }
    }
    allElements.answer.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
    function toggleFullScreen() {
        if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(() => {}); } 
        else { document.exitFullscreen(); }
    }
    let memoState = { isDrawing: false, lastX: 0, lastY: 0, tool: 'pen', eraserSize: 20 };
    function resizeCanvas() { const { canvas, ctx } = allElements.memo; canvas.width = window.innerWidth; canvas.height = window.innerHeight; selectTool(memoState.tool); setEraserSize(memoState.eraserSize); }
    function getPos(e) { const rect = allElements.memo.canvas.getBoundingClientRect(), touch = e.touches ? e.touches[0] : e; return { x: touch.clientX - rect.left, y: touch.clientY - rect.top }; }
    function updateCursor(e) { if (memoState.tool === 'eraser') { const { x, y } = getPos(e); Object.assign(allElements.memo.cursor.style, { left: `${x}px`, top: `${y}px`, display: 'block' }); } }
    function startDrawing(e) { e.preventDefault(); memoState.isDrawing = true; const { x, y } = getPos(e); [memoState.lastX, memoState.lastY] = [x, y]; if (memoState.tool === 'eraser') { const { ctx } = allElements.memo; ctx.beginPath(); ctx.arc(x, y, memoState.eraserSize / 2, 0, Math.PI * 2); ctx.fill(); } }
    function draw(e) {
        if (!memoState.isDrawing) return; e.preventDefault(); const { x, y } = getPos(e); const { ctx } = allElements.memo;
        if (memoState.tool === 'pen') { ctx.beginPath(); ctx.moveTo(memoState.lastX, memoState.lastY); ctx.lineTo(x, y); ctx.stroke(); }
        else { const dist = Math.hypot(x - memoState.lastX, y - memoState.lastY), angle = Math.atan2(y - memoState.lastY, x - memoState.lastX); for (let i = 0; i < dist; i++) { const newX = memoState.lastX + Math.cos(angle) * i, newY = memoState.lastY + Math.sin(angle) * i; ctx.beginPath(); ctx.arc(newX, newY, memoState.eraserSize / 2, 0, Math.PI * 2); ctx.fill(); } }
        [memoState.lastX, memoState.lastY] = [x, y]; updateCursor(e);
    }
    function stopDrawing() { memoState.isDrawing = false; }
    function selectTool(tool) {
        const { ctx, penBtn, eraserBtn, cursor, sizeOptions } = allElements.memo; memoState.tool = tool;
        if (tool === 'pen') { Object.assign(ctx, { globalCompositeOperation: 'source-over', lineWidth: 3, lineCap: 'round' }); penBtn.classList.add('active-tool'); eraserBtn.classList.remove('active-tool'); cursor.style.display = 'none'; sizeOptions.classList.remove('visible'); }
        else { ctx.globalCompositeOperation = 'destination-out'; penBtn.classList.remove('active-tool'); eraserBtn.classList.add('active-tool'); Object.assign(cursor.style, { width: `${memoState.eraserSize}px`, height: `${memoState.eraserSize}px` }); sizeOptions.classList.add('visible'); }
    }
    function setEraserSize(size) { memoState.eraserSize = size; allElements.memo.sizeBtns.forEach(btn => btn.classList.toggle('active-size', parseInt(btn.dataset.size) === size)); if (memoState.tool === 'eraser') { Object.assign(allElements.memo.cursor.style, { width: `${size}px`, height: `${size}px` }); } }
    function openMemo() { allElements.memo.modal.style.display = 'block'; resizeCanvas(); window.addEventListener('resize', resizeCanvas); }
    function closeMemo() { allElements.memo.modal.style.display = 'none'; window.removeEventListener('resize', resizeCanvas); }
    function clearCanvas() { const { ctx, canvas } = allElements.memo; ctx.clearRect(0, 0, canvas.width, canvas.height); }
    function setupCanvasEvents() {
        const { canvas, cursor, sizeBtns } = allElements.memo;
        ['mousedown', 'touchstart'].forEach(evt => canvas.addEventListener(evt, startDrawing, { passive: false }));
        ['mousemove', 'touchmove'].forEach(evt => { canvas.addEventListener(evt, draw, { passive: false }); canvas.addEventListener(evt, updateCursor, { passive: false }); });
        ['mouseup', 'touchend'].forEach(evt => canvas.addEventListener(evt, stopDrawing));
        canvas.addEventListener('mouseout', () => cursor.style.display = 'none');
        sizeBtns.forEach(btn => btn.addEventListener('click', () => setEraserSize(parseInt(btn.dataset.size))));
    }
    const calculator = { displayValue: '0', firstOperand: null, waitingForSecondOperand: false, operator: null };
    function openCalculator() { allElements.calc.modal.style.display = 'flex'; }
    function closeCalculator() { allElements.calc.modal.style.display = 'none'; }
    function updateCalcDisplay() { allElements.calc.display.textContent = calculator.displayValue; }
    function handleCalcKeyPress(e) {
        const { key } = e.target.dataset; if (!key) return;
        if (!isNaN(parseInt(key))) { inputDigit(key); }
        else if (key === '.') { inputDecimal(key); }
        else if (key === 'clear') { resetCalculator(); }
        else if (key === 'backspace') { inputBackspace(); }
        else { handleOperator(key); }
        updateCalcDisplay();
    }
    function inputDigit(digit) { const { displayValue, waitingForSecondOperand } = calculator; if (waitingForSecondOperand) { calculator.displayValue = digit; calculator.waitingForSecondOperand = false; } else { calculator.displayValue = displayValue === '0' ? digit : displayValue + digit; } }
    function inputDecimal(dot) { if (!calculator.displayValue.includes(dot)) { calculator.displayValue += dot; } }
    function inputBackspace() { calculator.displayValue = calculator.displayValue.length > 1 ? calculator.displayValue.slice(0, -1) : '0'; }
    function handleOperator(nextOperator) {
        const { firstOperand, displayValue, operator } = calculator; const inputValue = parseFloat(displayValue);
        if (operator && calculator.waitingForSecondOperand) { calculator.operator = nextOperator; return; }
        if (firstOperand == null && !isNaN(inputValue)) { calculator.firstOperand = inputValue; }
        else if (operator) { const result = { '/': (f, s) => f / s, '*': (f, s) => f * s, '+': (f, s) => f + s, '-': (f, s) => f - s, '=': (f, s) => s, '%': (f,s) => f % s }[operator](firstOperand, inputValue); calculator.displayValue = `${parseFloat(result.toFixed(7))}`; calculator.firstOperand = result; }
        calculator.waitingForSecondOperand = true; calculator.operator = nextOperator;
    }
    function resetCalculator() { Object.assign(calculator, { displayValue: '0', firstOperand: null, waitingForSecondOperand: false, operator: null }); }
    function createKeypad() {
        if (document.getElementById('keypad-container')) return; const container = document.createElement('div'); container.id = 'keypad-container'; container.className = 'keypad-container'; const grid = document.createElement('div'); grid.className = 'keypad-grid';
        ['7','8','9','4','5','6','1','2','3','C','0','Enter'].forEach(key => {
            const button = document.createElement('button'); button.textContent = key; button.dataset.key = key; button.className = 'keypad-btn';
            if (key === 'Enter') button.classList.add('key-enter'); if (key === 'C') button.classList.add('key-clear'); grid.appendChild(button);
        });
        container.appendChild(grid); allElements.answer.insertAdjacentElement('afterend', container);
        container.addEventListener('click', (e) => { if (e.target.classList.contains('keypad-btn')) { if (!isNaN(parseInt(e.target.dataset.key))) { allElements.answer.value += e.target.dataset.key; } else if (e.target.dataset.key === 'C') { allElements.answer.value = ''; } else if (e.target.dataset.key === 'Enter') { checkAnswer(); } } });
    }
    
    // --- PWAと初期化処理 ---
    window.addEventListener('load', () => {
        let deferredPrompt;
        const installButton = document.getElementById('install-pwa-btn');

        // ▼▼▼ 修正点: ManifestとService Workerのコードをここに集約 ▼▼▼

        // 1. Manifestの内容をJavaScriptオブジェクトとして定義
        const manifestContent = {
            "name": "計算トレーニング",
            "short_name": "計算トレ",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#3498db",
            "description": "シンプルな計算トレーニングアプリです。",
            "icons": [
                {
                    "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAACFUlEQVR4nO3dy23DMAwFUB/dARzAKmwEG9gBbAAbwAZwQwiRQAJ2gA3gAIFkStsOkS3HkTzqn3JLCR/gA34vFhcBAAAAAAAAAAAAAAAAAAAAAMApl7l+AND+aQMyQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAKkARkgAZIACZAACZAACZAACZAGTICc/2sAEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABMkACJEAypAEZIAGSgAxIABdAAiRAAiRAAiRAAqQBGZAAEiABGSABGSABGSABGSABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABEiABkoAMyAB/AkkgAZKADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMiADMgASQAAmQAAmQAAmQBGSAAAAAAAAAAAAAAAAAAAAAgLk+A/k9B9/p96j+AAAAAElFTkSuQmCC",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAEH0lEQVR4nO3dUW7bMBQAQf//9+gBHFQkL1AcaJMFV+wgARxUAjgKFGk+x/rYcyTx7/8DAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMC/A/g1AX8/A/4fAMwACZAA7gAZkAAvgAQkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAIkQAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAiRAAi-D8A7J+R3g8yEAAAAASUVORK5CYII=",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        // manifestオブジェクトをBlobに変換し、URLを生成してlinkタグに設定
        const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('#manifest-link').setAttribute('href', manifestURL);

        // 2. Service Workerのコードを文字列として定義
        const swScriptContent = `
            const CACHE_NAME = 'calc-training-cache-v3';
            const urlsToCache = ['./', './index.html'];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request).then(response => response || fetch(event.request))
                );
            });

            self.addEventListener('activate', event => {
                const cacheWhitelist = [CACHE_NAME];
                event.waitUntil(
                    caches.keys().then(cacheNames => Promise.all(
                        cacheNames.map(cacheName => {
                            if (cacheWhitelist.indexOf(cacheName) === -1) {
                                return caches.delete(cacheName);
                            }
                        })
                    ))
                );
            });
        `;
        // Service Workerの文字列をBlobに変換し、URLを生成
        const swBlob = new Blob([swScriptContent], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(swBlob);

        // 3. Service Workerを登録
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swURL)
                .then(registration => console.log('Service worker registration successful:', registration))
                .catch(err => console.error('Service worker registration failed:', err));
        }
        
        // 4. インストールプロンプトのロジック
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.add('visible');
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                installButton.classList.remove('visible');
            }
        });

        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            installButton.classList.remove('visible');
        });
        
        // ▲▲▲ 修正点ここまで ▲▲▲

        // --- その他の初期化処理 ---
        setupCanvasEvents();
        selectTool('pen');
        setEraserSize(20);
        createKeypad();
        allElements.calc.keys.addEventListener('click', handleCalcKeyPress);
        updateCalcDisplay();
    });
</script>

</body>
</html>
