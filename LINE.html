<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>P2P Chat</title>
<!-- ã‚¢ã‚¤ã‚³ãƒ³è‡ªå‹•ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
(function() {
    window.addEventListener('DOMContentLoaded', function() {
        var canvas = document.createElement('canvas');
        canvas.width = 192; canvas.height = 192;
        var ctx = canvas.getContext('2d');
        // èƒŒæ™¯ï¼ˆç·‘ï¼‰
        ctx.fillStyle = '#2ecc71';
        ctx.beginPath(); ctx.roundRect(0,0,192,192,40); ctx.fill();
        // å¹ãå‡ºã—ï¼ˆç™½ï¼‰
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.moveTo(46,60); ctx.lineTo(146,60);
        ctx.quadraticCurveTo(156,60,156,70); ctx.lineTo(156,120);
        ctx.quadraticCurveTo(156,130,146,130); ctx.lineTo(106,130);
        ctx.lineTo(86,150); ctx.lineTo(76,130); ctx.lineTo(46,130);
        ctx.quadraticCurveTo(36,130,36,120); ctx.lineTo(36,70);
        ctx.quadraticCurveTo(36,60,46,60); ctx.fill();
        var url = canvas.toDataURL('image/png');
        // ã‚¿ã‚°ç”Ÿæˆ
        var link = document.createElement('link'); link.rel = 'icon'; link.href = url; document.head.appendChild(link);
        var atLink = document.createElement('link'); atLink.rel = 'apple-touch-icon'; atLink.href = url; document.head.appendChild(atLink);
    });
})();
</script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- å…¨ä½“è¨­å®š --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html {
        width: 100%; height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        background-color: #000; color: #333; overflow: hidden;
    }
    #app-root {
        width: 100%; height: 100%; position: relative; background: #fff;
        max-width: 600px; margin: 0 auto;
    }

    /* --- ç”»é¢åˆ¶å¾¡ --- */
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f2f2f7; display: none; flex-direction: column;
        z-index: 10; transition: transform 0.3s ease-in-out;
    }
    .screen.active { display: flex; transform: translateX(0); }
    .screen.next { display: flex; transform: translateX(100%); z-index: 20; }
    #screen-login { z-index: 100; background-color: #2c363f; color: white; align-items: center; justify-content: center; }

    /* --- ãƒ‘ãƒ¼ãƒ„ --- */
    .header {
        height: 50px; background-color: #2c363f; color: white;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px; padding-top: env(safe-area-inset-top);
        font-weight: bold; font-size: 16px; flex-shrink: 0;
    }
    .header-btn { font-size: 24px; cursor: pointer; min-width: 40px; text-align: center; }
    .scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* ãƒœã‚¿ãƒ³ */
    .btn { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 12px; width: 100%; font-size: 15px; margin-bottom: 10px; }
    .btn-green { background: #2ecc71; color: white; }
    .btn-red { background: #ff3b30; color: white; }
    .btn-gray { background: #eee; color: #333; }
    .btn-dark { background: #2c363f; color: white; }
    .btn-blue { background: #007bff; color: white; }

    /* 0. ãƒ­ã‚°ã‚¤ãƒ³ */
    .login-box { width: 80%; text-align: center; }
    .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; text-align: center; font-weight:bold; }

    /* 1. ãƒ›ãƒ¼ãƒ  */
    #screen-home { background-color: white; }
    .my-profile { padding: 20px 15px; display: flex; align-items: center; border-bottom: 10px solid #f2f2f7; cursor: pointer; }
    .avatar {
        width: 54px; height: 54px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-size: 26px; color: #fff; margin-right: 15px; flex-shrink: 0; background-color: #ccc;
        background-size: cover; background-position: center; border: 1px solid rgba(0,0,0,0.1);
    }
    .friend-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; background: white; }
    .friend-item:active { background: #f9f9f9; }

    /* 2. è¨­å®š */
    #screen-settings { background-color: #f2f2f7; }
    .settings-card { background: white; margin: 20px; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .color-picker { display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
    .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.3); }
    .color-dot.selected { border-color: #333; transform: scale(1.1); }
    .emoji-input { width: 60px; font-size: 30px; text-align: center; border: 1px solid #ddd; border-radius: 5px; margin-left: 10px; }

    /* 3. ãƒˆãƒ¼ã‚¯ */
    #screen-chat { background-color: #7297c8; }
    .chat-bg { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
    .msg { display: flex; margin-bottom: 15px; max-width: 85%; align-items: flex-end; }
    .msg.me { align-self: flex-end; flex-direction: row-reverse; }
    .msg.you { align-self: flex-start; }
    .msg-bubble { padding: 9px 12px; border-radius: 14px; font-size: 15px; line-height: 1.4; word-break: break-all; position: relative; max-width: 100%; }
    .msg.me .msg-bubble { background: #8de055; color: black; border-top-right-radius: 2px; }
    .msg.you .msg-bubble { background: white; color: black; border-top-left-radius: 2px; }
    
    .msg-image { max-width: 200px; border-radius: 10px; display: block; margin: 5px 0; cursor: pointer; }
    .msg-file-link { display: inline-block; padding: 10px; background: #eee; border-radius: 5px; text-decoration: none; color: #333; font-size: 12px; }
    .msg-meta { display: flex; flex-direction: column; align-items: flex-end; margin: 0 5px; }
    .msg-time { font-size: 10px; color: white; }
    .read-mark { font-size: 10px; color: yellow; display: none; margin-bottom: 2px; }
    .msg.me .read-mark.is-read { display: block; }

    .chat-input-area { background: white; padding: 10px; display: flex; align-items: center; border-top: 1px solid #ddd; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
    #msg-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; background: #f5f5f5; font-size: 16px; outline: none; }
    .attach-btn { font-size: 24px; color: #666; margin-right: 10px; cursor: pointer; padding: 0 5px; }
    .chat-status { font-size: 10px; font-weight: normal; margin-left: 5px; opacity: 0.8; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 200; }
    .modal-card { background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 12px; text-align: center; }
    .fab-btn { position: absolute; bottom: 30px; right: 20px; width: 56px; height: 56px; background: #2c363f; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 50; }
    .blocked-bar { background: #555; color: white; text-align: center; padding: 10px; font-size: 12px; display: none; }
    #icon-file-input, #chat-file-input { display: none; }
    #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; z-index: 300; display: none; }
</style>
</head>
<body>

<div id="toast">é€šçŸ¥</div>

<div id="app-root">
    <!-- 0. ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h1 style="margin-bottom:20px;">P2P Chat</h1>
            <p style="font-size:13px; color:#ccc;">IDã‚’æ±ºã‚ã¦ãã ã•ã„</p>
            <input type="text" id="login-id" class="login-input" placeholder="ID (ä¾‹: taro)">
            <p style="font-size:13px; color:#ccc;">è¡¨ç¤ºå</p>
            <input type="text" id="login-name" class="login-input" placeholder="åå‰ (ä¾‹: ç”°ä¸­)">
            <p id="login-error" style="color:#ff6b6b; font-size:13px; min-height:20px;"></p>
            <button class="btn btn-green" onclick="startApp()">åˆ©ç”¨é–‹å§‹</button>
        </div>
    </div>

    <!-- 1. ãƒ›ãƒ¼ãƒ  -->
    <div id="screen-home" class="screen">
        <header class="header">
            <div>å‹ã ã¡</div>
            <div class="header-btn" onclick="openSettings()">âš™</div>
        </header>
        <div class="scroll-content">
            <div class="my-profile" onclick="openMyQR()">
                <div class="avatar" id="home-avatar">ğŸ‘¤</div>
                <div>
                    <div id="home-name" style="font-weight:bold; font-size:16px;">è‡ªåˆ†</div>
                    <div id="home-id" style="font-size:12px; color:#888;">ID: ---</div>
                </div>
                <div style="margin-left:auto; font-size:24px; color:#ccc;">â–’</div>
            </div>
            <div style="padding:10px 15px; font-size:12px; color:#666; background:#f9f9f9;">å‹ã ã¡ãƒªã‚¹ãƒˆ</div>
            <div id="friend-list"></div>
        </div>
        <div class="fab-btn" onclick="openAddModal()">ï¼‹</div>
    </div>

    <!-- 2. è¨­å®š -->
    <div id="screen-settings" class="screen next">
        <header class="header">
            <div class="header-btn" onclick="closeSettings()">ï¼œ</div>
            <div style="flex:1; text-align:center;">è¨­å®š</div>
            <div style="width:40px;"></div>
        </header>
        <div class="scroll-content">
            <div class="settings-card">
                <h3>ã‚¢ã‚¤ã‚³ãƒ³ç·¨é›†</h3>
                <div style="margin:15px 0;">
                    <div class="avatar" id="preview-avatar" style="width:80px; height:80px; font-size:40px; margin:0 auto;">ğŸ‘¤</div>
                </div>
                <button class="btn btn-blue" onclick="document.getElementById('icon-file-input').click()">ç”»åƒã‚’é¸æŠã™ã‚‹</button>
                <input type="file" id="icon-file-input" accept="image/*" onchange="handleIconUpload(event)">
                <button class="btn btn-gray" onclick="resetToEmoji()" style="font-size:12px; padding:8px;">ç”»åƒã‚’ã‚„ã‚ã¦æ–‡å­—ã«ã™ã‚‹</button>
                <hr style="margin:15px 0; border:none; border-top:1px solid #eee;">
                <p style="font-size:12px; color:#888;">ã¾ãŸã¯è‰²ã¨æ–‡å­—ã‚’é¸æŠ</p>
                <div class="color-picker" id="color-picker"></div>
                <div style="display:flex; justify-content:center; align-items:center; margin:15px 0;">
                    <span>æ–‡å­—: </span>
                    <input type="text" id="edit-char" class="emoji-input" maxlength="1" value="ğŸ‘¤">
                </div>
                <button class="btn btn-dark" onclick="saveIcon()">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
            </div>
            <div style="margin-top:20px; padding:20px; text-align:center;">
                <p style="font-size:12px; color:#666;">ç¾åœ¨ã®ID: <span id="settings-id-disp" style="font-weight:bold;">---</span></p>
                <button class="btn btn-red" onclick="changeID()">IDã‚’å¤‰æ›´ (åˆæœŸåŒ–)</button>
            </div>
        </div>
    </div>

    <!-- 3. ãƒˆãƒ¼ã‚¯ -->
    <div id="screen-chat" class="screen next">
        <header class="header">
            <div class="header-btn" onclick="closeChat()">ï¼œ</div>
            <div style="flex:1; text-align:center; display:flex; flex-direction:column; justify-content:center;">
                <div id="chat-title" style="line-height:1.2;">ç›¸æ‰‹</div>
                <div id="chat-status" class="chat-status">æ¥ç¶šä¸­...</div>
            </div>
            <div class="header-btn" onclick="openChatMenu()">â‰¡</div>
        </header>
        <div class="blocked-bar" id="block-bar">ğŸš« ãƒ–ãƒ­ãƒƒã‚¯ä¸­</div>
        <div class="chat-bg" id="msg-area"></div>
        <div class="chat-input-area" id="input-area">
            <div class="attach-btn" onclick="document.getElementById('chat-file-input').click()">ï¼‹</div>
            <input type="file" id="chat-file-input" onchange="handleChatFileUpload(event)">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
            <button onclick="sendText()" style="margin-left:10px; border:none; background:none; color:#007bff; font-weight:bold; font-size:16px;">é€ä¿¡</button>
        </div>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ -->
<div id="modal-qr" class="modal-overlay" onclick="closeModal('modal-qr')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <h3>ãƒã‚¤ID</h3>
        <img id="qr-img" src="" style="width:150px; margin:15px auto; display:block;">
        <div id="qr-text" style="font-weight:bold; font-size:20px; user-select:text; margin-bottom:15px;"></div>
        <button class="btn btn-gray" onclick="closeModal('modal-qr')">é–‰ã˜ã‚‹</button>
    </div>
</div>
<div id="modal-add" class="modal-overlay">
    <div class="modal-card">
        <h3>å‹ã ã¡è¿½åŠ </h3>
        <input type="text" id="add-id" class="login-input" style="border:1px solid #ddd; text-align:left;" placeholder="ç›¸æ‰‹ã®ID">
        <input type="text" id="add-name" class="login-input" style="border:1px solid #ddd; text-align:left;" placeholder="ç›¸æ‰‹ã®åå‰">
        <button class="btn btn-dark" onclick="addFriend()">è¿½åŠ ã™ã‚‹</button>
        <button class="btn btn-gray" onclick="closeModal('modal-add')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>
<div id="modal-menu" class="modal-overlay" onclick="closeModal('modal-menu')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <h3 id="menu-target-name" style="margin-bottom:15px;">è¨­å®š</h3>
        <button class="btn" id="btn-block-toggle" onclick="toggleBlock()" style="background:#eee; margin-bottom:10px;">ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹</button>
        <button class="btn btn-red" onclick="deleteFriend()">å‹ã ã¡å‰Šé™¤</button>
        <button class="btn btn-gray" onclick="closeModal('modal-menu')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    const colors = ['#ccc', '#ef5350', '#ab47bc', '#5c6bc0', '#29b6f6', '#26a69a', '#9ccc65', '#ffca28', '#ff7043', '#8d6e63'];
    const KEY_ID='p2p_stb_id', KEY_NAME='p2p_stb_name', KEY_ICON='p2p_stb_icon', KEY_FRIENDS='p2p_stb_friends';
    let myId = localStorage.getItem(KEY_ID);
    let myName = localStorage.getItem(KEY_NAME);
    let myIcon = JSON.parse(localStorage.getItem(KEY_ICON)) || { type:'text', color:'#ccc', char:'ğŸ‘¤', imageData:null };
    let friends = JSON.parse(localStorage.getItem(KEY_FRIENDS)) || [];
    let peer = null;
    let connections = {};
    let currentChatId = null;
    let tempIconData = null; 
    let tempIconType = 'text';
    let heartBeatInterval = null;

    const picker = document.getElementById('color-picker');
    colors.forEach(c => {
        const dot = document.createElement('div');
        dot.className = 'color-dot';
        dot.style.backgroundColor = c;
        dot.onclick = () => selectColor(c, dot);
        picker.appendChild(dot);
    });
    document.getElementById('edit-char').addEventListener('input', (e) => {
        tempIconType = 'text';
        updatePreview(document.getElementById('preview-avatar'), { type:'text', color: getCurrentColor(), char: e.target.value });
    });

    if (myId && myName) {
        document.getElementById('login-id').value = myId;
        document.getElementById('login-name').value = myName;
        setTimeout(startApp, 500);
    }

    function startApp() {
        const idVal = document.getElementById('login-id').value.trim();
        const nameVal = document.getElementById('login-name').value.trim();
        if(!idVal || !nameVal) return alert("IDã¨åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        const btn = document.querySelector('#screen-login .btn');
        btn.disabled = true; btn.innerText = "æ¥ç¶šä¸­...";
        peer = new Peer(idVal, { debug: 1 });
        peer.on('open', (id) => {
            myId = id; myName = nameVal;
            localStorage.setItem(KEY_ID, myId);
            localStorage.setItem(KEY_NAME, myName);
            updateHomeProfile();
            document.getElementById('screen-login').style.display = 'none'; 
            document.getElementById('screen-home').classList.add('active');
            reconnectFriends();
            startHeartbeat();
            btn.disabled = false; btn.innerText = "åˆ©ç”¨é–‹å§‹";
        });
        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') alert("IDãŒæ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™");
            else if(err.type !== 'peer-unavailable') showToast("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.type);
            btn.disabled = false; btn.innerText = "åˆ©ç”¨é–‹å§‹";
        });
        peer.on('connection', conn => setupConnection(conn));
        peer.on('disconnected', () => { showToast("å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™"); peer.reconnect(); });
    }

    function openSettings() {
        document.getElementById('settings-id-disp').innerText = myId;
        tempIconType = myIcon.type; tempIconData = myIcon.imageData;
        document.getElementById('edit-char').value = myIcon.char;
        updatePreview(document.getElementById('preview-avatar'), myIcon);
        slideScreen('screen-settings', 'open');
    }
    function closeSettings() { slideScreen('screen-settings', 'close'); }

    function handleIconUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        resizeImage(file, 150, (base64) => {
            tempIconData = base64; tempIconType = 'image';
            updatePreview(document.getElementById('preview-avatar'), { type:'image', imageData: base64 });
        });
    }
    function resizeImage(file, maxSize, callback) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if(w > h){ if(w>maxSize){ h*=maxSize/w; w=maxSize; }}
                else { if(h>maxSize){ w*=maxSize/h; h=maxSize; }}
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                callback(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    function resetToEmoji() {
        tempIconType = 'text';
        updatePreview(document.getElementById('preview-avatar'), { type:'text', color: getCurrentColor(), char: document.getElementById('edit-char').value });
    }
    function selectColor(color, el) {
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
        if(el) el.classList.add('selected');
        tempIconType = 'text';
        updatePreview(document.getElementById('preview-avatar'), { type:'text', color: color, char: document.getElementById('edit-char').value });
        document.getElementById('preview-avatar').dataset.color = color;
    }
    function getCurrentColor() { return document.getElementById('preview-avatar').dataset.color || '#ccc'; }
    function updatePreview(el, icon) {
        if (icon.type === 'image' && icon.imageData) {
            el.style.backgroundImage = `url(${icon.imageData})`; el.innerText = ''; el.style.backgroundColor = 'transparent';
        } else {
            el.style.backgroundImage = 'none'; el.style.backgroundColor = icon.color || '#ccc';
            el.innerText = icon.char || 'ğŸ‘¤'; if(icon.color) el.dataset.color = icon.color;
        }
    }
    function saveIcon() {
        myIcon = { type: tempIconType, imageData: tempIconData, color: getCurrentColor(), char: document.getElementById('edit-char').value || 'ğŸ‘¤' };
        localStorage.setItem(KEY_ICON, JSON.stringify(myIcon));
        updateHomeProfile(); closeSettings(); showToast("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }
    function updateHomeProfile() {
        updatePreview(document.getElementById('home-avatar'), myIcon);
        document.getElementById('home-name').innerText = myName;
        document.getElementById('home-id').innerText = "ID: " + myId;
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${myId}`;
        document.getElementById('qr-text').innerText = myId;
    }
    function changeID() { if(confirm("IDã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem(KEY_ID); location.reload(); } }

    function setupConnection(conn) {
        if (connections[conn.peer] && connections[conn.peer].open) connections[conn.peer].close();
        connections[conn.peer] = conn;
        conn.on('open', () => updateChatStatus(conn.peer, true));
        conn.on('data', data => handleReceive(conn.peer, data));
        conn.on('close', () => { delete connections[conn.peer]; updateChatStatus(conn.peer, false); });
    }
    function reconnectFriends() {
        friends.forEach(f => { if(!connections[f.id] || !connections[f.id].open) connectToPeer(f.id); });
        renderFriendList();
    }
    function connectToPeer(id) { if(peer && !peer.destroyed) setupConnection(peer.connect(id)); }
    function startHeartbeat() {
        if(heartBeatInterval) clearInterval(heartBeatInterval);
        heartBeatInterval = setInterval(() => {
            friends.forEach(f => {
                const conn = connections[f.id];
                if(conn && conn.open) conn.send({ type: 'ping' });
                else connectToPeer(f.id);
            });
        }, 5000);
    }
    function handleReceive(senderId, data) {
        if(data.type === 'ping') return;
        let friend = friends.find(f => f.id === senderId);
        if (friend && friend.isBlocked) return;
        if (data.type === 'read_signal') {
            if(friend) {
                friend.history.forEach(msg => { if(msg.isMe) msg.isRead = true; });
                saveFriends(); if(currentChatId === senderId) renderMessages(friend);
            }
            return;
        }
        if (!friend) {
            friend = { id: senderId, name: "æœªç™»éŒ²", history: [], isBlocked: false, icon: {type:'text'} };
            friends.push(friend);
        }
        if (data.senderIcon) friend.icon = data.senderIcon;
        if (data.senderName) friend.name = data.senderName;
        const msgObj = { type: data.contentType || 'text', content: data.content, fileName: data.fileName, time: data.time, isMe: false, isRead: false };
        friend.history.push(msgObj);
        saveFriends();
        if (currentChatId === senderId) { renderMessages(friend); scrollToBottom(); sendReadSignal(senderId); }
        else { renderFriendList(); showToast("æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"); }
    }
    function sendReadSignal(targetId) {
        const conn = connections[targetId];
        if(conn && conn.open) conn.send({ type: 'read_signal' });
    }
    function sendData(type, content, fileName = null) {
        if (!currentChatId) return;
        const friend = friends.find(f => f.id === currentChatId);
        if (friend && friend.isBlocked) return alert("ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã§ã™");
        const time = new Date().getHours().toString().padStart(2,'0') + ":" + new Date().getMinutes().toString().padStart(2,'0');
        const payload = { type: 'message', contentType: type, content: content, fileName: fileName, time: time, senderName: myName, senderIcon: myIcon };
        const conn = connections[currentChatId];
        if (conn && conn.open) {
            conn.send(payload); finalizeSend(friend, type, content, fileName, time);
        } else {
            showToast("å†æ¥ç¶šä¸­...");
            const newConn = peer.connect(currentChatId);
            setupConnection(newConn);
            newConn.on('open', () => { newConn.send(payload); showToast("é€ä¿¡ã—ã¾ã—ãŸ"); updateChatStatus(currentChatId, true); });
            finalizeSend(friend, type, content, fileName, time);
        }
    }
    function finalizeSend(friend, type, content, fileName, time) {
        friend.history.push({ type: type, content: content, fileName: fileName, time: time, isMe: true, isRead: false });
        saveFriends(); renderMessages(friend); scrollToBottom(); renderFriendList();
    }
    function sendText() { const i = document.getElementById('msg-input'); if(i.value.trim()){ sendData('text', i.value.trim()); i.value=''; } }
    function handleChatFileUpload(event) {
        const file = event.target.files[0]; if(!file) return;
        if (file.size > 500 * 1024) { alert("ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™(500KBä»¥ä¸‹)"); if(!file.type.startsWith('image/')) { event.target.value=''; return; } }
        if (file.type.startsWith('image/')) resizeImage(file, 800, (b64) => sendData('image', b64));
        else { const r = new FileReader(); r.onload=(e)=>sendData('file',e.target.result, file.name); r.readAsDataURL(file); }
        event.target.value = '';
    }

    function slideScreen(id, action) {
        const el = document.getElementById(id);
        if(action==='open') { el.classList.remove('next'); el.classList.add('active'); }
        else { el.classList.remove('active'); el.classList.add('next'); }
    }
    function openChat(id) {
        currentChatId = id;
        const friend = friends.find(f => f.id === id);
        document.getElementById('chat-title').innerText = friend.name;
        updateChatStatus(id, connections[id] && connections[id].open);
        renderMessages(friend); updateBlockUI(friend.isBlocked); slideScreen('screen-chat', 'open'); scrollToBottom();
        if(!connections[id] || !connections[id].open) connectToPeer(id);
        else sendReadSignal(id);
    }
    function updateChatStatus(id, isOnline) {
        if(currentChatId === id) {
            const el = document.getElementById('chat-status');
            el.innerText = isOnline ? "ğŸŸ¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³" : "ğŸ”´ åˆ‡æ–­ä¸­...";
            el.style.color = isOnline ? "#2ecc71" : "#ff3b30";
        }
    }
    function closeChat() { slideScreen('screen-chat', 'close'); currentChatId = null; }
    function renderMessages(friend) {
        const area = document.getElementById('msg-area'); area.innerHTML = '';
        friend.history.forEach(msg => {
            const div = document.createElement('div'); div.className = `msg ${msg.isMe?'me':'you'}`;
            let contentHtml = '';
            if (msg.type === 'image') contentHtml = `<img src="${msg.content}" class="msg-image" onclick="showImage('${msg.content}')">`;
            else if (msg.type === 'file') contentHtml = `<a href="${msg.content}" download="${msg.fileName}" class="msg-file-link">ğŸ“„ ${msg.fileName}<br>(ã‚¿ãƒƒãƒ—ã—ã¦ä¿å­˜)</a>`;
            else contentHtml = escapeHtml(msg.content);
            const readMark = (msg.isMe && msg.isRead) ? `<div class="read-mark is-read">æ—¢èª­</div>` : `<div class="read-mark"></div>`;
            div.innerHTML = `<div class="msg-meta">${readMark}<div class="msg-time">${msg.time}</div></div><div class="msg-bubble">${contentHtml}</div>`;
            area.appendChild(div);
        });
    }
    window.showImage = (src) => { const w = window.open(""); w.document.write(`<img src="${src}" style="width:100%">`); };
    function renderFriendList() {
        const list = document.getElementById('friend-list'); list.innerHTML = '';
        friends.forEach(f => {
            const div = document.createElement('div'); div.className = 'friend-item'; div.onclick = () => openChat(f.id);
            let last = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—";
            if(f.history.length > 0) {
                const l = f.history[f.history.length-1];
                if(l.type === 'image') last = 'ğŸ“· ç”»åƒ'; else if(l.type === 'file') last = 'ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«'; else last = l.content;
            }
            const i = f.icon || {type:'text'};
            let iconHtml = i.type==='image' ? `<div class="avatar" style="width:40px; height:40px; margin-right:12px; background-image:url(${i.imageData});"></div>` : `<div class="avatar" style="width:40px; height:40px; margin-right:12px; font-size:20px; background-color:${i.color||'#ccc'};">${i.char||f.name[0]}</div>`;
            div.innerHTML = `${iconHtml}<div style="flex:1; overflow:hidden;"><div style="font-weight:bold; font-size:15px;">${f.name} ${f.isBlocked?'ğŸš«':''}</div><div style="font-size:12px; color:#888; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${escapeHtml(last)}</div></div>`;
            list.appendChild(div);
        });
    }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
    function saveFriends(){ localStorage.setItem(KEY_FRIENDS, JSON.stringify(friends)); }
    function scrollToBottom(){ const a=document.getElementById('msg-area'); setTimeout(()=>a.scrollTop=a.scrollHeight, 10); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    function openChatMenu(){
        const f = friends.find(x=>x.id===currentChatId);
        document.getElementById('menu-target-name').innerText = f.name;
        document.getElementById('btn-block-toggle').innerText = f.isBlocked ? "ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤" : "ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹";
        document.getElementById('modal-menu').style.display='flex';
    }
    function toggleBlock() { const f=friends.find(x=>x.id===currentChatId); f.isBlocked=!f.isBlocked; saveFriends(); updateBlockUI(f.isBlocked); closeModal('modal-menu'); renderFriendList(); }
    function updateBlockUI(blocked) { document.getElementById('block-bar').style.display=blocked?'block':'none'; document.getElementById('input-area').style.display=blocked?'none':'flex'; }
    function deleteFriend() { if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; friends=friends.filter(x=>x.id!==currentChatId); saveFriends(); closeModal('modal-menu'); closeChat(); renderFriendList(); }
    function addFriend() { const id=document.getElementById('add-id').value.trim(), name=document.getElementById('add-name').value.trim(); if(!id||id===myId||friends.find(x=>x.id===id)) return alert("è¿½åŠ ä¸å¯"); friends.push({id, name:name||"åç„¡ã—", history:[], isBlocked:false}); saveFriends(); connectToPeer(id); closeModal('modal-add'); renderFriendList(); alert("è¿½åŠ ã—ã¾ã—ãŸ"); }
    function openMyQR(){ document.getElementById('modal-qr').style.display='flex'; }
    function openAddModal(){ document.getElementById('modal-add').style.display='flex'; document.getElementById('add-id').value=''; }
    function closeModal(id){ document.getElementById(id).style.display='none'; }
</script>
</body>
</html>
