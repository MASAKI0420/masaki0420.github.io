<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>P2Pãƒãƒ£ãƒƒãƒˆ(è¨­å®šæ©Ÿèƒ½ä»˜)</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        background-color: #fff; color: #333;
        width: 100%; height: 100dvh; overflow: hidden;
    }

    #app-root { width: 100%; height: 100%; position: relative; overflow: hidden; }

    /* ç”»é¢å…±é€š */
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f2f2f7; /* iOSé¢¨ã®è–„ã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ */
        display: flex; flex-direction: column;
        transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        z-index: 10;
        visibility: hidden; /* åˆæœŸã¯éš ã™ */
    }
    .screen.active { transform: translateX(0); visibility: visible; }
    .screen.hidden-right { transform: translateX(100%); visibility: visible; }
    .screen.hidden-left { transform: translateX(-30%); visibility: visible; } /* å°‘ã—ã ã‘æ®‹ã™æ¼”å‡º */

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
        height: 50px; background-color: #2c363f; color: white;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px; padding-top: env(safe-area-inset-top);
        box-sizing: content-box; font-weight: bold; font-size: 16px; flex-shrink: 0;
    }
    .header-btn { font-size: 24px; cursor: pointer; min-width: 40px; display:flex; justify-content:center;}

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
    .scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* =========================================
       0. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
       ========================================= */
    #screen-login {
        z-index: 100; background-color: #2c363f; color: white;
        align-items: center; justify-content: center; visibility: visible;
    }
    .login-box { width: 100%; max-width: 320px; padding: 30px; text-align: center; }
    .login-logo { font-size: 60px; margin-bottom: 20px; }
    .login-input {
        width: 100%; padding: 15px; font-size: 16px; border-radius: 8px; border: none;
        margin-bottom: 15px; text-align: center; font-weight: bold;
    }
    .start-btn {
        width: 100%; padding: 15px; background-color: #2ecc71; color: white;
        border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
    }

    /* =========================================
       1. ãƒ›ãƒ¼ãƒ ç”»é¢
       ========================================= */
    #screen-home { background-color: white; }
    
    .my-profile {
        padding: 20px 15px; display: flex; align-items: center;
        border-bottom: 10px solid #f2f2f7; cursor: pointer;
    }
    /* ã‚¢ãƒã‚¿ãƒ¼å…±é€š */
    .avatar {
        width: 56px; height: 56px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 28px; margin-right: 15px; color: #fff;
        background-color: #ccc; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
    }

    .friend-item {
        display: flex; align-items: center; padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0; cursor: pointer; background: white;
    }
    .friend-item:active { background-color: #f9f9f9; }
    .f-avatar {
        width: 44px; height: 44px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        color: white; font-size: 20px; margin-right: 12px;
    }

    .fab-btn {
        position: absolute; bottom: 30px; right: 20px; width: 56px; height: 56px;
        background-color: #2c363f; color: white; border-radius: 50%;
        display: flex; justify-content: center; align-items: center; font-size: 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 20;
    }

    /* =========================================
       2. è¨­å®šç”»é¢
       ========================================= */
    #screen-settings { background-color: #f2f2f7; z-index: 50; }
    
    .settings-group {
        background: white; margin-top: 20px; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd;
    }
    .settings-item {
        padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #eee;
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-label { flex: 1; font-weight: bold; }
    
    /* ã‚¢ã‚¤ã‚³ãƒ³ç·¨é›†ã‚¨ãƒªã‚¢ */
    .icon-edit-area {
        display: flex; flex-direction: column; align-items: center; padding: 20px; background: white; margin-top: 20px;
    }
    .color-picker { display: flex; gap: 10px; margin-top: 15px; }
    .color-dot {
        width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;
    }
    .color-dot.selected { border-color: #333; transform: scale(1.1); }
    
    .emoji-input {
        width: 60px; font-size: 30px; text-align: center; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px;
    }

    .logout-btn {
        display: block; width: 90%; margin: 30px auto; padding: 15px;
        background-color: white; color: #ff3b30; border: 1px solid #ff3b30;
        border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
    }

    /* =========================================
       3. ãƒˆãƒ¼ã‚¯ç”»é¢
       ========================================= */
    #screen-chat { background-color: #7297c8; z-index: 40; }
    .chat-bg { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
    
    .msg { display: flex; margin-bottom: 15px; max-width: 85%; }
    .msg.me { align-self: flex-end; flex-direction: row-reverse; }
    .msg.you { align-self: flex-start; }
    .msg-bubble {
        padding: 9px 12px; border-radius: 15px; font-size: 15px; line-height: 1.4; word-break: break-all;
        position: relative;
    }
    .msg.me .msg-bubble { background-color: #8de055; color: black; border-top-right-radius: 2px; }
    .msg.you .msg-bubble { background-color: white; color: black; border-top-left-radius: 2px; }
    .msg-time { font-size: 10px; color: white; margin: 0 5px; align-self: flex-end; }

    .chat-input-area {
        background: white; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom));
        display: flex; border-top: 1px solid #ddd;
    }
    #msg-input {
        flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; background: #f5f5f5; font-size: 16px; outline: none;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
        display: none; justify-content: center; align-items: center; z-index: 200; opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.show { display: flex; opacity: 1; }
    .modal-card { background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 12px; text-align: center; }
    .modal-input { width: 100%; padding: 10px; font-size: 16px; margin: 10px 0; border: 1px solid #ddd; text-align: center; }
    .btn-modal { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; cursor: pointer; }
    .btn-primary { background: #2c363f; color: white; }
    .btn-close { background: transparent; color: #666; }

</style>
</head>
<body>

<div id="app-root">

    <!-- â–  0. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="screen-login" class="screen active">
        <div class="login-box">
            <div class="login-logo">ğŸ’¬</div>
            <div style="margin-bottom:20px; font-weight:bold;">P2P Chat</div>
            <p style="font-size:12px; color:#ccc; margin-bottom:10px;">ã‚ãªãŸã®IDã‚’æ±ºã‚ã¦ãã ã•ã„</p>
            
            <input type="text" id="login-id" class="login-input" placeholder="ID (åŠè§’è‹±æ•°)">
            <input type="text" id="login-name" class="login-input" placeholder="ã‚ãªãŸã®åå‰">
            
            <p id="login-error" style="color:#ff6b6b; font-size:13px; min-height:20px;"></p>
            <button class="start-btn" id="btn-start" onclick="startApp()">åˆ©ç”¨é–‹å§‹</button>
        </div>
    </div>

    <!-- â–  1. ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-home" class="screen">
        <header class="header">
            <div>å‹ã ã¡</div>
            <div class="header-btn" onclick="openSettings()">âš™</div>
        </header>

        <div class="scroll-content">
            <!-- è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« (ã‚¯ãƒªãƒƒã‚¯ã§QR) -->
            <div class="my-profile" onclick="openMyQR()">
                <div class="avatar" id="home-my-avatar">ğŸ‘¤</div>
                <div>
                    <h2 style="font-size:16px;" id="disp-my-name">è‡ªåˆ†</h2>
                    <p style="font-size:12px; color:#888;" id="disp-my-id">ID: ---</p>
                </div>
                <div style="margin-left:auto; font-size:24px; color:#ccc;">â–’</div>
            </div>

            <div style="padding:10px 15px; font-size:12px; color:#666; background:#f9f9f9;">å‹ã ã¡ãƒªã‚¹ãƒˆ</div>
            <div id="friend-list"></div>
        </div>
        
        <div class="fab-btn" onclick="openAddModal()">ï¼‹</div>
    </div>

    <!-- â–  2. è¨­å®šç”»é¢ -->
    <div id="screen-settings" class="screen hidden-right">
        <header class="header">
            <div class="header-btn" onclick="closeSettings()">ï¼œ</div>
            <div style="flex:1; text-align:center;">è¨­å®š</div>
            <div style="width:40px;"></div>
        </header>
        
        <div class="scroll-content">
            <div class="icon-edit-area">
                <div class="avatar" id="preview-avatar" style="width:80px; height:80px; font-size:40px; margin:0 0 15px 0;">ğŸ‘¤</div>
                <div style="font-weight:bold;">ã‚¢ã‚¤ã‚³ãƒ³ç·¨é›†</div>
                <div style="font-size:12px; color:#888;">è‰²ã¨æ–‡å­—ã‚’å¤‰æ›´ã§ãã¾ã™</div>

                <div class="color-picker" id="color-picker">
                    <!-- JSã§ç”Ÿæˆ -->
                </div>
                <div style="margin-top:15px; display:flex; align-items:center; gap:10px;">
                    <span>æ–‡å­—:</span>
                    <input type="text" id="edit-icon-char" class="emoji-input" maxlength="1" value="ğŸ‘¤">
                </div>
                <button class="btn-modal btn-primary" style="width:200px; margin-top:20px;" onclick="saveIconSettings()">ä¿å­˜ã™ã‚‹</button>
            </div>

            <div class="settings-group">
                <div class="settings-item">
                    <div class="settings-label">åå‰</div>
                    <div id="settings-name-disp">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">ç¾åœ¨ã®ID</div>
                    <div id="settings-id-disp">---</div>
                </div>
            </div>

            <button class="logout-btn" onclick="logout()">IDã‚’å¤‰æ›´ (ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ)</button>
            <p style="text-align:center; font-size:11px; color:#999;">â€»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
        </div>
    </div>

    <!-- â–  3. ãƒˆãƒ¼ã‚¯ç”»é¢ -->
    <div id="screen-chat" class="screen hidden-right">
        <header class="header">
            <div class="header-btn" onclick="closeChat()">ï¼œ</div>
            <div style="flex:1; text-align:center;" id="chat-title">ç›¸æ‰‹</div>
            <div style="width:40px;"></div>
        </header>
        <div class="chat-bg" id="msg-area"></div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
            <button onclick="sendMessage()" style="margin-left:10px; border:none; background:none; color:#007bff; font-weight:bold;">é€ä¿¡</button>
        </div>
    </div>

</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: QR -->
<div id="modal-qr" class="modal-overlay">
    <div class="modal-card">
        <h3>ãƒã‚¤IDæƒ…å ±</h3>
        <img id="qr-img" src="" style="width:150px; margin:15px auto; display:block;">
        <div id="qr-id-text" style="font-size:20px; font-weight:bold; margin-bottom:10px; user-select:text;"></div>
        <button class="btn-modal btn-close" onclick="closeModal('modal-qr')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: è¿½åŠ  -->
<div id="modal-add" class="modal-overlay">
    <div class="modal-card">
        <h3>å‹ã ã¡è¿½åŠ </h3>
        <p style="font-size:12px; color:#666;">ç›¸æ‰‹ãŒæ±ºã‚ãŸIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="text" id="add-id" class="modal-input" placeholder="ç›¸æ‰‹ã®ID">
        <input type="text" id="add-name" class="modal-input" placeholder="ç›¸æ‰‹ã®åå‰">
        <button onclick="addFriend()" class="btn-modal btn-primary">è¿½åŠ </button>
        <button class="btn-modal btn-close" onclick="closeModal('modal-add')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    /* =========================================
       ãƒ‡ãƒ¼ã‚¿ç®¡ç† & è¨­å®š
       ========================================= */
    // ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
    const colors = ['#ccc', '#ef5350', '#ab47bc', '#5c6bc0', '#29b6f6', '#26a69a', '#9ccc65', '#ffca28', '#ff7043', '#8d6e63'];
    
    // çŠ¶æ…‹å¤‰æ•°
    let myId = localStorage.getItem('p2p_fixed_id');
    let myName = localStorage.getItem('p2p_fixed_name');
    let myIcon = JSON.parse(localStorage.getItem('p2p_fixed_icon')) || { color: '#ccc', char: 'ğŸ‘¤' };
    
    let peer = null;
    let friends = JSON.parse(localStorage.getItem('p2p_friends')) || [];
    let connections = {};
    let currentChatId = null;

    // åˆæœŸåŒ–ï¼šãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ›ãƒ¼ãƒ ã¸
    if (myId && myName) {
        document.getElementById('login-id').value = myId;
        document.getElementById('login-name').value = myName;
        // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
        setTimeout(startApp, 100);
    }

    /* =========================================
       ãƒ­ã‚°ã‚¤ãƒ³ & PeerJSæ¥ç¶š
       ========================================= */
    function startApp() {
        const idIn = document.getElementById('login-id').value.trim();
        const nameIn = document.getElementById('login-name').value.trim();
        const err = document.getElementById('login-error');
        const btn = document.getElementById('btn-start');

        if (!idIn.match(/^[a-zA-Z0-9_-]+$/)) return err.innerText = "IDã¯åŠè§’è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™";
        if (!nameIn) return err.innerText = "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";

        btn.disabled = true;
        btn.innerText = "æ¥ç¶šä¸­...";
        err.innerText = "";

        peer = new Peer(idIn, { debug: 1 });

        peer.on('open', (id) => {
            myId = id;
            myName = nameIn;
            
            // ä¿å­˜
            localStorage.setItem('p2p_fixed_id', myId);
            localStorage.setItem('p2p_fixed_name', myName);
            
            // UIæ›´æ–°
            updateMyProfileUI();
            
            // ç”»é¢é·ç§»
            switchScreen('screen-home');

            // å‹ã ã¡å†æ¥ç¶š
            reconnectFriends();
        });

        peer.on('error', (e) => {
            btn.disabled = false;
            btn.innerText = "åˆ©ç”¨é–‹å§‹";
            if (e.type === 'unavailable-id') err.innerText = "ãã®IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™";
            else err.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.type;
        });

        peer.on('connection', conn => setupConnection(conn));
    }

    /* =========================================
       æ©Ÿèƒ½: è¨­å®š & ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´
       ========================================= */
    
    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆç”Ÿæˆ
    const picker = document.getElementById('color-picker');
    colors.forEach(c => {
        const dot = document.createElement('div');
        dot.className = 'color-dot';
        dot.style.backgroundColor = c;
        dot.onclick = () => selectColor(c, dot);
        picker.appendChild(dot);
    });

    // è¨­å®šç”»é¢ã‚’é–‹ã
    function openSettings() {
        document.getElementById('settings-id-disp').innerText = myId;
        document.getElementById('settings-name-disp').innerText = myName;
        
        // ã‚¢ã‚¤ã‚³ãƒ³ç·¨é›†ã®åˆæœŸå€¤ã‚»ãƒƒãƒˆ
        document.getElementById('edit-icon-char').value = myIcon.char;
        updatePreview(myIcon.color, myIcon.char);
        
        document.getElementById('screen-settings').classList.remove('hidden-right');
        document.getElementById('screen-settings').classList.add('active');
    }

    function closeSettings() {
        document.getElementById('screen-settings').classList.remove('active');
        document.getElementById('screen-settings').classList.add('hidden-right');
    }

    // è‰²é¸æŠ
    function selectColor(color, el) {
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
        if(el) el.classList.add('selected');
        updatePreview(color, document.getElementById('edit-icon-char').value);
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    function updatePreview(color, char) {
        const p = document.getElementById('preview-avatar');
        p.style.backgroundColor = color;
        p.innerText = char;
        // ä¸€æ™‚ä¿å­˜ç”¨ã«å±æ€§ã«æŒãŸã›ã‚‹
        p.dataset.color = color;
    }
    
    document.getElementById('edit-icon-char').addEventListener('input', (e) => {
        const color = document.getElementById('preview-avatar').dataset.color || myIcon.color;
        updatePreview(color, e.target.value);
    });

    // ã‚¢ã‚¤ã‚³ãƒ³ä¿å­˜
    function saveIconSettings() {
        const color = document.getElementById('preview-avatar').dataset.color || myIcon.color;
        const char = document.getElementById('edit-icon-char').value || 'ğŸ‘¤';
        
        myIcon = { color, char };
        localStorage.setItem('p2p_fixed_icon', JSON.stringify(myIcon));
        
        updateMyProfileUI();
        alert("ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
    }

    // IDå¤‰æ›´ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰
    function logout() {
        if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ\næ¬¡å›åˆ©ç”¨æ™‚ã¯IDã‚’å†å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚")) {
            localStorage.removeItem('p2p_fixed_id');
            // åå‰ã‚„ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šã€å‹ã ã¡ãƒªã‚¹ãƒˆã¯æ®‹ã™ã‹ã©ã†ã‹ï¼Ÿ
            // ã“ã“ã§ã¯åˆ©ä¾¿æ€§ã®ãŸã‚ã€ŒIDã ã‘ã‚¯ãƒªã‚¢ã€ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
            location.reload();
        }
    }

    function updateMyProfileUI() {
        document.getElementById('disp-my-name').innerText = myName;
        document.getElementById('disp-my-id').innerText = "ID: " + myId;
        document.getElementById('qr-id-text').innerText = myId;
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${myId}`;
        
        // ãƒ›ãƒ¼ãƒ ã®ã‚¢ãƒã‚¿ãƒ¼æ›´æ–°
        const homeAv = document.getElementById('home-my-avatar');
        homeAv.style.backgroundColor = myIcon.color;
        homeAv.innerText = myIcon.char;
    }

    /* =========================================
       ç”»é¢é·ç§»ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«
       ========================================= */
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active', 'hidden-right', 'hidden-left');
            if(s.id !== id) s.style.display = 'none';
        });
        const target = document.getElementById(id);
        target.style.display = 'flex';
        // å°‘ã—é…å»¶ã•ã›ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
        setTimeout(() => target.classList.add('active'), 10);
    }

    function openChat(id) {
        currentChatId = id;
        const friend = friends.find(f => f.id === id);
        document.getElementById('chat-title').innerText = friend.name;
        
        // å±¥æ­´è¡¨ç¤º
        const area = document.getElementById('msg-area');
        area.innerHTML = '';
        friend.history.forEach(h => appendMsg(h.text, h.time, h.type === 'send' ? 'me' : 'you'));
        
        // ç”»é¢ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³
        const chat = document.getElementById('screen-chat');
        chat.style.display = 'flex';
        setTimeout(() => {
            chat.classList.remove('hidden-right');
            chat.classList.add('active');
        }, 10);
        
        scrollToBottom();
        
        if (!connections[id]) {
            const conn = peer.connect(id);
            setupConnection(conn);
        }
    }

    function closeChat() {
        const chat = document.getElementById('screen-chat');
        chat.classList.remove('active');
        chat.classList.add('hidden-right');
        setTimeout(() => chat.style.display = 'none', 300);
        currentChatId = null;
    }

    /* =========================================
       é€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯ (æ—¢å­˜æ©Ÿèƒ½)
       ========================================= */
    function setupConnection(conn) {
        connections[conn.peer] = conn;
        conn.on('data', data => handleReceive(conn.peer, data));
        conn.on('close', () => delete connections[conn.peer]);
    }

    function reconnectFriends() {
        friends.forEach(f => {
            if(!connections[f.id]) {
                const conn = peer.connect(f.id);
                setupConnection(conn);
            }
        });
        renderFriendList();
    }

    function handleReceive(senderId, data) {
        let friend = friends.find(f => f.id === senderId);
        if (!friend) {
            friend = { id: senderId, name: "æœªç™»éŒ²", history: [] };
            friends.push(friend);
        }
        friend.history.push({ type: 'receive', text: data.text, time: data.time });
        saveData();

        if (currentChatId === senderId) {
            appendMsg(data.text, data.time, 'you');
            scrollToBottom();
        } else {
            renderFriendList();
        }
    }

    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !currentChatId) return;
        const time = new Date().getHours().toString().padStart(2,'0') + ":" + new Date().getMinutes().toString().padStart(2,'0');

        const conn = connections[currentChatId];
        if (conn && conn.open) conn.send({ text, time });
        else {
            const newConn = peer.connect(currentChatId);
            setupConnection(newConn);
            newConn.on('open', () => newConn.send({ text, time }));
        }

        const friend = friends.find(f => f.id === currentChatId);
        friend.history.push({ type: 'send', text, time });
        saveData();

        appendMsg(text, time, 'me');
        scrollToBottom();
        input.value = '';
        renderFriendList();
    }

    function renderFriendList() {
        const list = document.getElementById('friend-list');
        list.innerHTML = '';
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.onclick = () => openChat(f.id);
            const last = f.history.length > 0 ? f.history[f.history.length-1].text : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—";
            
            div.innerHTML = `
                <div class="f-avatar" style="background-color:#a0c4ff;">${f.name[0]}</div>
                <div style="flex:1;">
                    <div style="font-weight:500;">${f.name}</div>
                    <div style="font-size:12px; color:#999; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:200px;">${last.replace(/</g,"&lt;")}</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function saveData() { localStorage.setItem('p2p_friends', JSON.stringify(friends)); }
    function appendMsg(text, time, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `<div class="msg-bubble">${text.replace(/</g,"&lt;")}</div><div class="msg-time">${time}</div>`;
        document.getElementById('msg-area').appendChild(div);
    }
    function scrollToBottom() { const a = document.getElementById('msg-area'); setTimeout(()=>a.scrollTop=a.scrollHeight,10); }

    function addFriend() {
        const id = document.getElementById('add-id').value.trim();
        const name = document.getElementById('add-name').value.trim();
        if(!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(id === myId) return alert("è‡ªåˆ†ã¯è¿½åŠ ã§ãã¾ã›ã‚“");
        if(friends.find(f=>f.id===id)) return alert("æ—¢ã«è¿½åŠ æ¸ˆã¿ã§ã™");
        friends.push({id, name:name||"åç„¡ã—", history:[]});
        saveData();
        const conn = peer.connect(id);
        setupConnection(conn);
        closeModal('modal-add');
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
        renderFriendList();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
    function openMyQR(){ const m=document.getElementById('modal-qr'); m.style.display='flex'; setTimeout(()=>m.classList.add('show'),10); }
    function openAddModal(){ const m=document.getElementById('modal-add'); m.style.display='flex'; setTimeout(()=>m.classList.add('show'),10); document.getElementById('add-id').value='';}
    function closeModal(id){ const m=document.getElementById(id); m.classList.remove('show'); setTimeout(()=>m.style.display='none',300); }

</script>
</body>
</html>
