<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<!-- ã‚¹ãƒãƒ›å‘ã‘ã«ç”»é¢ã‚µã‚¤ã‚ºã‚’å›ºå®šã—ã€ãƒãƒƒãƒï¼ˆiPhoneã®ä¸Šéƒ¨ï¼‰ã«ã‚‚å¯¾å¿œ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>P2Pãƒˆãƒ¼ã‚¯ã‚¢ãƒ—ãƒª</title>
<!-- é€šä¿¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒª PeerJS -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬è¨­å®š --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        background-color: #fff;
        color: #333;
        width: 100%;
        height: 100dvh; /* ã‚¹ãƒãƒ›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼è€ƒæ…®ã®é«˜ã• */
        overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼ˆä¸­èº«ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ï¼‰ */
    }

    /* ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’åŒ…ã‚€ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå…¨ç”»é¢ï¼‰ */
    #app-root {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    /* --- å…±é€š: ç”»é¢ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: #fff;
        transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); /* ãªã‚ã‚‰ã‹ãªã‚¹ãƒ©ã‚¤ãƒ‰ */
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
        height: 50px;
        min-height: 50px;
        background-color: #2c363f; /* LINEé¢¨ãƒ€ãƒ¼ã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼ */
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        padding-top: env(safe-area-inset-top); /* iPhoneãƒãƒƒãƒå¯¾å¿œ */
        box-sizing: content-box; /* paddingã‚’å«ã‚ãªã„é«˜ã•è¨ˆç®— */
        z-index: 10;
        font-weight: bold;
        font-size: 16px;
    }
    .header-btn { font-size: 24px; cursor: pointer; padding: 5px; }
    .header-title { flex: 1; text-align: center; }
    .header-right { width: 30px; } /* ãƒãƒ©ãƒ³ã‚¹å–ã‚Šç”¨ */

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
    .scroll-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* æ»‘ã‚‰ã‹ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        background-color: #fff;
    }

    /* =========================================
       1. å‹ã ã¡ãƒªã‚¹ãƒˆç”»é¢ (Home)
       ========================================= */
    #screen-home {
        z-index: 1; /* èƒŒé¢ */
    }

    /* è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */
    .my-profile {
        padding: 20px 15px;
        display: flex;
        align-items: center;
        border-bottom: 10px solid #f2f2f2;
        cursor: pointer;
    }
    .avatar {
        width: 56px; height: 56px;
        border-radius: 50%;
        background-color: #ddd;
        display: flex; justify-content: center; align-items: center;
        font-size: 28px; margin-right: 15px;
        flex-shrink: 0;
    }
    .profile-text h2 { font-size: 16px; margin-bottom: 4px; }
    .profile-text p { font-size: 12px; color: #888; }

    /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
    .list-header {
        padding: 10px 15px; font-size: 12px; color: #666; background: #fff;
        border-bottom: 1px solid #f0f0f0;
    }
    .friend-item {
        display: flex; align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid #f9f9f9;
        cursor: pointer;
    }
    .friend-item:active { background-color: #f0f0f0; }
    .f-avatar {
        width: 44px; height: 44px; border-radius: 50%;
        background-color: #a0c4ff; color: #fff;
        display: flex; justify-content: center; align-items: center;
        font-size: 20px; margin-right: 12px;
    }
    .f-info { flex: 1; }
    .f-name { font-size: 15px; color: #333; margin-bottom: 2px; }
    .f-msg { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    
    /* è¿½åŠ ãƒœã‚¿ãƒ³ */
    .fab-btn {
        position: absolute; bottom: 20px; right: 20px;
        width: 56px; height: 56px;
        background-color: #2c363f; color: white;
        border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 20;
    }

    /* =========================================
       2. ãƒˆãƒ¼ã‚¯ç”»é¢ (Chat)
       ========================================= */
    #screen-chat {
        background-color: #7297c8; /* LINEé¢¨èƒŒæ™¯è‰² */
        z-index: 2; /* å‰é¢ */
        transform: translateX(100%); /* åˆæœŸã¯å³ã«éš ã™ */
    }
    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ */
    #screen-chat.active { transform: translateX(0); }

    .chat-header { background-color: #2c363f; justify-content: flex-start; }
    .chat-bg { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 20px; display: flex; flex-direction: column; }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .msg { display: flex; margin-bottom: 15px; max-width: 85%; }
    .msg.me { align-self: flex-end; flex-direction: row-reverse; }
    .msg.you { align-self: flex-start; }

    .msg-bubble {
        padding: 9px 12px;
        border-radius: 15px;
        font-size: 15px;
        line-height: 1.4;
        position: relative;
        word-break: break-all;
    }
    .msg.me .msg-bubble { background-color: #8de055; color: black; border-top-right-radius: 2px; }
    .msg.you .msg-bubble { background-color: white; color: black; border-top-left-radius: 2px; }
    
    .msg-time {
        font-size: 10px; color: white; margin: 0 5px; align-self: flex-end;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .chat-input-area {
        background-color: #fff;
        padding: 10px;
        padding-bottom: max(10px, env(safe-area-inset-bottom)); /* iPhoneä¸‹éƒ¨ãƒãƒ¼å¯¾å¿œ */
        display: flex;
        align-items: center;
        border-top: 1px solid #ddd;
    }
    #msg-input {
        flex: 1;
        padding: 10px 15px;
        border-radius: 20px;
        border: 1px solid #ddd;
        background-color: #f5f5f5;
        font-size: 16px; /* 16pxä»¥ä¸Šã«ã—ãªã„ã¨iOSã§æ‹¡å¤§ã•ã‚Œã‚‹ */
        outline: none;
    }
    #send-btn {
        margin-left: 10px;
        color: #007bff;
        font-weight: bold;
        background: none; border: none; font-size: 18px;
    }

    /* =========================================
       ãƒ¢ãƒ¼ãƒ€ãƒ« (QR, è¿½åŠ )
       ========================================= */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 100;
        display: none; justify-content: center; align-items: center;
        opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.show { display: flex; opacity: 1; }
    
    .modal-card {
        background: #fff; width: 85%; max-width: 320px;
        border-radius: 12px; padding: 25px; text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-title { font-weight: bold; font-size: 18px; margin-bottom: 15px; }
    .input-field {
        width: 100%; padding: 12px; font-size: 16px; margin-bottom: 12px;
        border: 1px solid #ddd; border-radius: 8px; text-align: center;
    }
    .btn {
        width: 100%; padding: 12px; border: none; border-radius: 8px;
        font-weight: bold; font-size: 15px; cursor: pointer; margin-top: 5px;
    }
    .btn-primary { background-color: #2c363f; color: white; }
    .btn-close { background-color: transparent; color: #666; margin-top: 10px; }

</style>
</head>
<body>

<div id="app-root">

    <!-- â–  ç”»é¢1: å‹ã ã¡ãƒªã‚¹ãƒˆ (Home) -->
    <div id="screen-home" class="screen">
        <header class="header">
            <div>å‹ã ã¡</div>
            <div onclick="openSettings()">âš™</div>
        </header>

        <div class="scroll-content">
            <!-- ãƒã‚¤ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
            <div class="my-profile" onclick="openMyQR()">
                <div class="avatar">ğŸ‘¤</div>
                <div class="profile-text">
                    <h2 id="my-name-display">è‡ªåˆ†</h2>
                    <p id="my-id-display">IDæ¥ç¶šä¸­...</p>
                </div>
                <div style="margin-left:auto; font-size:24px; color:#ccc;">â–’</div>
            </div>

            <!-- å‹ã ã¡ãƒªã‚¹ãƒˆ -->
            <div class="list-header">å‹ã ã¡ (<span id="friend-count">0</span>)</div>
            <div id="friend-list">
                <!-- ã“ã“ã«å‹ã ã¡ãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            
            <!-- ç©ºã®æ™‚ã®æ¡ˆå†… -->
            <div id="empty-msg" style="padding:40px; text-align:center; color:#999; font-size:13px;">
                å³ä¸‹ã®ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰<br>å‹ã ã¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
            </div>
        </div>

        <!-- å‹ã ã¡è¿½åŠ ãƒœã‚¿ãƒ³ (FAB) -->
        <div class="fab-btn" onclick="openAddModal()">ï¼‹</div>
    </div>

    <!-- â–  ç”»é¢2: ãƒˆãƒ¼ã‚¯ç”»é¢ (Chat) -->
    <div id="screen-chat" class="screen">
        <header class="header chat-header">
            <div class="header-btn" onclick="backToHome()">ï¼œ</div>
            <div class="header-title" id="chat-title-display">ç›¸æ‰‹ã®åå‰</div>
            <div class="header-right"></div>
        </header>

        <div class="chat-bg" id="chat-messages">
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã“ã«è¿½åŠ  -->
        </div>

        <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
            <button id="send-btn" onclick="sendMessage()">é€ä¿¡</button>
        </div>
    </div>

</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: QRã‚³ãƒ¼ãƒ‰ãƒ»ãƒã‚¤ID -->
<div id="modal-qr" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-title">ãƒã‚¤QRã‚³ãƒ¼ãƒ‰</div>
        <img id="qr-img" src="" style="width:160px; height:160px; margin-bottom:15px; display:block; margin:0 auto;">
        <div style="font-size:12px; color:#888;">ã‚ãªãŸã®ID</div>
        <div id="qr-id-text" style="font-size:20px; font-weight:bold; letter-spacing:1px; margin-bottom:15px; user-select:text;">---</div>
        <button class="btn btn-close" onclick="closeModal('modal-qr')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: å‹ã ã¡è¿½åŠ  -->
<div id="modal-add" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-title">å‹ã ã¡è¿½åŠ </div>
        <p style="font-size:13px; color:#666; margin-bottom:15px;">
            ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>(QRç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™)
        </p>
        <input type="text" id="add-id-input" class="input-field" placeholder="ç›¸æ‰‹ã®ID (ä¾‹: abc12345)">
        <input type="text" id="add-name-input" class="input-field" placeholder="ç›¸æ‰‹ã®åå‰">
        <button class="btn btn-primary" onclick="addFriend()">è¿½åŠ ã™ã‚‹</button>
        <button class="btn btn-close" onclick="closeModal('modal-add')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<script>
    /* =========================================
       1. åŸºæœ¬è¨­å®šãƒ»é€šä¿¡åˆæœŸåŒ– (PeerJS)
       ========================================= */
    function generateId() { return Math.random().toString(36).substring(2, 8); }

    // è‡ªåˆ†ã®IDã¨åå‰ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆãªã‘ã‚Œã°ç”Ÿæˆï¼‰
    let myId = localStorage.getItem('p2p_chat_id');
    if (!myId) { myId = generateId(); localStorage.setItem('p2p_chat_id', myId); }
    
    let myName = localStorage.getItem('p2p_chat_name') || 'è‡ªåˆ†';
    
    // ãƒ‡ãƒ¼ã‚¿å¤‰æ•°
    let friends = JSON.parse(localStorage.getItem('p2p_chat_friends')) || [];
    let peer = null;
    let connections = {}; // { peerId: DataConnection }
    let currentChatId = null; // ä»Šé–‹ã„ã¦ã„ã‚‹ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ã®ID

    // UIåˆæœŸåŒ–
    document.getElementById('my-name-display').textContent = myName;

    // PeerJSæ¥ç¶šé–‹å§‹
    try {
        peer = new Peer(myId, { debug: 1 });
        
        peer.on('open', (id) => {
            document.getElementById('my-id-display').textContent = 'ID: ' + id;
            document.getElementById('qr-id-text').textContent = id;
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${id}`;
            // æ—¢å­˜ã®å‹ã ã¡ã«å†æ¥ç¶šã‚’è©¦ã¿ã‚‹
            reconnectFriends();
        });

        // ç›¸æ‰‹ã‹ã‚‰æ¥ç¶šã•ã‚ŒãŸæ™‚
        peer.on('connection', (conn) => {
            setupConnection(conn);
        });

        peer.on('error', (err) => console.log(err));

    } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"); }

    /* =========================================
       2. é€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯
       ========================================= */
    function setupConnection(conn) {
        connections[conn.peer] = conn;
        
        conn.on('open', () => {
            console.log("Connected to " + conn.peer);
        });
        
        conn.on('data', (data) => {
            // å—ä¿¡å‡¦ç† { text, time }
            handleReceive(conn.peer, data);
        });

        conn.on('close', () => {
            delete connections[conn.peer];
        });
    }

    function reconnectFriends() {
        friends.forEach(f => {
            if(!connections[f.id]) {
                const conn = peer.connect(f.id);
                setupConnection(conn);
            }
        });
    }

    function handleReceive(senderId, data) {
        // å‹ã ã¡ãƒªã‚¹ãƒˆã«ã„ãªã‘ã‚Œã°è‡ªå‹•è¿½åŠ ï¼ˆç°¡æ˜“ï¼‰
        let friend = friends.find(f => f.id === senderId);
        if(!friend) {
            friend = { id: senderId, name: "æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼", history: [] };
            friends.push(friend);
        }
        
        // å±¥æ­´ä¿å­˜
        friend.history.push({ type: 'receive', text: data.text, time: data.time });
        saveData();

        // ç”»é¢æ›´æ–°
        if (currentChatId === senderId) {
            appendMessage(data.text, data.time, 'you');
            scrollToBottom();
        } else {
            // ãƒªã‚¹ãƒˆç”»é¢ã®æ›´æ–°ï¼ˆæœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãªã©ï¼‰
            renderFriendList();
            // ã“ã“ã§é€šçŸ¥éŸ³ãªã©ã‚’é³´ã‚‰ã™ã¨ã‚ˆã‚Šãƒªã‚¢ãƒ«
        }
    }

    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text || !currentChatId) return;

        const time = getCurrentTime();

        // é€ä¿¡
        const conn = connections[currentChatId];
        if(conn && conn.open) {
            conn.send({ text: text, time: time });
        } else {
            // æ¥ç¶šãŒãªã„å ´åˆã€å†æ¥ç¶šã‚’è©¦ã¿ã¦é€ã‚‹ï¼ˆç›¸æ‰‹ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰å¤±æ•—ã™ã‚‹ï¼‰
            const newConn = peer.connect(currentChatId);
            setupConnection(newConn);
            newConn.on('open', () => newConn.send({ text: text, time: time }));
        }

        // ä¿å­˜ & è¡¨ç¤º
        const friend = friends.find(f => f.id === currentChatId);
        friend.history.push({ type: 'send', text: text, time: time });
        saveData();

        appendMessage(text, time, 'me');
        input.value = '';
        scrollToBottom();
        renderFriendList();
    }

    /* =========================================
       3. UIãƒ»ç”»é¢æ“ä½œ
       ========================================= */
    
    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveData() {
        localStorage.setItem('p2p_chat_friends', JSON.stringify(friends));
        renderFriendList();
    }

    // å‹ã ã¡ãƒªã‚¹ãƒˆæç”»
    function renderFriendList() {
        const list = document.getElementById('friend-list');
        list.innerHTML = '';
        
        if(friends.length > 0) document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('friend-count').textContent = friends.length;

        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.onclick = () => openChat(f.id);

            // æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            let lastMsg = "ã¾ã ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“";
            if(f.history.length > 0) {
                lastMsg = f.history[f.history.length - 1].text;
            }

            div.innerHTML = `
                <div class="f-avatar">${f.name[0]}</div>
                <div class="f-info">
                    <div class="f-name">${f.name}</div>
                    <div class="f-msg">${escapeHtml(lastMsg)}</div>
                </div>
                <div style="font-size:20px; color:#ccc;">â€º</div>
            `;
            list.appendChild(div);
        });
    }

    // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ãï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼‰
    function openChat(id) {
        currentChatId = id;
        const friend = friends.find(f => f.id === id);
        
        document.getElementById('chat-title-display').textContent = friend.name;
        const msgArea = document.getElementById('chat-messages');
        msgArea.innerHTML = '';

        // å±¥æ­´å±•é–‹
        friend.history.forEach(h => {
            appendMessage(h.text, h.time, h.type === 'send' ? 'me' : 'you');
        });

        // ç”»é¢é·ç§»
        document.getElementById('screen-chat').classList.add('active');
        scrollToBottom();
        
        // æ¥ç¶šç¢ºèª
        if(!connections[id]) {
            const conn = peer.connect(id);
            setupConnection(conn);
        }
    }

    // ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
    function backToHome() {
        document.getElementById('screen-chat').classList.remove('active');
        currentChatId = null;
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ãŸã‚ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
        document.getElementById('msg-input').blur();
    }

    // å‹ã ã¡è¿½åŠ å‡¦ç†
    function addFriend() {
        const id = document.getElementById('add-id-input').value.trim();
        const name = document.getElementById('add-name-input').value.trim() || "åç„¡ã—";
        
        if(!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(id === myId) return alert("è‡ªåˆ†ã®IDã¯è¿½åŠ ã§ãã¾ã›ã‚“");
        if(friends.find(f => f.id === id)) return alert("ã™ã§ã«è¿½åŠ æ¸ˆã¿ã§ã™");

        friends.push({ id: id, name: name, history: [] });
        saveData();
        
        // æ¥ç¶šè©¦è¡Œ
        const conn = peer.connect(id);
        setupConnection(conn);

        closeModal('modal-add');
        alert(`${name}ã•ã‚“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
    }

    /* =========================================
       4. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
       ========================================= */
    function appendMessage(text, time, type) {
        const area = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `
            <div class="msg-bubble">${escapeHtml(text)}</div>
            <div class="msg-time">${time}</div>
        `;
        area.appendChild(div);
    }

    function scrollToBottom() {
        const area = document.getElementById('chat-messages');
        // å°‘ã—é…å»¶ã•ã›ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾…ã¡
        setTimeout(() => { area.scrollTop = area.scrollHeight; }, 10);
    }

    function getCurrentTime() {
        const d = new Date();
        return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
    function openMyQR() {
        const m = document.getElementById('modal-qr');
        m.style.display = 'flex';
        setTimeout(() => m.classList.add('show'), 10);
    }
    function openAddModal() {
        const m = document.getElementById('modal-add');
        m.style.display = 'flex';
        setTimeout(() => m.classList.add('show'), 10);
        document.getElementById('add-id-input').value = '';
        document.getElementById('add-name-input').value = '';
    }
    function closeModal(id) {
        const m = document.getElementById(id);
        m.classList.remove('show');
        setTimeout(() => m.style.display = 'none', 300);
    }
    function openSettings() {
        const n = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", myName);
        if(n) {
            myName = n;
            localStorage.setItem('p2p_chat_name', n);
            document.getElementById('my-name-display').textContent = n;
        }
    }

    // åˆæœŸå®Ÿè¡Œ
    renderFriendList();

</script>
</body>
</html>
