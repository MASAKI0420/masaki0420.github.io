<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>P2Pãƒãƒ£ãƒƒãƒˆ(ãƒ–ãƒ­ãƒƒã‚¯ãƒ»å‰Šé™¤æ©Ÿèƒ½ä»˜)</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html {
        width: 100%; height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        background-color: #000; color: #333; overflow: hidden;
    }

    #app-root {
        width: 100%; height: 100%; position: relative; background: #fff;
        max-width: 600px; margin: 0 auto; /* PCã§è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚å¹…åˆ¶é™ */
    }

    /* --- ç”»é¢ç®¡ç† --- */
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f2f2f7;
        display: none; /* åŸºæœ¬éè¡¨ç¤º */
        flex-direction: column;
        z-index: 10;
    }
    .screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

    /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ç”¨ã®ã‚¯ãƒ©ã‚¹ï¼ˆè¨­å®šç”»é¢ãƒ»ãƒˆãƒ¼ã‚¯ç”»é¢ç”¨ï¼‰ */
    .screen.slide-in {
        display: flex; z-index: 20;
        animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* --- ãƒ‘ãƒ¼ãƒ„ --- */
    .header {
        height: 50px; background-color: #2c363f; color: white;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px; padding-top: env(safe-area-inset-top);
        font-weight: bold; font-size: 16px; flex-shrink: 0;
    }
    .header-btn { font-size: 24px; cursor: pointer; min-width: 40px; text-align: center; }
    
    .scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* 0. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #screen-login { background-color: #2c363f; color: white; align-items: center; justify-content: center; z-index: 100; }
    .login-box { width: 80%; text-align: center; }
    .login-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; text-align: center; }
    .start-btn { width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

    /* 1. ãƒ›ãƒ¼ãƒ ç”»é¢ */
    #screen-home { background-color: white; }
    .my-profile { padding: 20px 15px; display: flex; align-items: center; border-bottom: 10px solid #f2f2f7; cursor: pointer; }
    .avatar {
        width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-size: 24px; color: #fff; margin-right: 15px; flex-shrink: 0; background-color: #ccc;
    }
    .friend-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; background: white; }
    .friend-item:active { background: #f9f9f9; }
    .fab-btn {
        position: absolute; bottom: 30px; right: 20px; width: 56px; height: 56px;
        background: #2c363f; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer;
    }

    /* 2. ãƒˆãƒ¼ã‚¯ç”»é¢ */
    #screen-chat { background-color: #7297c8; }
    .chat-bg { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
    .msg { display: flex; margin-bottom: 15px; max-width: 85%; }
    .msg.me { align-self: flex-end; flex-direction: row-reverse; }
    .msg.you { align-self: flex-start; }
    .msg-bubble { padding: 9px 12px; border-radius: 14px; font-size: 15px; line-height: 1.4; word-break: break-all; }
    .msg.me .msg-bubble { background: #8de055; color: black; border-top-right-radius: 2px; }
    .msg.you .msg-bubble { background: white; color: black; border-top-left-radius: 2px; }
    .msg-time { font-size: 10px; color: white; margin: 0 5px; align-self: flex-end; }
    
    .chat-input-area { background: white; padding: 10px; display: flex; border-top: 1px solid #ddd; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
    #msg-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; background: #f5f5f5; font-size: 16px; }
    
    /* ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®è¡¨ç¤º */
    .blocked-bar { background: #555; color: white; text-align: center; padding: 10px; font-size: 12px; display: none; }

    /* 3. è¨­å®šç”»é¢ */
    #screen-settings { background-color: #f2f2f7; }
    .settings-section { background: white; margin-top: 20px; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; padding: 20px; text-align: center; }
    .color-picker { display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
    .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-dot.selected { border-color: #333; transform: scale(1.1); }
    .emoji-input { width: 50px; font-size: 24px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
    .logout-btn { color: #ff3b30; border: 1px solid #ff3b30; background: white; padding: 10px; border-radius: 5px; margin-top: 30px; width: 80%; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
        display: none; justify-content: center; align-items: center; z-index: 200;
    }
    .modal-card { background: white; width: 80%; max-width: 300px; padding: 20px; border-radius: 10px; text-align: center; }
    .btn-block { width: 100%; padding: 12px; border: none; margin-top: 5px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-red { background: #ff3b30; color: white; }
    .btn-gray { background: #eee; color: #333; }
    
</style>
</head>
<body>

<div id="app-root">

    <!-- â–  ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h2 style="margin-bottom:20px;">P2P Chat</h2>
            <p id="login-msg" style="font-size:12px; color:#ccc;">IDã‚’æ±ºã‚ã¦ãã ã•ã„</p>
            <input type="text" id="login-id" class="login-input" placeholder="ID (åŠè§’è‹±æ•°)">
            <input type="text" id="login-name" class="login-input" placeholder="åå‰">
            <button class="start-btn" onclick="startApp()">åˆ©ç”¨é–‹å§‹</button>
        </div>
    </div>

    <!-- â–  ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="screen-home" class="screen">
        <header class="header">
            <div>å‹ã ã¡</div>
            <div class="header-btn" onclick="openSettings()">âš™</div>
        </header>
        <div class="scroll-content">
            <div class="my-profile" onclick="openMyQR()">
                <div class="avatar" id="home-avatar">ğŸ‘¤</div>
                <div>
                    <div id="home-name" style="font-weight:bold;">è‡ªåˆ†</div>
                    <div id="home-id" style="font-size:12px; color:#888;">ID: ---</div>
                </div>
                <div style="margin-left:auto; font-size:24px; color:#ccc;">â–’</div>
            </div>
            <div style="padding:10px 15px; font-size:12px; color:#666; background:#f9f9f9;">ãƒªã‚¹ãƒˆ</div>
            <div id="friend-list"></div>
        </div>
        <div class="fab-btn" onclick="openAddModal()">ï¼‹</div>
    </div>

    <!-- â–  ãƒˆãƒ¼ã‚¯ç”»é¢ -->
    <div id="screen-chat" class="screen">
        <header class="header">
            <div class="header-btn" onclick="backToHome()">ï¼œ</div>
            <div style="flex:1; text-align:center;" id="chat-title">ç›¸æ‰‹</div>
            <div class="header-btn" onclick="openChatMenu()">â‰¡</div>
        </header>
        
        <div class="blocked-bar" id="block-bar">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã¾ã™</div>

        <div class="chat-bg" id="msg-area"></div>
        
        <div class="chat-input-area" id="input-area">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
            <button onclick="sendMessage()" style="margin-left:10px; border:none; background:none; color:#007bff; font-weight:bold; font-size:16px;">é€ä¿¡</button>
        </div>
    </div>

    <!-- â–  è¨­å®šç”»é¢ -->
    <div id="screen-settings" class="screen">
        <header class="header">
            <div class="header-btn" onclick="backToHome()">ï¼œ</div>
            <div style="flex:1; text-align:center;">è¨­å®š</div>
            <div style="width:40px;"></div>
        </header>
        <div class="scroll-content">
            <div class="settings-section">
                <div class="avatar" id="preview-avatar" style="width:70px; height:70px; font-size:35px; margin:0 auto;">ğŸ‘¤</div>
                <h3 style="margin-top:10px;">ã‚¢ã‚¤ã‚³ãƒ³ç·¨é›†</h3>
                <div class="color-picker" id="color-picker"></div>
                <div>
                    æ–‡å­—: <input type="text" id="edit-char" class="emoji-input" maxlength="1" value="ğŸ‘¤">
                </div>
                <button class="start-btn" style="margin-top:15px; width:200px;" onclick="saveIcon()">ä¿å­˜ã™ã‚‹</button>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <p>ç¾åœ¨ã®ID: <span id="settings-id" style="font-weight:bold;"></span></p>
                <button class="logout-btn" onclick="logout()">IDã‚’å¤‰æ›´ (ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ)</button>
            </div>
        </div>
    </div>

</div>

<!-- QRãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal-qr" class="modal-overlay" onclick="closeModal('modal-qr')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <h3>ãƒã‚¤ID</h3>
        <img id="qr-img" src="" style="width:150px; margin:15px auto; display:block;">
        <div id="qr-text" style="font-weight:bold; font-size:20px; user-select:text;"></div>
        <button class="btn-block btn-gray" onclick="closeModal('modal-qr')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<!-- å‹ã ã¡è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal-add" class="modal-overlay">
    <div class="modal-card">
        <h3>å‹ã ã¡è¿½åŠ </h3>
        <input type="text" id="add-id" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd;" placeholder="ç›¸æ‰‹ã®ID">
        <input type="text" id="add-name" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd;" placeholder="ç›¸æ‰‹ã®åå‰">
        <button class="btn-block" style="background:#2c363f; color:white;" onclick="addFriend()">è¿½åŠ </button>
        <button class="btn-block btn-gray" onclick="closeModal('modal-add')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<!-- ãƒˆãƒ¼ã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ–ãƒ­ãƒƒã‚¯/å‰Šé™¤ï¼‰ -->
<div id="modal-chat-menu" class="modal-overlay" onclick="closeModal('modal-chat-menu')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <h3 id="menu-target-name">è¨­å®š</h3>
        <button class="btn-block btn-gray" id="btn-toggle-block" onclick="toggleBlock()">ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹</button>
        <button class="btn-block btn-red" onclick="deleteFriend()">å‹ã ã¡å‰Šé™¤</button>
        <button class="btn-block btn-gray" style="margin-top:15px;" onclick="closeModal('modal-chat-menu')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    /* =========================================
       å¤‰æ•°ãƒ»åˆæœŸåŒ–
       ========================================= */
    const colors = ['#ccc', '#ef5350', '#ab47bc', '#5c6bc0', '#29b6f6', '#26a69a', '#9ccc65', '#ffca28', '#ff7043', '#8d6e63'];
    
    let myId = localStorage.getItem('p2p_id');
    let myName = localStorage.getItem('p2p_name');
    let myIcon = JSON.parse(localStorage.getItem('p2p_icon')) || { color: '#ccc', char: 'ğŸ‘¤' };
    let friends = JSON.parse(localStorage.getItem('p2p_friends')) || []; // {id, name, history, isBlocked}
    
    let peer = null;
    let connections = {};
    let currentChatId = null;

    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ç”Ÿæˆ
    const picker = document.getElementById('color-picker');
    colors.forEach(c => {
        const d = document.createElement('div');
        d.className = 'color-dot';
        d.style.backgroundColor = c;
        d.onclick = () => {
            document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('selected'));
            d.classList.add('selected');
            document.getElementById('preview-avatar').style.backgroundColor = c;
            document.getElementById('preview-avatar').dataset.color = c;
        };
        picker.appendChild(d);
    });
    
    // æ–‡å­—å…¥åŠ›åŒæœŸ
    document.getElementById('edit-char').addEventListener('input', (e) => {
        document.getElementById('preview-avatar').innerText = e.target.value || 'ğŸ‘¤';
    });

    // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
    if (myId && myName) {
        document.getElementById('login-id').value = myId;
        document.getElementById('login-name').value = myName;
        setTimeout(startApp, 100);
    }

    /* =========================================
       ç”»é¢é·ç§»ãƒ­ã‚¸ãƒƒã‚¯
       ========================================= */
    function showScreen(id, isSlide = false) {
        // å…¨ç”»é¢éè¡¨ç¤º
        document.querySelectorAll('.screen').forEach(el => {
            el.classList.remove('active', 'slide-in');
            el.style.display = 'none';
        });
        
        const target = document.getElementById(id);
        if (isSlide) {
            target.classList.add('slide-in');
        } else {
            target.classList.add('active');
        }
    }

    function backToHome() {
        showScreen('screen-home');
        currentChatId = null;
        document.getElementById('msg-input').blur(); // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é–‰ã˜ã‚‹
    }

    function openSettings() {
        // è¨­å®šç”»é¢ã®å€¤ã‚’æ›´æ–°
        document.getElementById('preview-avatar').style.backgroundColor = myIcon.color;
        document.getElementById('preview-avatar').innerText = myIcon.char;
        document.getElementById('preview-avatar').dataset.color = myIcon.color;
        document.getElementById('edit-char').value = myIcon.char;
        document.getElementById('settings-id').innerText = myId;
        
        showScreen('screen-settings', true);
    }

    /* =========================================
       æ©Ÿèƒ½: ã‚¢ãƒ—ãƒªé–‹å§‹ & è¨­å®šä¿å­˜
       ========================================= */
    function startApp() {
        const idVal = document.getElementById('login-id').value.trim();
        const nameVal = document.getElementById('login-name').value.trim();
        if(!idVal || !nameVal) return alert("IDã¨åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const btn = document.querySelector('.start-btn');
        btn.disabled = true;
        btn.innerText = "æ¥ç¶šä¸­...";

        peer = new Peer(idVal, { debug: 1 });

        peer.on('open', (id) => {
            myId = id; myName = nameVal;
            localStorage.setItem('p2p_id', myId);
            localStorage.setItem('p2p_name', myName);
            
            updateMyProfile();
            showScreen('screen-home');
            reconnectFriends();
            btn.disabled = false; btn.innerText = "åˆ©ç”¨é–‹å§‹";
        });
        
        peer.on('error', (e) => {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.type);
            btn.disabled = false; btn.innerText = "åˆ©ç”¨é–‹å§‹";
        });
        
        peer.on('connection', conn => setupConnection(conn));
    }

    function saveIcon() {
        const color = document.getElementById('preview-avatar').dataset.color || myIcon.color;
        const char = document.getElementById('edit-char').value || 'ğŸ‘¤';
        myIcon = { color, char };
        localStorage.setItem('p2p_icon', JSON.stringify(myIcon));
        updateMyProfile();
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
        backToHome();
    }

    function updateMyProfile() {
        const av = document.getElementById('home-avatar');
        av.style.backgroundColor = myIcon.color;
        av.innerText = myIcon.char;
        document.getElementById('home-name').innerText = myName;
        document.getElementById('home-id').innerText = "ID: " + myId;
        
        // QR
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${myId}`;
        document.getElementById('qr-text').innerText = myId;
    }

    function logout() {
        if(!confirm("IDè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
        localStorage.removeItem('p2p_id');
        location.reload();
    }

    /* =========================================
       æ©Ÿèƒ½: ãƒãƒ£ãƒƒãƒˆ & é€šä¿¡
       ========================================= */
    function setupConnection(conn) {
        connections[conn.peer] = conn;
        conn.on('data', data => handleReceive(conn.peer, data));
        conn.on('close', () => delete connections[conn.peer]);
    }

    function reconnectFriends() {
        friends.forEach(f => {
            if(!connections[f.id]) {
                const c = peer.connect(f.id);
                setupConnection(c);
            }
        });
        renderList();
    }

    function handleReceive(senderId, data) {
        let friend = friends.find(f => f.id === senderId);
        
        // ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
        if (friend && friend.isBlocked) {
            console.log("Blocked message from " + senderId);
            return; // ç„¡è¦–
        }

        if (!friend) {
            friend = { id: senderId, name: "æœªç™»éŒ²", history: [], isBlocked: false };
            friends.push(friend);
        }
        
        friend.history.push({ type: 'receive', text: data.text, time: data.time });
        saveFriends();

        if (currentChatId === senderId) {
            appendMsg(data.text, data.time, 'you');
            scrollToBottom();
        } else {
            renderList();
        }
    }

    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !currentChatId) return;

        // ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
        const friend = friends.find(f => f.id === currentChatId);
        if (friend && friend.isBlocked) return alert("ãƒ–ãƒ­ãƒƒã‚¯ä¸­ã¯é€ä¿¡ã§ãã¾ã›ã‚“");

        const time = new Date().getHours().toString().padStart(2,'0') + ":" + new Date().getMinutes().toString().padStart(2,'0');

        const conn = connections[currentChatId];
        if (conn && conn.open) conn.send({ text, time });
        else {
            const newConn = peer.connect(currentChatId);
            setupConnection(newConn);
            newConn.on('open', () => newConn.send({ text, time }));
        }

        friend.history.push({ type: 'send', text, time });
        saveFriends();

        appendMsg(text, time, 'me');
        input.value = '';
        scrollToBottom();
        renderList();
    }

    /* =========================================
       æ©Ÿèƒ½: ãƒ–ãƒ­ãƒƒã‚¯ / å‰Šé™¤ / UIæ“ä½œ
       ========================================= */
    function openChat(id) {
        currentChatId = id;
        const friend = friends.find(f => f.id === id);
        document.getElementById('chat-title').innerText = friend.name;
        document.getElementById('msg-area').innerHTML = '';
        
        // å±¥æ­´å±•é–‹
        friend.history.forEach(h => appendMsg(h.text, h.time, h.type==='send'?'me':'you'));
        
        // ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®UIæ›´æ–°
        updateBlockUI(friend.isBlocked);
        
        showScreen('screen-chat', true);
        scrollToBottom();
        
        if (!connections[id]) {
            const c = peer.connect(id);
            setupConnection(c);
        }
    }

    function openChatMenu() {
        const friend = friends.find(f => f.id === currentChatId);
        if(!friend) return;
        
        document.getElementById('menu-target-name').innerText = friend.name + " ã®è¨­å®š";
        const btn = document.getElementById('btn-toggle-block');
        btn.innerText = friend.isBlocked ? "ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹" : "ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹";
        btn.className = friend.isBlocked ? "btn-block" : "btn-block btn-gray"; // è§£é™¤ã¯å¼·èª¿
        
        document.getElementById('modal-chat-menu').style.display = 'flex';
    }

    function toggleBlock() {
        const friend = friends.find(f => f.id === currentChatId);
        if(!friend) return;
        
        friend.isBlocked = !friend.isBlocked;
        saveFriends();
        updateBlockUI(friend.isBlocked);
        closeModal('modal-chat-menu');
        
        alert(friend.isBlocked ? "ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ" : "ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ");
    }

    function updateBlockUI(isBlocked) {
        const bar = document.getElementById('block-bar');
        const inputArea = document.getElementById('input-area');
        if(isBlocked) {
            bar.style.display = 'block';
            inputArea.style.display = 'none';
        } else {
            bar.style.display = 'none';
            inputArea.style.display = 'flex';
        }
    }

    function deleteFriend() {
        if(!confirm("ã“ã®å‹ã ã¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nãƒˆãƒ¼ã‚¯å±¥æ­´ã‚‚ã™ã¹ã¦æ¶ˆãˆã¾ã™ã€‚")) return;
        
        friends = friends.filter(f => f.id !== currentChatId);
        saveFriends();
        closeModal('modal-chat-menu');
        backToHome();
    }

    /* =========================================
       ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
       ========================================= */
    function renderList() {
        const list = document.getElementById('friend-list');
        list.innerHTML = '';
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.onclick = () => openChat(f.id);
            const last = f.history.length > 0 ? f.history[f.history.length-1].text : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—";
            const blockedMark = f.isBlocked ? "ğŸš«" : "";
            
            div.innerHTML = `
                <div class="avatar" style="background:#a0c4ff; margin-right:10px;">${f.name[0]}</div>
                <div style="flex:1; overflow:hidden;">
                    <div style="font-weight:bold;">${f.name} ${blockedMark}</div>
                    <div style="font-size:12px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(last)}</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function appendMsg(text, time, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `<div class="msg-bubble">${escapeHtml(text)}</div><div class="msg-time">${time}</div>`;
        document.getElementById('msg-area').appendChild(div);
    }
    
    function addFriend() {
        const id = document.getElementById('add-id').value.trim();
        const name = document.getElementById('add-name').value.trim();
        if(!id) return alert("IDã‚’å…¥ã‚Œã¦ãã ã•ã„");
        if(id === myId) return alert("è‡ªåˆ†ã¯è¿½åŠ ã§ãã¾ã›ã‚“");
        if(friends.find(f=>f.id===id)) return alert("æ—¢ã«è¿½åŠ æ¸ˆã¿ã§ã™");
        
        friends.push({ id, name:name||"åç„¡ã—", history:[], isBlocked: false });
        saveFriends();
        
        // æ¥ç¶šè©¦è¡Œ
        const c = peer.connect(id);
        setupConnection(c);
        
        closeModal('modal-add');
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
        renderList();
    }

    function saveFriends() { localStorage.setItem('p2p_friends', JSON.stringify(friends)); }
    function scrollToBottom() { const area = document.getElementById('msg-area'); setTimeout(()=>area.scrollTop=area.scrollHeight, 10); }
    function escapeHtml(s) { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
    function openMyQR() { document.getElementById('modal-qr').style.display='flex'; }
    function openAddModal() { document.getElementById('modal-add').style.display='flex'; document.getElementById('add-id').value=''; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }

</script>
</body>
</html>
