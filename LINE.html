<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>P2Pãƒãƒ£ãƒƒãƒˆ(IDæŒ‡å®šç‰ˆ)</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        background-color: #fff; color: #333;
        width: 100%; height: 100dvh; overflow: hidden;
    }

    /* ã‚¢ãƒ—ãƒªå…¨ä½“ */
    #app-root { width: 100%; height: 100%; position: relative; overflow: hidden; }

    /* ç”»é¢å…±é€š */
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #fff; display: flex; flex-direction: column;
        transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        z-index: 10;
    }

    /* =========================================
       0. ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆIDè¨­å®šï¼‰ç”»é¢
       ========================================= */
    #screen-login {
        z-index: 50; /* æœ€å‰é¢ */
        background-color: #2c363f; /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
        color: white;
        align-items: center; justify-content: center;
        padding: 30px;
    }
    .login-logo { font-size: 60px; margin-bottom: 20px; }
    .login-title { font-size: 24px; font-weight: bold; margin-bottom: 40px; }
    
    .login-form { width: 100%; max-width: 320px; }
    .input-label { font-size: 13px; color: #ccc; margin-bottom: 5px; display: block; }
    .login-input {
        width: 100%; padding: 15px; font-size: 18px; border-radius: 8px; border: none;
        margin-bottom: 20px; text-align: center; font-weight: bold; color: #333;
    }
    .start-btn {
        width: 100%; padding: 15px; font-size: 18px; font-weight: bold;
        background-color: #2ecc71; color: white; border: none; border-radius: 8px;
        cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .start-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; }
    .error-msg { color: #ff6b6b; font-size: 14px; margin-bottom: 15px; text-align: center; min-height: 20px;}

    /* =========================================
       1. ãƒ¡ã‚¤ãƒ³ï¼ˆå‹ã ã¡ãƒªã‚¹ãƒˆï¼‰
       ========================================= */
    .header {
        height: 50px; background-color: #2c363f; color: white;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px; padding-top: env(safe-area-inset-top);
        box-sizing: content-box; font-weight: bold;
    }
    .scroll-content { flex: 1; overflow-y: auto; background-color: #fff; }

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
    .my-profile {
        padding: 20px 15px; display: flex; align-items: center; border-bottom: 10px solid #f2f2f2;
    }
    .avatar {
        width: 56px; height: 56px; border-radius: 50%; background-color: #ddd;
        display: flex; justify-content: center; align-items: center; font-size: 28px; margin-right: 15px;
    }
    
    /* ãƒªã‚¹ãƒˆ */
    .friend-item {
        display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer;
    }
    .friend-item:active { background-color: #f0f0f0; }
    .f-avatar {
        width: 44px; height: 44px; border-radius: 50%; background-color: #a0c4ff;
        display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; margin-right: 12px;
    }
    .f-info { flex: 1; }
    .f-name { font-size: 15px; font-weight: 500; }
    .f-msg { font-size: 12px; color: #999; }
    
    /* FAB */
    .fab-btn {
        position: absolute; bottom: 30px; right: 20px; width: 56px; height: 56px;
        background-color: #2c363f; color: white; border-radius: 50%;
        display: flex; justify-content: center; align-items: center; font-size: 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 20;
    }

    /* =========================================
       2. ãƒˆãƒ¼ã‚¯ç”»é¢
       ========================================= */
    #screen-chat { transform: translateX(100%); background-color: #7297c8; z-index: 20; }
    #screen-chat.active { transform: translateX(0); }

    .chat-header { background-color: #2c363f; }
    .back-btn { font-size: 24px; padding: 5px; cursor: pointer; }
    .chat-bg { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
    
    .msg { display: flex; margin-bottom: 15px; max-width: 85%; }
    .msg.me { align-self: flex-end; flex-direction: row-reverse; }
    .msg.you { align-self: flex-start; }
    .msg-bubble {
        padding: 9px 12px; border-radius: 15px; font-size: 15px; line-height: 1.4; word-break: break-all;
    }
    .msg.me .msg-bubble { background-color: #8de055; color: black; border-top-right-radius: 2px; }
    .msg.you .msg-bubble { background-color: white; color: black; border-top-left-radius: 2px; }
    .msg-time { font-size: 10px; color: white; margin: 0 5px; align-self: flex-end; }

    .chat-input-area {
        background: white; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom));
        display: flex; border-top: 1px solid #ddd;
    }
    #msg-input {
        flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; background: #f5f5f5; font-size: 16px; outline: none;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
        display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.show { display: flex; opacity: 1; }
    .modal-card { background: white; width: 85%; max-width: 320px; padding: 25px; border-radius: 12px; text-align: center; }
    .modal-input { width: 100%; padding: 10px; font-size: 16px; margin: 10px 0; border: 1px solid #ddd; text-align: center; }
    .btn-close { border: none; background: none; color: #666; margin-top: 10px; cursor: pointer; }

</style>
</head>
<body>

<div id="app-root">

    <!-- â–  ç”»é¢0: ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆIDè¨­å®šï¼‰ -->
    <div id="screen-login" class="screen">
        <div class="login-logo">ğŸ’¬</div>
        <div class="login-title">P2P Chat</div>
        
        <div class="login-form">
            <div class="error-msg" id="login-error"></div>

            <label class="input-label">ã‚ãªãŸã®ID (åŠè§’è‹±æ•°)</label>
            <input type="text" id="login-id" class="login-input" placeholder="ä¾‹: taro1234">

            <label class="input-label">è¡¨ç¤ºå</label>
            <input type="text" id="login-name" class="login-input" placeholder="ã‚ãªãŸã®åå‰">

            <button class="start-btn" id="start-btn" onclick="startApp()">åˆ©ç”¨é–‹å§‹</button>
        </div>
        <p style="margin-top:20px; font-size:12px; color:#aaa;">â€»ä¸–ç•Œã§å”¯ä¸€ã®IDã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</p>
    </div>

    <!-- â–  ç”»é¢1: ãƒ›ãƒ¼ãƒ  -->
    <div id="screen-home" class="screen">
        <header class="header">
            <div>å‹ã ã¡</div>
        </header>

        <div class="scroll-content">
            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
            <div class="my-profile" onclick="openMyQR()">
                <div class="avatar">ğŸ‘¤</div>
                <div>
                    <h2 style="font-size:16px;" id="disp-my-name">è‡ªåˆ†</h2>
                    <p style="font-size:12px; color:#888;" id="disp-my-id">ID: ---</p>
                </div>
                <div style="margin-left:auto; font-size:24px; color:#ccc;">â–’</div>
            </div>

            <!-- ãƒªã‚¹ãƒˆ -->
            <div style="padding:10px 15px; font-size:12px; color:#666; background:#f9f9f9;">å‹ã ã¡ãƒªã‚¹ãƒˆ</div>
            <div id="friend-list"></div>
        </div>
        
        <div class="fab-btn" onclick="openAddModal()">ï¼‹</div>
    </div>

    <!-- â–  ç”»é¢2: ãƒˆãƒ¼ã‚¯ -->
    <div id="screen-chat" class="screen">
        <header class="header chat-header">
            <div class="back-btn" onclick="closeChat()">ï¼œ</div>
            <div style="flex:1; text-align:center;" id="chat-title">ç›¸æ‰‹</div>
            <div style="width:30px;"></div>
        </header>
        <div class="chat-bg" id="msg-area"></div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
            <button onclick="sendMessage()" style="margin-left:10px; border:none; background:none; color:#007bff; font-weight:bold;">é€ä¿¡</button>
        </div>
    </div>

</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: QR -->
<div id="modal-qr" class="modal-overlay">
    <div class="modal-card">
        <h3>ãƒã‚¤IDæƒ…å ±</h3>
        <img id="qr-img" src="" style="width:150px; margin:15px auto; display:block;">
        <div id="qr-id-text" style="font-size:20px; font-weight:bold; margin-bottom:10px; user-select:text;"></div>
        <button class="btn-close" onclick="closeModal('modal-qr')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: è¿½åŠ  -->
<div id="modal-add" class="modal-overlay">
    <div class="modal-card">
        <h3>å‹ã ã¡è¿½åŠ </h3>
        <p style="font-size:12px; color:#666;">ç›¸æ‰‹ãŒæ±ºã‚ãŸIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="text" id="add-id" class="modal-input" placeholder="ç›¸æ‰‹ã®ID">
        <input type="text" id="add-name" class="modal-input" placeholder="ç›¸æ‰‹ã®åå‰">
        <button onclick="addFriend()" style="width:100%; padding:10px; background:#2c363f; color:white; border:none; border-radius:5px; font-weight:bold;">è¿½åŠ </button>
        <button class="btn-close" onclick="closeModal('modal-add')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    /* =========================================
       1. åˆæœŸè¨­å®šãƒ»ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
       ========================================= */
    // éå»ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
    const savedId = localStorage.getItem('p2p_fixed_id');
    const savedName = localStorage.getItem('p2p_fixed_name');

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆIDç”Ÿæˆ (ãƒ©ãƒ³ãƒ€ãƒ ã ãŒå›ºå®šç”¨ã®åˆæœŸå€¤)
    const defaultId = 'user_' + Math.floor(Math.random() * 100000);
    
    // å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
    document.getElementById('login-id').value = savedId || defaultId;
    document.getElementById('login-name').value = savedName || 'ã‚²ã‚¹ãƒˆ';

    let peer = null;
    let myId = "";
    let myName = "";
    let friends = JSON.parse(localStorage.getItem('p2p_friends')) || [];
    let connections = {};
    let currentChatId = null;

    // ã€Œåˆ©ç”¨é–‹å§‹ã€ãƒœã‚¿ãƒ³
    function startApp() {
        const idInput = document.getElementById('login-id').value.trim();
        const nameInput = document.getElementById('login-name').value.trim();
        const errorMsg = document.getElementById('login-error');
        const btn = document.getElementById('start-btn');

        if (!idInput.match(/^[a-zA-Z0-9_-]+$/)) {
            errorMsg.textContent = "IDã¯åŠè§’è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã®ã¿ã§ã™";
            return;
        }
        if (!nameInput) {
            errorMsg.textContent = "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
            return;
        }

        // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
        btn.disabled = true;
        btn.textContent = "æ¥ç¶šä¸­...";
        errorMsg.textContent = "";

        // PeerJSåˆæœŸåŒ–
        peer = new Peer(idInput, { debug: 1 });

        // æˆåŠŸæ™‚
        peer.on('open', (id) => {
            myId = id;
            myName = nameInput;
            
            // ä¿å­˜
            localStorage.setItem('p2p_fixed_id', myId);
            localStorage.setItem('p2p_fixed_name', myName);

            // ç”»é¢åæ˜ 
            document.getElementById('disp-my-name').textContent = myName;
            document.getElementById('disp-my-id').textContent = "ID: " + myId;
            document.getElementById('qr-id-text').textContent = myId;
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${myId}`;

            // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’æ¶ˆã™
            document.getElementById('screen-login').style.display = 'none';
            
            // å‹ã ã¡å†æ¥ç¶š
            reconnectFriends();
        });

        // ã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆIDé‡è¤‡ãªã©ï¼‰
        peer.on('error', (err) => {
            console.error(err);
            btn.disabled = false;
            btn.textContent = "åˆ©ç”¨é–‹å§‹";
            
            if (err.type === 'unavailable-id') {
                errorMsg.textContent = "ãã®IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®IDã«ã—ã¦ãã ã•ã„ã€‚";
            } else if (err.type === 'invalid-id') {
                errorMsg.textContent = "IDã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚";
            } else {
                errorMsg.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.type;
            }
        });

        // å—ä¿¡è¨­å®š
        peer.on('connection', (conn) => setupConnection(conn));
    }

    /* =========================================
       2. é€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯
       ========================================= */
    function setupConnection(conn) {
        connections[conn.peer] = conn;
        conn.on('data', (data) => handleReceive(conn.peer, data));
        conn.on('close', () => delete connections[conn.peer]);
    }

    function reconnectFriends() {
        friends.forEach(f => {
            if (!connections[f.id]) {
                const conn = peer.connect(f.id);
                setupConnection(conn);
            }
        });
        renderFriendList();
    }

    function handleReceive(senderId, data) {
        // æœªç™»éŒ²ãªã‚‰ä»®ç™»éŒ²
        let friend = friends.find(f => f.id === senderId);
        if (!friend) {
            friend = { id: senderId, name: "æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼", history: [] };
            friends.push(friend);
        }
        
        // å±¥æ­´è¿½åŠ 
        friend.history.push({ type: 'receive', text: data.text, time: data.time });
        saveData();

        // ç”»é¢æ›´æ–°
        if (currentChatId === senderId) {
            appendMsg(data.text, data.time, 'you');
            scrollToBottom();
        } else {
            renderFriendList();
            // ã“ã“ã§é€šçŸ¥ãªã©ã‚’å‡ºã›ã‚‹
        }
    }

    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !currentChatId) return;

        const time = getCurrentTime();

        // é€ä¿¡å‡¦ç†
        const conn = connections[currentChatId];
        if (conn && conn.open) {
            conn.send({ text: text, time: time });
        } else {
            // åˆ‡ã‚Œã¦ãŸã‚‰å†æ¥ç¶šã—ã¦é€ä¿¡ãƒˆãƒ©ã‚¤
            const newConn = peer.connect(currentChatId);
            setupConnection(newConn);
            newConn.on('open', () => newConn.send({ text: text, time: time }));
        }

        // ä¿å­˜
        const friend = friends.find(f => f.id === currentChatId);
        friend.history.push({ type: 'send', text: text, time: time });
        saveData();

        appendMsg(text, time, 'me');
        scrollToBottom();
        input.value = '';
        renderFriendList();
    }

    /* =========================================
       3. UIå‡¦ç†
       ========================================= */
    function saveData() {
        localStorage.setItem('p2p_friends', JSON.stringify(friends));
        renderFriendList();
    }

    function renderFriendList() {
        const list = document.getElementById('friend-list');
        list.innerHTML = '';
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.onclick = () => openChat(f.id);
            
            const last = f.history.length > 0 ? f.history[f.history.length-1].text : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—";
            
            div.innerHTML = `
                <div class="f-avatar">${f.name[0]}</div>
                <div class="f-info">
                    <div class="f-name">${f.name}</div>
                    <div class="f-msg">${escapeHtml(last)}</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function openChat(id) {
        currentChatId = id;
        const friend = friends.find(f => f.id === id);
        document.getElementById('chat-title').textContent = friend.name;
        
        const area = document.getElementById('msg-area');
        area.innerHTML = '';
        friend.history.forEach(h => {
            appendMsg(h.text, h.time, h.type === 'send' ? 'me' : 'you');
        });

        document.getElementById('screen-chat').classList.add('active');
        scrollToBottom();
        
        // æ¥ç¶šç¢ºèª
        if (!connections[id]) {
            const conn = peer.connect(id);
            setupConnection(conn);
        }
    }

    function closeChat() {
        document.getElementById('screen-chat').classList.remove('active');
        currentChatId = null;
        document.getElementById('msg-input').blur();
    }

    function addFriend() {
        const id = document.getElementById('add-id').value.trim();
        const name = document.getElementById('add-name').value.trim();
        if (!id) return alert("IDã‚’å…¥ã‚Œã¦ãã ã•ã„");
        if (id === myId) return alert("è‡ªåˆ†ã¯è¿½åŠ ã§ãã¾ã›ã‚“");
        if (friends.find(f => f.id === id)) return alert("æ—¢ã«è¿½åŠ æ¸ˆã¿ã§ã™");

        friends.push({ id: id, name: name || "åç„¡ã—", history: [] });
        saveData();
        
        // æ¥ç¶š
        const conn = peer.connect(id);
        setupConnection(conn);

        closeModal('modal-add');
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
    }

    // ãƒ„ãƒ¼ãƒ«é–¢æ•°
    function appendMsg(text, time, type) {
        const area = document.getElementById('msg-area');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `<div class="msg-bubble">${escapeHtml(text)}</div><div class="msg-time">${time}</div>`;
        area.appendChild(div);
    }
    function scrollToBottom() {
        const area = document.getElementById('msg-area');
        setTimeout(() => area.scrollTop = area.scrollHeight, 10);
    }
    function getCurrentTime() {
        const d = new Date();
        return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    function openMyQR() {
        document.getElementById('modal-qr').style.display = 'flex';
        setTimeout(()=>document.getElementById('modal-qr').classList.add('show'), 10);
    }
    function openAddModal() {
        document.getElementById('modal-add').style.display = 'flex';
        setTimeout(()=>document.getElementById('modal-add').classList.add('show'), 10);
        document.getElementById('add-id').value = '';
    }
    function closeModal(id) {
        const m = document.getElementById(id);
        m.classList.remove('show');
        setTimeout(()=>m.style.display='none', 300);
    }
</script>
</body>
</html>
