<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>P2P Chat (ã‚µãƒ¼ãƒãƒ¼ä¸è¦ç‰ˆ)</title>

<!-- ã‚¢ãƒ—ãƒªåŒ–è¨­å®š -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2c363f">
<!-- Androidç”¨ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š -->
<link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22Chat%22%2C%22short_name%22%3A%22Chat%22%2C%22display%22%3A%22standalone%22%2C%22start_url%22%3A%22.%22%2C%22theme_color%22%3A%22%232c363f%22%2C%22background_color%22%3A%22%23ffffff%22%7D">

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #000; color: #333; overflow: hidden; }
    #app-root { width: 100%; height: 100%; position: relative; background: #fff; max-width: 600px; margin: 0 auto; }

    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #f2f2f7; display: none; flex-direction: column; z-index: 10; transition: transform 0.3s ease-in-out; }
    .screen.active { display: flex; transform: translateX(0); }
    .screen.next { display: flex; transform: translateX(100%); z-index: 20; }
    #screen-login { z-index: 100; background-color: #2c363f; color: white; align-items: center; justify-content: center; }

    /* å…±é€šãƒ‘ãƒ¼ãƒ„ */
    .header { height: 50px; background-color: #2c363f; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; padding-top: env(safe-area-inset-top); font-weight: bold; font-size: 16px; flex-shrink: 0; }
    .header-btn { font-size: 24px; cursor: pointer; min-width: 40px; text-align: center; }
    .scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .btn { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 12px; width: 100%; font-size: 15px; margin-bottom: 10px; }
    .btn-green { background: #2ecc71; color: white; }
    .btn-gray { background: #eee; color: #333; }
    .btn-dark { background: #2c363f; color: white; }
    .btn-blue { background: #007bff; color: white; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ */
    .login-box { width: 80%; text-align: center; }
    .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; text-align: center; font-weight:bold; }

    /* ãƒ›ãƒ¼ãƒ ãƒ»ãƒªã‚¹ãƒˆ */
    #screen-home { background-color: white; }
    .my-profile { padding: 20px 15px; display: flex; align-items: center; border-bottom: 10px solid #f2f2f7; cursor: pointer; }
    .friend-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; background: white; cursor: pointer; }
    .avatar { width: 54px; height: 54px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 26px; color: #fff; margin-right: 15px; flex-shrink: 0; background-color: #ccc; background-size: cover; background-position: center; border: 1px solid rgba(0,0,0,0.1); }

    /* ãƒˆãƒ¼ã‚¯ */
    #screen-chat { background-color: #7297c8; }
    .chat-bg { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
    .msg { display: flex; margin-bottom: 15px; max-width: 85%; align-items: flex-end; }
    .msg.me { align-self: flex-end; flex-direction: row-reverse; }
    .msg.you { align-self: flex-start; }
    .msg-bubble { padding: 9px 12px; border-radius: 14px; font-size: 15px; line-height: 1.4; word-break: break-all; position: relative; max-width: 100%; background: white; }
    .msg.me .msg-bubble { background: #8de055; color: black; border-top-right-radius: 2px; }
    .msg.you .msg-bubble { background: white; color: black; border-top-left-radius: 2px; }
    .msg-meta { display: flex; flex-direction: column; align-items: flex-end; margin: 0 5px; }
    .msg-time { font-size: 10px; color: white; }
    .chat-input-area { background: white; padding: 10px; display: flex; align-items: center; border-top: 1px solid #ddd; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
    #msg-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; background: #f5f5f5; font-size: 16px; outline: none; }

    /* æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« (LINEé¢¨) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: none; flex-direction: column; z-index: 200; }
    .modal-header { display: flex; align-items: center; padding: 15px; color: white; }
    .search-container { padding: 20px; }
    .search-input-wrap { background: #333; border-radius: 8px; display: flex; align-items: center; padding: 0 10px; }
    .search-input { background: transparent; border: none; color: white; padding: 12px 0; width: 100%; font-size: 16px; outline: none; }
    
    #search-result-area { flex: 1; display: none; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 100px; }
    .result-avatar { width: 100px; height: 100px; border-radius: 50%; background-color: #555; background-size: cover; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; font-size: 40px; color: #aaa; }
    .result-name { color: white; font-size: 20px; font-weight: bold; margin-bottom: 30px; }
    .btn-add-friend { background: transparent; border: 1px solid #444; color: white; padding: 8px 30px; border-radius: 20px; cursor: pointer; display:flex; align-items:center; gap:5px; font-size:14px; }
    .btn-add-friend:active { background: #333; }
    #search-msg { color: #888; text-align: center; margin-top: 50px; font-size: 14px; display: none; }

    /* è¨­å®šãƒ»ãã®ä»– */
    .settings-card { background: white; margin: 20px; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    #file-input { display: none; }
    .fab-btn { position: absolute; bottom: 30px; right: 20px; width: 56px; height: 56px; background: #2c363f; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 50; }
    #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; z-index: 300; display: none; }
</style>
</head>
<body>

<div id="toast">é€šçŸ¥</div>

<div id="app-root">
    <!-- 0. ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="screen-login" class="screen">
        <div class="login-box">
            <h1 style="color:white; margin-bottom:20px;">P2P Chat</h1>
            <p style="color:#ccc; font-size:13px;">IDã‚’æ±ºã‚ã¦ãã ã•ã„</p>
            <input type="text" id="login-id" class="login-input" placeholder="ID (ä¾‹: taro)">
            <p style="color:#ccc; font-size:13px;">åå‰</p>
            <input type="text" id="login-name" class="login-input" placeholder="åå‰">
            <button class="btn btn-green" onclick="manualLogin()">åˆ©ç”¨é–‹å§‹</button>
        </div>
    </div>

    <!-- 1. ãƒ›ãƒ¼ãƒ  -->
    <div id="screen-home" class="screen">
        <header class="header">
            <div>å‹ã ã¡</div>
            <div class="header-btn" onclick="openSettings()">âš™</div>
        </header>
        <div class="scroll-content">
            <div class="my-profile" onclick="openSettings()">
                <div class="avatar" id="home-avatar">ğŸ‘¤</div>
                <div>
                    <div id="home-name" style="font-weight:bold;">è‡ªåˆ†</div>
                    <div id="home-id" style="font-size:12px; color:#888;">ID: ---</div>
                </div>
            </div>
            <div style="padding:10px 15px; font-size:12px; color:#666; background:#f9f9f9;">å‹ã ã¡ãƒªã‚¹ãƒˆ</div>
            <div id="friend-list"></div>
        </div>
        <div class="fab-btn" onclick="openSearch()">ï¼‹</div>
    </div>

    <!-- 2. è¨­å®š -->
    <div id="screen-settings" class="screen next">
        <header class="header"><div class="header-btn" onclick="closeSettings()">ï¼œ</div><div>è¨­å®š</div><div></div></header>
        <div class="scroll-content">
            <div class="settings-card">
                <div class="avatar" id="setting-avatar" style="width:80px; height:80px; margin:0 auto; font-size:40px;">ğŸ‘¤</div>
                <p style="margin-top:20px; font-size:12px; color:#666;">åå‰ã®å¤‰æ›´</p>
                <input type="text" id="setting-name-input" class="login-input" style="border:1px solid #ddd; margin-bottom:10px;">
                <button class="btn btn-blue" onclick="document.getElementById('file-input').click()">ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’å¤‰æ›´</button>
                <input type="file" id="file-input" accept="image/*" onchange="uploadIcon(event)">
                <button class="btn btn-dark" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
            </div>
            <div style="padding:20px;">
                <button class="btn btn-gray" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ (IDå¤‰æ›´)</button>
            </div>
        </div>
    </div>

    <!-- 3. ãƒˆãƒ¼ã‚¯ -->
    <div id="screen-chat" class="screen next">
        <header class="header">
            <div class="header-btn" onclick="closeChat()">ï¼œ</div>
            <div id="chat-title">ç›¸æ‰‹</div>
            <div style="width:40px;"></div>
        </header>
        <div class="chat-bg" id="msg-area"></div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
            <button onclick="sendMessage()" style="margin-left:10px; border:none; background:none; color:#007bff; font-weight:bold; font-size:16px;">é€ä¿¡</button>
        </div>
    </div>
</div>

<!-- æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal-search" class="modal-overlay">
    <div class="modal-header">
        <div class="header-btn" onclick="closeSearch()">ï¼œ</div>
        <div style="font-weight:bold;">å‹ã ã¡æ¤œç´¢</div>
    </div>
    <div class="search-container">
        <div class="search-input-wrap">
            <span style="color:#888;">ğŸ”</span>
            <input type="text" id="search-input" class="search-input" placeholder="IDå…¥åŠ›">
        </div>
    </div>
    <div id="search-msg">IDã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</div>
    
    <div id="search-result-area">
        <div class="result-avatar" id="result-avatar"></div>
        <div class="result-name" id="result-name">User</div>
        <!-- æ¤œç´¢çµæœã®çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã©ï¼‰ -->
        <div id="result-status" style="font-size:12px; color:#aaa; margin-bottom:15px;"></div>
        <button class="btn-add-friend" onclick="addFoundFriend()">ï¼‹ è¿½åŠ </button>
    </div>
</div>

<script>
    /* =========================================
       ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
       ========================================= */
    const KEY_ID='p2p_no_server_id', KEY_NAME='p2p_no_server_name', KEY_ICON='p2p_no_server_icon', KEY_FRIENDS='p2p_no_server_friends';
    
    let myId = localStorage.getItem(KEY_ID);
    let myName = localStorage.getItem(KEY_NAME);
    let myIcon = localStorage.getItem(KEY_ICON) || null; // Base64 image
    let friends = JSON.parse(localStorage.getItem(KEY_FRIENDS)) || [];
    // friend object: { id, name, icon, history: [], lastSeen: timestamp }

    let peer = null;
    let connections = {};
    let currentChatId = null;
    let searchResultUser = null; // { id, name, icon, isOnline }

    // èµ·å‹•æ™‚
    if (myId && myName) {
        document.getElementById('screen-home').classList.add('active'); 
        updateHomeProfile();
        renderFriendList();
        initPeer(myId);
    } else {
        document.getElementById('screen-login').classList.add('active'); 
    }

    /* =========================================
       ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ¥ç¶š (P2P)
       ========================================= */
    function manualLogin() {
        const id = document.getElementById('login-id').value.trim();
        const name = document.getElementById('login-name').value.trim();
        if(!id || !name) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        initPeer(id, (success) => {
            if(success) {
                myId = id; myName = name;
                localStorage.setItem(KEY_ID, myId);
                localStorage.setItem(KEY_NAME, myName);
                updateHomeProfile();
                document.getElementById('screen-login').classList.remove('active');
                document.getElementById('screen-home').classList.add('active');
            }
        });
    }

    function initPeer(id, callback) {
        if(peer && !peer.destroyed) return;
        peer = new Peer(id, { debug: 1 });

        peer.on('open', (newId) => {
            myId = newId;
            updateHomeProfile();
            reconnectFriends(); // å‹é”å…¨å“¡ã«å†æ¥ç¶šã—ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«äº¤æ›ã‚’è©¦ã¿ã‚‹
            if(callback) callback(true);
        });

        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') {
                // IDé‡è¤‡æ™‚ã¯å†è©¦è¡Œï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
                if(callback) { alert("IDãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™"); callback(false); }
                else { setTimeout(() => { if(peer) peer.destroy(); peer=null; initPeer(id); }, 2000); }
            }
        });

        peer.on('connection', conn => setupConnection(conn));
    }

    function setupConnection(conn) {
        connections[conn.peer] = conn;
        conn.on('open', () => {
            // æ¥ç¶šã§ããŸã‚‰è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é€ã‚‹ï¼ˆåŒæœŸï¼‰
            conn.send({ type: 'profile_update', name: myName, icon: myIcon });
        });
        conn.on('data', data => handleReceive(conn.peer, data));
        conn.on('close', () => delete connections[conn.peer]);
    }

    function reconnectFriends() {
        friends.forEach(f => {
            if(!connections[f.id] || !connections[f.id].open) {
                const c = peer.connect(f.id);
                setupConnection(c);
            }
        });
    }

    function handleReceive(senderId, data) {
        let friend = friends.find(f => f.id === senderId);
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ä¿¡å·
        if (data.type === 'profile_update') {
            if (!friend) {
                // æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰ç™»éŒ²ï¼ˆæ¤œç´¢ã§ãƒ’ãƒƒãƒˆã—ãŸæ™‚ãªã©ï¼‰
                friend = { id: senderId, name: data.name, icon: data.icon, history: [] };
                friends.push(friend);
            } else {
                // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰æ›´æ–°
                friend.name = data.name;
                friend.icon = data.icon;
            }
            saveFriends();
            renderFriendList();
            // æ¤œç´¢ä¸­ãªã‚‰çµæœç”»é¢ã‚‚æ›´æ–°
            if(document.getElementById('modal-search').style.display === 'flex' && searchResultUser && searchResultUser.id === senderId) {
                updateSearchResultUI({ id: senderId, name: data.name, icon: data.icon, isOnline: true });
            }
            return;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        if (!friend) {
            friend = { id: senderId, name: data.name || senderId, icon: null, history: [] };
            friends.push(friend);
        }
        const time = new Date().getHours().toString().padStart(2,'0') + ":" + new Date().getMinutes().toString().padStart(2,'0');
        friend.history.push({ text: data.text, isMe: false, time: time });
        saveFriends();
        
        if (currentChatId === senderId) {
            renderMessages(friend);
            scrollToBottom();
        } else {
            showToast("æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸");
            renderFriendList();
        }
    }

    /* =========================================
       æ¤œç´¢æ©Ÿèƒ½ (ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œç‰ˆ)
       ========================================= */
    const searchInp = document.getElementById('search-input');
    searchInp.addEventListener('keypress', (e) => { if(e.key === 'Enter') executeSearch(); });

    function executeSearch() {
        const targetId = searchInp.value.trim();
        const resArea = document.getElementById('search-result-area');
        const msg = document.getElementById('search-msg');
        
        if(!targetId) return;
        if(targetId === myId) { alert("è‡ªåˆ†ã®IDã§ã™"); return; }

        msg.style.display = 'block';
        msg.innerText = "æ¤œç´¢ä¸­...";
        resArea.style.display = 'none';

        // ã¾ãšä»®ã®ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºæº–å‚™ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‰æï¼‰
        searchResultUser = { id: targetId, name: targetId, icon: null, isOnline: false };

        // æ¥ç¶šã‚’è©¦ã¿ã‚‹
        const conn = peer.connect(targetId);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š (2ç§’ä»¥å†…ã«ç¹‹ãŒã‚‰ãªã‘ã‚Œã°ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¨ã¿ãªã™)
        let connected = false;
        setTimeout(() => {
            if (!connected) {
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¨ã—ã¦è¡¨ç¤º
                updateSearchResultUI(searchResultUser);
                msg.style.display = 'none';
                resArea.style.display = 'flex';
            }
        }, 2000);

        conn.on('open', () => {
            connected = true;
            setupConnection(conn);
            // æ¥ç¶šã§ããŸã‚‰ç›¸æ‰‹ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é€ã£ã¦ãã‚‹ã¯ãšï¼ˆon('data')ã§å‡¦ç†ã•ã‚Œã‚‹ï¼‰
            // ã“ã“ã§ã¯ã¨ã‚Šã‚ãˆãšã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã«ã™ã‚‹
            searchResultUser.isOnline = true;
            // åå‰ãªã©ã¯å—ä¿¡å¾…ã¡ã ãŒã€ã¨ã‚Šã‚ãˆãšè¡¨ç¤º
            updateSearchResultUI(searchResultUser);
            msg.style.display = 'none';
            resArea.style.display = 'flex';
        });
        
        conn.on('error', () => {
            // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ‰±ã„ã¨ã—ã¦è¡¨ç¤º
            updateSearchResultUI(searchResultUser);
            msg.style.display = 'none';
            resArea.style.display = 'flex';
        });
    }

    function updateSearchResultUI(user) {
        searchResultUser = user; // æœ€æ–°çŠ¶æ…‹ã«æ›´æ–°
        
        document.getElementById('result-name').innerText = user.name;
        const av = document.getElementById('result-avatar');
        
        if (user.icon) {
            av.style.backgroundImage = `url(${user.icon})`;
            av.innerText = "";
        } else {
            av.style.backgroundImage = "none";
            av.innerText = "ğŸ‘¤";
        }

        const statusEl = document.getElementById('result-status');
        if (user.isOnline) {
            statusEl.innerText = ""; // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãªã‚‰ä½•ã‚‚å‡ºã•ãªã„ï¼ˆæ™®é€šã®è¡¨ç¤ºï¼‰
            statusEl.style.color = "#2ecc71";
        } else {
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®è¡¨ç¤º
            statusEl.innerText = "â€»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€ã¾ãŸã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nè¿½åŠ ã™ã‚‹ã¨ã€æ¬¡å›æ¥ç¶šæ™‚ã«ã‚¢ã‚¤ã‚³ãƒ³ã¨åå‰ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚";
            statusEl.style.color = "#aaa";
        }
    }

    function addFoundFriend() {
        if(!searchResultUser) return;
        if(friends.find(f => f.id === searchResultUser.id)) {
            alert("æ—¢ã«å‹ã ã¡ã§ã™"); return;
        }
        
        // å‹é”ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰ä»®ã®å§¿ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãªã‚‰æœ¬ç‰©ã®å§¿ï¼‰
        friends.push({ 
            id: searchResultUser.id, 
            name: searchResultUser.name, 
            icon: searchResultUser.icon, 
            history: [] 
        });
        saveFriends();
        
        // æ¥ç¶šç¶­æŒã‚’è©¦ã¿ã‚‹
        if(!connections[searchResultUser.id]) {
            const c = peer.connect(searchResultUser.id);
            setupConnection(c);
        }

        renderFriendList();
        closeSearch();
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
    }

    /* =========================================
       UIãƒ»ãã®ä»–
       ========================================= */
    function renderFriendList() {
        const list = document.getElementById('friend-list'); list.innerHTML = "";
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.onclick = () => openChat(f.id);
            const style = f.icon ? `background-image:url(${f.icon});` : "";
            const char = f.icon ? "" : "ğŸ‘¤";
            div.innerHTML = `<div class="avatar" style="${style}">${char}</div><div style="font-weight:bold;">${f.name}</div>`;
            list.appendChild(div);
        });
    }

    function openChat(fid) {
        const f = friends.find(x => x.id === fid);
        if(!f) return;
        currentChatId = fid;
        document.getElementById('chat-title').innerText = f.name;
        renderMessages(f);
        document.getElementById('screen-chat').classList.remove('next');
        document.getElementById('screen-chat').classList.add('active');
        // æ¥ç¶šç¢ºèª
        if(!connections[fid] || !connections[fid].open) {
            const c = peer.connect(fid); setupConnection(c);
        }
    }

    function sendMessage() {
        const inp = document.getElementById('msg-input');
        const text = inp.value.trim();
        if(!text) return;
        const f = friends.find(x => x.id === currentChatId);
        if(!f) return;

        const time = new Date().getHours().toString().padStart(2,'0') + ":" + new Date().getMinutes().toString().padStart(2,'0');
        f.history.push({ text: text, isMe: true, time: time });
        saveFriends();
        renderMessages(f);
        inp.value = "";

        const conn = connections[currentChatId];
        if(conn && conn.open) {
            // åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚‚ä¸€ç·’ã«é€ã£ã¦ã‚ã’ã‚‹ï¼ˆç›¸æ‰‹å´ã®æ›´æ–°ã®ãŸã‚ï¼‰
            conn.send({ text: text, name: myName, icon: myIcon });
        } else {
            // å†æ¥ç¶šã—ã¦é€ã‚‹
            const c = peer.connect(currentChatId);
            setupConnection(c);
            c.on('open', () => c.send({ text: text, name: myName, icon: myIcon }));
        }
    }

    function renderMessages(f) {
        const area = document.getElementById('msg-area'); area.innerHTML = "";
        f.history.forEach(m => {
            const div = document.createElement('div');
            div.className = `msg ${m.isMe ? 'me' : 'you'}`;
            div.innerHTML = `<div class="msg-meta"><div class="msg-time">${m.time}</div></div><div class="msg-bubble">${m.text}</div>`;
            area.appendChild(div);
        });
        scrollToBottom();
    }

    // è¨­å®šãƒ»ä¿å­˜
    function saveProfile() {
        const name = document.getElementById('setting-name-input').value.trim();
        if(!name) return alert("åå‰ã‚’å…¥åŠ›");
        myName = name;
        localStorage.setItem(KEY_NAME, myName);
        localStorage.setItem(KEY_ICON, myIcon); // ç”»åƒãƒ‡ãƒ¼ã‚¿
        updateHomeProfile();
        // å‹é”å…¨å“¡ã«æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é€šçŸ¥
        friends.forEach(f => {
            const c = connections[f.id];
            if(c && c.open) c.send({ type: 'profile_update', name: myName, icon: myIcon });
        });
        closeSettings();
        showToast("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function uploadIcon(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            // ç°¡æ˜“ãƒªã‚µã‚¤ã‚º (ãƒ‡ãƒ¼ã‚¿é‡å‰Šæ¸›ã®ãŸã‚å¿…é ˆ)
            const img = new Image();
            img.src = evt.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                const SIZE = 150;
                let w = img.width, h = img.height;
                if(w>h) { if(w>SIZE){ h*=SIZE/w; w=SIZE; } } else { if(h>SIZE){ w*=SIZE/h; h=SIZE; } }
                cvs.width = w; cvs.height = h;
                ctx.drawImage(img,0,0,w,h);
                myIcon = cvs.toDataURL('image/jpeg', 0.8);
                updateHomeProfile();
            }
        };
        reader.readAsDataURL(file);
    }

    function updateHomeProfile() {
        document.getElementById('home-name').innerText = myName;
        document.getElementById('home-id').innerText = "ID: " + myId;
        document.getElementById('setting-name-input').value = myName;
        if(myIcon) {
            const url = `url(${myIcon})`;
            document.getElementById('home-avatar').style.backgroundImage = url;
            document.getElementById('home-avatar').innerText = "";
            document.getElementById('setting-avatar').style.backgroundImage = url;
            document.getElementById('setting-avatar').innerText = "";
        }
    }

    // æ±ç”¨
    function scrollToBottom() { const a=document.getElementById('msg-area'); a.scrollTop = a.scrollHeight; }
    function saveFriends() { localStorage.setItem(KEY_FRIENDS, JSON.stringify(friends)); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
    function openSearch(){ document.getElementById('modal-search').style.display='flex'; }
    function closeSearch(){ document.getElementById('modal-search').style.display='none'; document.getElementById('search-input').value=''; document.getElementById('search-result-area').style.display='none'; document.getElementById('search-msg').style.display='block'; }
    function closeChat(){ document.getElementById('screen-chat').classList.remove('active'); document.getElementById('screen-chat').classList.add('next'); }
    function openSettings(){ document.getElementById('screen-settings').classList.add('active'); document.getElementById('screen-settings').classList.remove('next'); }
    function closeSettings(){ document.getElementById('screen-settings').classList.remove('active'); document.getElementById('screen-settings').classList.add('next'); }
    function logout(){ if(confirm("åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")){ localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
